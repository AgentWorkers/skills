# å†ä¹Ÿä¸è¦é‡åˆ°429é”™è¯¯äº†

ä½ è‚¯å®šé‡åˆ°è¿‡è¿™ç§æƒ…å†µï¼šä½ çš„ä»£ç†æ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼ˆæ¯”å¦‚æµè§ˆç½‘é¡µã€åˆ›å»ºå­ä»£ç†ã€å‘é€é‚®ä»¶ï¼‰ï¼Œçªç„¶é—´ï¼š

```
rate_limit_error: You've exceeded your account's rate limit
```

ä¸€åˆ‡éƒ½åœæ­¢äº†ã€‚è¯·æ±‚è¢«æµªè´¹äº†ï¼Œä¸Šä¸‹æ–‡ä¿¡æ¯ä¹Ÿä¸¢å¤±äº†ã€‚ä½ åªèƒ½æ‰‹åŠ¨é‡å¯ä»£ç†ï¼Œç„¶å10åˆ†é’Ÿåå†æ¬¡å°è¯•ã€‚

**è¿™ä¸ªå·¥å…·å¯ä»¥é¿å…è¿™ç§æƒ…å†µã€‚**å®ƒä¼šåœ¨ä¸€ä¸ªæ»šåŠ¨çš„æ—¶é—´çª—å£å†…ç›‘æ§ä»£ç†çš„è¯·æ±‚é¢‘ç‡ï¼Œå¹¶æ ¹æ®è¯·æ±‚é¢‘ç‡ä¸ºä»£ç†åˆ†é…ä¸åŒçš„ç­‰çº§ï¼ˆæ­£å¸¸ã€è°¨æ…ã€é™åˆ¶ä½¿ç”¨ã€ä¸¥é‡ã€æš‚åœï¼‰ã€‚å½“ä»£ç†çš„è¯·æ±‚é¢‘ç‡æ¥è¿‘ä¸Šé™æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨é™ä½è¯·æ±‚é¢‘ç‡ã€‚å¦‚æœçœŸçš„é‡åˆ°äº†429é”™è¯¯ï¼ˆå³è¯·æ±‚è¢«æ‹’ç»ï¼‰ï¼Œè¯¥å·¥å…·ä¼šè®¡ç®—å‡ºåˆé€‚çš„å»¶è¿Ÿæ—¶é—´ï¼Œå¹¶å®‰æ’ä»£ç†è‡ªè¡Œæ¢å¤ã€‚

**æ— éœ€ä»»ä½•APIå¯†é’¥ã€PythonåŒ…å®‰è£…æˆ–å¤–éƒ¨æœåŠ¡**ï¼Œåªéœ€è¦ä¸€ä¸ªPythonè„šæœ¬å’Œä¸€ä¸ªJSONæ ¼å¼çš„çŠ¶æ€æ–‡ä»¶å³å¯ã€‚

è¿™ä¸ªå·¥å…·ç”±[The Agent Wire](https://theagentwire.ai)å¼€å‘â€”â€”ä»–ä»¬æ˜¯ä¸€ä¸ªä¸“æ³¨äºAIä»£ç†çš„å›¢é˜Ÿï¼Œè¿˜ä¼šå‘å¸ƒç›¸å…³çš„æ–°é—»é€šè®¯ã€‚

---

## 2åˆ†é’Ÿå¿«é€Ÿå…¥é—¨

ä½¿ç”¨Claude Max 5xçš„é»˜è®¤è®¾ç½®å³å¯ï¼Œæ— éœ€ä»»ä½•é…ç½®ã€‚

```bash
# 1. Test it works
python3 scripts/rate-limiter.py gate && echo "âœ… Working"

# 2. Add to your agent loop
python3 scripts/rate-limiter.py gate || exit 1
python3 scripts/rate-limiter.py record 1000
```

å°±è¿™æ ·ç®€å•ã€‚åœ¨å¼€å§‹å·¥ä½œå‰å…ˆè¿è¡Œè¿™ä¸ªå·¥å…·ï¼Œå·¥ä½œç»“æŸåå†è®°å½•ç›¸å…³æ•°æ®ã€‚å…¶ä»–çš„è°ƒæ•´å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è¿›è¡Œã€‚

---

## é…ç½®

æ‰€æœ‰é…ç½®é¡¹éƒ½æ˜¯å¯é€‰çš„ã€‚é»˜è®¤å€¼é‡‡ç”¨è¾ƒä¸ºä¿å®ˆçš„Claude Max 5xè®¾ç½®ã€‚

```bash
export RATE_LIMIT_PROVIDER="claude"          # claude | openai | custom
export RATE_LIMIT_PLAN="max-5x"             # max-5x | max-20x | plus | pro | custom
export RATE_LIMIT_STATE="/path/to/state.json"  # State file location
export RATE_LIMIT_WINDOW_HOURS="5"           # Rolling window duration
export RATE_LIMIT_ESTIMATE="200"             # Estimated request limit per window
```

### æä¾›å•†é¢„è®¾

| æä¾›å•† | è®¡åˆ’å‘¨æœŸ | æ—¶é—´çª—å£ | é¢„è®¡è¯·æ±‚ä¸Šé™ | å¤‡æ³¨ |
|---|---|---|---|---|
| `claude` | `max-5x` | 5å°æ—¶ | 200æ¬¡è¯·æ±‚ | è¾ƒä¸ºä¿å®ˆçš„ä¼°è®¡å€¼ |
| `claude` | `max-20x` | 5å°æ—¶ | 540æ¬¡è¯·æ±‚ | æ¥è¿‘ç†è®ºä¸Šé™çš„60% |
| `openai` | `plus` | 3å°æ—¶ | 80æ¬¡è¯·æ±‚ | ä½¿ç”¨GPT-4oæ¨¡å‹ |
| `openai` | `pro` | 3å°æ—¶ | 200æ¬¡è¯·æ±‚ | æ›´é«˜çº§åˆ«çš„ä½¿ç”¨ç­–ç•¥ |
| `custom` | â€” | å¯è‡ªå®šä¹‰ | æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´ |

è¿™äº›é¢„è®¾å€¼ä»…ä¾›å‚è€ƒã€‚ä½ éœ€è¦æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´`RATE_LIMIT_ESTIMATE`å‚æ•°â€”â€”æ¯ä¸ªè´¦æˆ·çš„è¯·æ±‚é¢‘ç‡å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚

---

## ç­‰çº§ç³»ç»Ÿ

| ç­‰çº§ | è§¦å‘æ¡ä»¶ | æ¨èè¡Œä¸º |
|---|---|---|
| `ok` | è¯·æ±‚é¢‘ç‡<90% | ç»§ç»­æ­£å¸¸è¿è¡Œ |
| `cautious` | è¯·æ±‚é¢‘ç‡â‰¥90% | è·³è¿‡ä¸»åŠ¨æ£€æŸ¥å’Œéå¿…è¦çš„åå°ä»»åŠ¡ |
| `throttled` | è¯·æ±‚é¢‘ç‡â‰¥95% | ä¸åˆ›å»ºå­ä»£ç†ï¼Œå›å¤ç®€æ´ï¼Œè·³è¿‡éå¿…è¦çš„å®šæ—¶ä»»åŠ¡ |
| `critical` | è¯·æ±‚é¢‘ç‡â‰¥98% | ä»…å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œæ¯æ¬¡æœ€å¤šè°ƒç”¨ä¸€ä¸ªå·¥å…·ï¼Œæ‰€æœ‰å®šæ—¶ä»»åŠ¡åœæ­¢æ‰§è¡Œ |
| `paused` | é‡åˆ°429é”™è¯¯ | æ‰€æœ‰æ“ä½œåœæ­¢ï¼Œè‡ªåŠ¨æ¢å¤ |

### ä¸ºä»€ä¹ˆé€‰æ‹©90%ã€95%å’Œ98%ä½œä¸ºé˜ˆå€¼ï¼Ÿ

è¿™äº›é˜ˆå€¼å¹¶ééšæ„è®¾å®šã€‚Anthropicå’ŒOpenAIç­‰APIæä¾›å•†ä¼šåœ¨ä½ è¾¾åˆ°è¯·æ±‚ä¸Šé™ä¹‹å‰å°±å¼€å§‹æ‹’ç»è¯·æ±‚â€”â€”å› ä¸ºå®ƒä»¬æ— æ³•å¤„ç†æ­£åœ¨å¤„ç†ä¸­çš„è¯·æ±‚ï¼Œè€Œä¸”å®ƒä»¬çš„å†…éƒ¨è®¡æ•°å™¨å¯èƒ½ä¸ä½ çš„ä¸åŒã€‚90%çš„é˜ˆå€¼å¯ä»¥è®©ä½ æœ‰è¶³å¤Ÿçš„æ—¶é—´ä¼˜é›…åœ°å®Œæˆå½“å‰ä»»åŠ¡ã€‚å½“è¯·æ±‚é¢‘ç‡è¾¾åˆ°95%æ—¶ï¼Œä½ å°±è¿›å…¥äº†å±é™©åŒºåŸŸï¼Œä»»ä½•çªç„¶çš„è¯·æ±‚éƒ½å¯èƒ½å¯¼è‡´429é”™è¯¯ã€‚è€Œ98%çš„é˜ˆå€¼åˆ™æ„å‘³ç€ä½ è·ç¦»è¯·æ±‚ä¸Šé™åªæœ‰ä¸€æ­¥ä¹‹é¥ã€‚è¿™æ ·çš„åˆ†çº§è®¾ç½®å¯ä»¥ç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿå¹³æ»‘åœ°é™ä½è¯·æ±‚é¢‘ç‡ï¼Œè€Œä¸ä¼šçªç„¶å´©æºƒã€‚

---

## å‘½ä»¤

```bash
python3 scripts/rate-limiter.py <command> [args]

gate                    # Check tier, exit code reflects severity
record [tokens]         # Log a request (tokens optional, default 0)
status                  # Full status JSON (tier, pct, requests, limit, backoff info)
pause [minutes]         # Enter paused state (auto backoff if no minutes given)
resume                  # Clear pause, reset to cautious
set-limit <n>           # Override estimated request limit
reset                   # Reset all state to defaults
```

### é”™è¯¯ä»£ç 

| ä»£ç  | å«ä¹‰ |
|---|---|
| `0` | çŠ¶æ€æ­£å¸¸æˆ–å¤„äºè°¨æ…çº§åˆ«â€”â€”ç»§ç»­è¿è¡Œ |
| `1` | å¤„äºé™åˆ¶ä½¿ç”¨çº§åˆ«â€”â€”å‡å°‘è¯·æ±‚é¢‘ç‡ |
| `2` | å¤„äºä¸¥é‡æˆ–æš‚åœçº§åˆ«â€”â€”åœæ­¢éå¿…è¦çš„æ“ä½œ |

---

## å®Œæ•´é›†æˆç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨è¯¥å·¥å…·è¿›è¡Œè¯·æ±‚é¢‘ç‡æ£€æŸ¥ã€æ ¹æ®æ¡ä»¶è°ƒæ•´è¡Œä¸ºã€è®°å½•æ—¥å¿—ä»¥åŠå¤„ç†429é”™è¯¯ï¼š

```bash
#!/bin/bash
GATE=$(python3 scripts/rate-limiter.py gate 2>/dev/null)
EXIT=$?

if [ $EXIT -eq 2 ]; then
  echo "ğŸ›‘ Critical/paused. Skipping work."
  exit 0
fi

if [ $EXIT -eq 1 ]; then
  echo "âš¡ Throttled. Doing minimal work only."
  # skip sub-agents, background tasks, etc.
fi

# --- Do your actual work here ---
RESULT=$(your-agent-command 2>&1)

if echo "$RESULT" | grep -qi "rate_limit\|429"; then
  # Hit a 429 â€” pause with exponential backoff
  PAUSE_INFO=$(python3 scripts/rate-limiter.py pause)
  UNTIL=$(echo "$PAUSE_INFO" | python3 -c "import sys,json; print(json.load(sys.stdin).get('pausedUntil','unknown'))")
  echo "ğŸ›‘ Rate limited. Paused until $UNTIL"
  exit 1
fi

# Record usage (estimate tokens based on your workload)
python3 scripts/rate-limiter.py record 2000
```

---

## ä»£ç†é›†æˆ

### åœ¨`AGENTS.md`æ–‡ä»¶æˆ–ç³»ç»Ÿæç¤ºä¸­é…ç½®ï¼š

```markdown
## Rate Limiting

Before expensive operations: `python3 scripts/rate-limiter.py gate`
- Exit 0 â†’ proceed normally
- Exit 1 â†’ reduce activity (no spawns, terse responses)
- Exit 2 â†’ stop all non-essential work

After significant work: `python3 scripts/rate-limiter.py record <approx_tokens>`

On 429 error:
1. `python3 scripts/rate-limiter.py pause`
2. Stop current work
3. Set a timer/cron to run `python3 scripts/rate-limiter.py resume` at the pausedUntil time
```

### åœ¨å¿ƒè·³æ£€æŸ¥ä¸­é›†æˆï¼š

```markdown
## Rate Limit Gate (ALWAYS FIRST)
Run: `python3 scripts/rate-limiter.py gate`
- Exit 2 â†’ reply HEARTBEAT_OK immediately. Do nothing else.
- Exit 1 â†’ skip proactive checks. Only handle urgent items.
- Exit 0 â†’ proceed normally.
```

### åœ¨å®šæ—¶ä»»åŠ¡ä¸­é›†æˆï¼š

åªéœ€å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œè„šæœ¬å¼€å¤´ï¼š

```
**FIRST: Rate limit gate check.** Run `python3 scripts/rate-limiter.py gate`.
If exit code is 2, reply 'RATE_LIMITED' and stop.
If exit code is 1, do only essential work.
```

---

## å·¥ä½œåŸç†

è¯¥å·¥å…·ä½¿ç”¨**å¯å‘å¼ä¼°è®¡**æ–¹æ³•ï¼Œè€Œä¸æ˜¯ç›´æ¥è·å–APIå±‚é¢çš„ä½¿ç”¨æ•°æ®ã€‚å®ƒä¼šåœ¨ä¸€ä¸ªæ»šåŠ¨çš„æ—¶é—´çª—å£å†…ç»Ÿè®¡è¯·æ±‚é¢‘ç‡ï¼Œå¹¶ä¸å¯é…ç½®çš„è¯·æ±‚ä¸Šé™è¿›è¡Œæ¯”è¾ƒã€‚

**ä¸ºä»€ä¹ˆä½¿ç”¨å¯å‘å¼ä¼°è®¡ï¼Ÿ**å› ä¸ºAnthropicå’ŒOpenAIéƒ½æ²¡æœ‰æä¾›å®æ—¶çš„è¯·æ±‚ä½¿ç”¨æ•°æ®æ¥å£ã€‚è¦è·å–è¿™äº›æ•°æ®éœ€è¦é€šè¿‡æµè§ˆå™¨ç™»å½•å¹¶æ‰‹åŠ¨æŠ“å–æ•°æ®ï¼Œè€Œè¿™ä¸ªå·¥å…·åˆ™å®Œå…¨ä¸éœ€è¦ä»»ä½•å¤–éƒ¨ä¾èµ–ã€‚

**å‡†ç¡®ç‡ï¼š**å¤§çº¦70-85%ï¼Œå…·ä½“å–å†³äºä¼°è®¡å€¼ä¸å®é™…è¯·æ±‚ä¸Šé™çš„åŒ¹é…ç¨‹åº¦ã€‚å¦‚æœä½ ç»å¸¸é‡åˆ°429é”™è¯¯ï¼Œå¯ä»¥é™ä½`RATE_LIMIT_ESTIMATE`çš„å€¼ï¼›å¦‚æœä½ çš„ç³»ç»Ÿè¿‡äºä¿å®ˆï¼Œå¯ä»¥é€‚å½“æé«˜è¿™ä¸ªå€¼ã€‚

**æé«˜å‡†ç¡®ç‡çš„æ–¹æ³•ï¼š**
- æœ€åˆä½¿ç”¨è¾ƒä¸ºä¿å®ˆçš„é¢„è®¾å€¼ã€‚
- å¦‚æœé‡åˆ°429é”™è¯¯ï¼Œå·¥å…·ä¼šè‡ªåŠ¨é€šè¿‡æŒ‡æ•°çº§å»¶è¿Ÿç­–ç•¥è¿›è¡Œè°ƒæ•´ã€‚
- è¿è¡Œå‡ å¤©åï¼Œæ£€æŸ¥`status`å‘½ä»¤ä»¥äº†è§£å®é™…çš„è¯·æ±‚æ¨¡å¼ã€‚
- æ ¹æ®å®é™…æ•°æ®è°ƒæ•´`RATE_LIMIT_ESTIMATE`çš„å€¼ã€‚

---

## çŠ¶æ€æ–‡ä»¶

è¯¥å·¥å…·ä¼šç”Ÿæˆä¸€ä¸ªJSONæ ¼å¼çš„çŠ¶æ€æ–‡ä»¶ï¼ˆé»˜è®¤è·¯å¾„ä¸º`./rate-limit-state.json`ï¼‰ï¼Œæ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š

```json
{
  "provider": "claude",
  "plan": "max-5x",
  "tier": "ok",
  "estimatedPct": 23,
  "window": {
    "durationMs": 18000000,
    "requests": [{"ts": 1234567890, "tokens": 3000}],
    "estimatedLimit": 200
  },
  "backoff": {
    "consecutive429s": 0,
    "lastBackoffMs": 0
  },
  "pausedUntil": null
}
```

---

## ä¸ºä»€ä¹ˆä¸ç”¨æ‰‹åŠ¨å¤„ç†429é”™è¯¯ï¼Ÿ

| å¤„ç†æ–¹æ³• | é—®é¢˜ |
|---|---|
| **ä¸è¿›è¡Œå¤„ç†** | ä»£ç†å¯èƒ½ä¼šå´©æºƒï¼Œä¸¢å¤±ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œé‡å¤è¯·æ±‚ä¼šæµªè´¹èµ„æº |
| **ç®€å•çš„é‡è¯•æœºåˆ¶** | ä¼šä¸æ–­å‘APIå‘é€è¯·æ±‚ï¼Œä½¿é—®é¢˜æ›´åŠ ä¸¥é‡ï¼Œä¸”æ— æ³•æ”¹å˜ä»£ç†çš„è¡Œä¸º |
| **ç›‘æ§ä»ªè¡¨ç›˜** | åªèƒ½åœ¨è¯·æ±‚è¢«é™åˆ¶åæ‰èƒ½å‘ç°é—®é¢˜ï¼Œæ— æ³•é¢„é˜²é”™è¯¯çš„å‘ç”Ÿ |
| **è¿™ä¸ªå·¥å…·** | èƒ½åœ¨é”™è¯¯å‘ç”Ÿä¹‹å‰å°±è¿›è¡Œé¢„é˜²ï¼Œå®ç°å¹³æ»‘çš„è¯·æ±‚é¢‘ç‡é™ä½å’Œè‡ªåŠ¨æ¢å¤ï¼Œä¸”å®Œå…¨ä¸éœ€è¦ä»»ä½•å¤–éƒ¨ä¾èµ–ã€‚ |

å…³é”®åŒºåˆ«åœ¨äºï¼šè¿™ä¸ªå·¥å…·æ˜¯**é¢„é˜²æ€§çš„**ï¼Œè€Œä¸æ˜¯åœ¨é—®é¢˜å‘ç”Ÿåæ‰é‡‡å–è¡ŒåŠ¨ã€‚å®ƒä¼šåœ¨è¯·æ±‚é¢‘ç‡æ¥è¿‘ä¸Šé™ä¹‹å‰å°±è‡ªåŠ¨é™ä½ä»£ç†çš„è¯·æ±‚é¢‘ç‡ï¼Œä»è€Œä¿æŠ¤ä»£ç†çš„æ­£å¸¸è¿è¡Œå¹¶é¿å…èµ„æºæµªè´¹ã€‚

---

## æ•…éšœæ’é™¤

**å³ä½¿æ˜¾ç¤ºä¸ºâ€œokâ€çŠ¶æ€ï¼Œä»ç„¶é‡åˆ°429é”™è¯¯**
å¯èƒ½æ˜¯å› ä¸ºä½ çš„è¯·æ±‚é¢‘ç‡ä¼°è®¡å€¼è¿‡é«˜ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è°ƒæ•´å®ƒï¼š`python3 scripts/rate-limiter.py set-limit 150`ï¼ˆæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´æ•°å€¼ï¼‰ã€‚é»˜è®¤çš„é¢„è®¾å€¼è¾ƒä¸ºä¿å®ˆï¼Œä½†ä½ çš„è´¦æˆ·å®é™…çš„é™åˆ¶å¯èƒ½æ›´ä½ã€‚

**çŠ¶æ€æ–‡ä»¶æŸå**
ä½¿ç”¨`python3 scripts/rate-limiter.py reset`å‘½ä»¤é‡ç½®æ‰€æœ‰é…ç½®ã€‚è¿™ä¼šæ¸…é™¤æ‰€æœ‰å†å²æ•°æ®å¹¶é‡æ–°å¼€å§‹ç»Ÿè®¡ã€‚ä½ çš„é…ç½®ä¿¡æ¯ä¸ä¼šä¸¢å¤±ï¼Œåªéœ€é‡æ–°è®¾ç½®ç¯å¢ƒå˜é‡å³å¯ã€‚

**ä¼°è®¡å€¼ä¸å®é™…æƒ…å†µç›¸å·®è¾ƒå¤§**
ä½¿ç”¨`python3 scripts/rate-limiter.py status`å‘½ä»¤æ£€æŸ¥å®é™…è¯·æ±‚æ¨¡å¼ã€‚æ¯”è¾ƒå®é™…è¯·æ±‚æ¬¡æ•°ä¸é¢„è®¾çš„è¯·æ±‚ä¸Šé™ã€‚å¦‚æœä½ çš„å®é™…è¯·æ±‚æ¬¡æ•°è¿œä½äºé¢„è®¾å€¼ï¼Œè¯´æ˜ä¼°è®¡å€¼è¿‡é«˜ï¼›å¦‚æœå®é™…è¯·æ±‚æ¬¡æ•°è¿œé«˜äºé¢„è®¾å€¼ï¼Œå¯ä»¥é€‚å½“æé«˜ä¼°è®¡å€¼ã€‚

**å¤šä¸ªOpenClawå®ä¾‹**
æ¯ä¸ªå®ä¾‹éƒ½éœ€è¦æœ‰è‡ªå·±çš„çŠ¶æ€æ–‡ä»¶ã€‚è¯·ä¸ºæ¯ä¸ªå®ä¾‹è®¾ç½®å”¯ä¸€çš„è·¯å¾„æ¥å­˜å‚¨çŠ¶æ€æ–‡ä»¶ï¼š
```bash
export RATE_LIMIT_STATE="/path/to/instance-1-rate-limit.json"
```
å¦åˆ™ï¼Œå®ƒä»¬ä¼šäº’ç›¸è¦†ç›–æ•°æ®ï¼Œå¯¼è‡´ä¼°è®¡å€¼å¤±æ•ˆã€‚