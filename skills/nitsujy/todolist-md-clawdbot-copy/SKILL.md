---
name: todolist-md-clawdbot
description: 操作 `todolist-md` 格式的 Markdown 任务文件：读取并汇总任务内容，提出修改建议，然后仅使用 `<!-- bot: ... -->` 标记将修改结果写回 Markdown 文件中（确保代码行的稳定性）。
---

# todolist-md-clawdbot

本工具用于操作 **todolist-md**：一个以 Markdown 为优先格式的待办事项查看/编辑工具。该工具不包含人工智能功能；它仅用于读取和写入 Markdown 格式的文件。

## 操作规则（必须遵守）

1. **记录方式**：使用 Markdown 格式。
   - 可以在聊天中讨论，但最终的答案或决策必须以 Markdown 格式记录下来。

2. **使用特定的机器人标记**：
   - 使用 `<!-- bot: ... -->` 标记来标识机器人的操作。
   - 请勿使用其他语法（例如 `Question[id=...]` 或自定义元数据块）。

3. **保持任务唯一性**：
   - `todolist-md` 会根据 Markdown 文件中的行号来生成任务 ID。
   - 一些存储后端也会为文件生成唯一的标识键（例如：Google Drive 的 `fileId`、本地的 `path`、S3 的 `bucket+key`）。
   - 除非用户明确同意，否则不要以任何可能改变文件标识键的方式修改文件。

4. **保持编辑内容的稳定性**：
   - 避免在现有任务项或其描述块中添加或删除行。
   - 建议使用单行、原位编辑方式来修改内容。

5. **记录最后审核时间**：
   - 最后审核时间应记录在文件顶部的标题行中。
   - **规则**：一旦标题行存在，就不要再插入新行；只需更新现有标题行。
   - 如果标题行不存在，且用户选择了选项 B，才能在文件顶部插入标题行。
   - 标题行的格式为：`<!-- bot: last_review --> 2026-02-04T15:39Z root=<rootFolderId> model=<model>`

6. **未经用户确认，不得完成任务**：
   - 任何任务的完成都必须在用户明确确认后进行。

## Markdown 格式规范（todolist-md 的要求）

- 任务状态使用 GFM 格式的复选框：`- [ ]` 或 `[- [x]`。
- 可选标签：`#tag`
- 可选截止日期：`due:YYYY-MM-DD`
- 可选描述：描述内容应放在任务下方，并使用块引用格式。

## 存储相关问题与答案（首次运行时需要了解）

- **Q：存储类型是什么？**
  - **A：** `google-drive` | `local-folder` | `s3` | `other`

- **Q：文件的唯一标识键是什么？**
  - Google Drive：`fileId`
  - 本地：`path`
  - S3：`bucket+key`

- **Q：根目录在哪里？**
  - Google Drive：`rootFolderId`
  - 本地：根目录路径
  - S3：`bucket` + 可选前缀

## Chrome 应用集成（可按文件启用/禁用）

如果一个 Drive 文件夹中包含许多 `.md` 文件，并非所有文件都需要经过人工智能审核，可以通过以下方式实现：

**推荐方案（简单且由应用控制）：**
- Chrome 应用可以为每个文件添加一个配置标志，以便机器人知道该文件是否需要审核。

**两种简单的方法：**

### 方法 1：使用专门的 Drive 配置文件（推荐）：
- 在文件夹中创建一个配置文件：`.todolist-md.config.json`
- 机器人会在配置文件发生变化时自动下载它，并仅审核符合配置规则的文件。

### 方法 2：使用文件内的标记（无需 JSON）：
- 在 Markdown 文件的顶部添加一行标记：`<!-- bot: ai_enabled --> true`
- 机器人只会审核带有此标记的文件。

## 审核流程与时间记录（节省调用 LLM 的次数）

- **只有当文件发生变化时，才调用大型语言模型（LLM）**。建议优先使用代码来检测文件变化。

### 第一步：检测文件变化
- 对文件夹下的每个 `.md` 文件，比较其 `modifiedTime`/`size`（或 `etag`，如果有的话）与本地状态文件。
- 如果文件自上次扫描以来没有变化，则跳过审核（无需下载或调用 LLM）。

### 第二步：仅审核已更改的文件
- 对于已更改的文件：
  - 下载文件
  - 提取其中的待办事项（`- [ ]`）及相关上下文
  - （可选）仅对提取的部分内容调用 LLM，而不是整个文件。

### 第三步：仅在内容发生变化时进行更新
- 在更新文件之前，计算文件的哈希值；如果文件没有变化，则不进行更新。

### 第四步：记录最后审核时间（选项 B）
- 对于每个已审核的文件，更新文件顶部的标题行：
  - `<!-- bot: last_review --> <ISO_UTC> root=<rootFolderId> model=<model>`

### 参考脚本（针对 Google Drive 和 gog）

- 如果使用 **Google Drive** 作为存储方式，需要使用 gog CLI 命令：
  - 列出文件夹中的文件：`gog drive ls --parent <folderId> --json`
  - 下载文件：`gog drive download <fileId> --out <path>`
  - 在 Ubuntu 系统下运行 `gog` 命令，并将文件下载到 `/tmp` 目录（因为 `/root` 目录通常具有写入权限限制）。

**包含的辅助脚本：**

- `skills/todolist-md-clawdbot/scripts/todolist_drive_folder_agent.mjs`：
  - 该脚本会列出文件夹中的所有 `.md` 文件，检测变化，仅下载已更改的文件，并在文件中添加 `<!-- bot: suggested -->` 标记。
  - 使用 Drive API 的 `files.update` 方法来更新文件内容（避免重复下载）。
  - 包含版本控制机制（`headRevisionId`），以防止在 Chrome 中编辑时覆盖文件。
  - 支持 OAuth 认证；首次运行时会显示认证 URL，用户需要在浏览器中授权，之后可以使用 `--authCode <CODE>` 重新运行脚本。
  - **最小化调用 LLM 的次数**：仅当文件发生变化时才调用 LLM，并且只发送提取的待办事项内容。

- `skills/todolist-md-clawdbot/scripts/todolist_agent_entrypoint.mjs`：
  - 用于单个文件的辅助脚本（便于调试）：根据文件 ID 下载文件并更新内容。

## 允许使用的机器人标记

- `<!-- bot: suggested -->`：用于显示机器人建议的内容
- `<!-- bot: question -->`：用于在文件内提问/获取答案
- `<!-- bot: digest -->`：用于显示摘要或总结
- `<!-- bot: note -->`：用于记录简短的审核备注（可选）

## 与大型语言模型的协作流程（最小化调用次数）

当需要使用 LLM 提供帮助，同时希望保持 Drive 作为数据来源并控制成本时，可以按照以下两阶段流程操作：

### 第一阶段：准备数据
- 目标：生成一个简洁的 JSON 请求，供 OpenClaw 代理运行时使用（无需在 Node.js 脚本中直接调用 LLM）。
  - 步骤包括：
    - 列出文件夹中的文件
    - 比较每个文件的 `modifiedTime/size` 与本地状态文件
    - 仅下载已更改的 `.md` 文件
    - 提取其中的待办事项（`- [ ] ...`）

**命令示例（针对单个文件）：**

### 第二阶段：应用结果
- 目标：将代理运行时生成的 JSON 结果仅写入到指定的机器人部分。

**规则：**
- 仅更新以下部分：
  - `## Tasks (bot-suggested)`
  - `<!-- bot: suggested -->`
- **禁止将任务标记为已完成**。
- 使用 Drive API 的 `files.update` 方法按 `fileId` 更新文件内容（避免重复）。
- 使用版本控制机制（`headRevisionId`）来防止在 Chrome 中编辑时覆盖文件。

**建议的 JSON 格式：**

**为什么这样做可以节省调用 LLM 的次数？**
- 例如，如果一个文件夹中有 50 个 Markdown 文件，但只有 1 个文件发生了变化，那么 LLM 仅会被调用一次。
- 提示内容将仅包含提取的待办事项（`- [ ] ...`），而不会包含整个 Markdown 文件的内容。

## 写回文件的格式规范

- **机器人建议的任务**：
  - 将机器人生成的待办事项放在专门的部分中，以便用户进行审核。

**在文件内提问/获取答案（保持行内容的稳定性）**

- 可以使用任务下方的块引用格式来提问：

**回答方式：**

- 在同一行内添加答案，以保持行内容的稳定性：

**规则：**
- 每个任务最多只能有一个活跃的提问/回答对。
- 请将提问和回答内容保持在块引用区域内。
- 不要在提问和回答内容之外开启多行对话。

**将问答内容存档到机器人日志（建议在回答后执行）**

- 如果希望保持任务列表的整洁性，同时保留历史记录：
  - 在 `## Bot Log` 中添加一条记录。
  - 将原始的提问/回答内容替换为简短的占位符：

**机器人日志（仅追加记录）**

- 如果日志文件不存在，请创建一个：
- 添加记录的格式如下：

**总结内容**

- 在聊天中提供摘要，以便快速获取反馈。
- 可以选择将摘要以单行评论的形式写入 Markdown 文件中：

**完整示例流程**

- **初始状态：**

- 机器人会提出一个澄清性问题（在文件内显示）：

- 用户在同一行内进行回答（保持行内容的稳定性）：

- 机器人接收回答后，会将回答内容存档：

**集成注意事项（简要说明）**

- 始终使用 `<!-- bot: ... -->` 标记来标识机器人生成的内容。
- 请勿在现有任务项或描述内容中添加或删除行。
- 除非用户明确确认，否则不要将任务标记为已完成。