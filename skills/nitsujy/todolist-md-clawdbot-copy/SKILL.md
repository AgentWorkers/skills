---
name: todolist-md-clawdbot
description: 操作 `todolist-md` 格式的 Markdown 任务列表文件：读取任务内容并对其进行总结，提出修改建议，然后仅使用 `<!-- bot: ... -->` 标记将修改结果写回 Markdown 文件中（确保行格式保持不变）。
---

# todolist-md-clawdbot

本机器人用于操作 **todolist-md**：一个以 Markdown 为主要格式的待办事项查看/编辑工具。该工具不包含任何人工智能功能；它仅负责读取和写入 Markdown 文件。

## 操作规则（必须遵守）

1. **记录方式**：使用 Markdown 作为所有信息的存储格式。
   - 可以在聊天中讨论任务内容，但最终的答案或决策必须以 Markdown 的形式记录下来。

2. **使用特定的机器人标记**：
   - 使用 `<!-- bot: ... -->` 标记来标识机器人的操作。
   - 请勿使用其他自定义的语法格式（例如 `Question[id=...]` 或元数据块）。

3. **保持任务唯一性**：
   - `todolist-md` 会根据 Markdown 文件中的行号来生成任务 ID。
   - 一些存储系统也会为文件分配唯一的标识符（例如 Google Drive 的 `fileId`、本地文件的路径、S3 的 `bucket+key`）。
   - 除非用户明确同意，否则请勿更改文件的标识符。

4. **编辑内容的稳定性**：
   - 请勿在现有任务项或其描述内容中添加或删除行。
   - 建议直接在现有行上进行单行编辑。

5. **记录最后一次审核时间**：
   - 在文件顶部的标题行中记录最后一次审核时间。
   - **规则**：一旦标题行存在，就**不要插入新行**，只需更新现有行即可。
   - 如果标题行不存在，且用户选择了选项 B，才能在文件顶部插入该行。
   - 标记格式示例：`<!-- bot: last_review --> 2026-02-04T15:39Z root=<rootFolderId> model=<model>`

6. **未经用户确认，切勿完成任务**：
   - 任何任务的完成都必须得到用户的明确许可。

## Markdown 格式规范（todolist-md 的要求）

- 任务状态使用 GFM 标记（`- [ ]` 或 `[-]`）来表示已完成或未完成。
- 可选标签：`#tag`
- 可选截止日期：`due:YYYY-MM-DD`
- 任务描述：可以直接使用块引用（`**`）来添加。

## 存储相关问题与解答（首次运行时需要了解）

- **Q:** 存储方式是什么？
  - **A:** `google-drive` | `local-folder` | `s3` | `other`
- **Q:** 文件的唯一标识符是什么？
  - Google Drive：`fileId`
  - 本地文件：`path`
  - S3：`bucket+key`
- **Q:** 文件的根目录在哪里？
  - Google Drive：`rootFolderId`
  - 本地文件：根目录路径
  - S3：`bucket` + 可选前缀

## Chrome 应用集成（针对每个文件启用/禁用）

如果一个 Google Drive 文件夹中包含多个 `.md` 文件，并非所有文件都需要经过人工智能审核，可以通过以下方式来实现：

**推荐方案（简单且由应用控制）：**
- Chrome 应用可以为每个文件添加一个配置标志，以便机器人知道该文件是否需要审核。

**两种简单的方法：**

### 方法 1：使用专门的配置文件（推荐）
- 在文件夹中创建一个配置文件：`.todolist-md.config.json`
- 机器人会在配置文件更改时自动下载它，并仅审核符合配置规则的文件。

### 方法 2：使用文件内的标记（无需 JSON 文件）
- 在 Markdown 文件的顶部添加一行标记：`<!-- bot: ai_enabled --> true`
- 机器人只会审核带有此标记的文件。

## 审核流程与时间记录（节省调用 LLM 的次数）

- **仅在文件发生变化时才调用 LLM**。建议使用代码来检测文件的变化。

### 第一步：检测文件变化
- 对文件夹中的每个 `.md` 文件，比较其 `modifiedTime`/`size`（或 `etag`，如果有的话）与本地状态文件。
- 如果文件自上次扫描以来没有变化，则**跳过**审核。

### 第二步：仅审核已更改的文件
- 对于已更改的文件：
  - 下载文件
  - 提取未完成的任务（`- [ ]`）及相关信息
  - （可选）仅对提取的部分内容调用 LLM，而不是整个文件。

### 第三步：仅在内容更改时进行更新
- 在更新文件之前，计算文件的哈希值；如果文件未发生变化，则无需更新。

### 第四步：记录最后一次审核时间
- 对于每个已审核的文件，更新文件顶部的标题行：
  - `<!-- bot: last_review --> <ISO_UTC> root=<rootFolderId> model=<model>`

### 参考脚本（针对 Google Drive 和 gog）

- 如果使用 **Google Drive** 作为存储方式，需要使用 gog CLI 命令：
  - 列出文件夹中的文件：`gog drive ls --parent <folderId> --json`
  - 下载文件：`gog drive download <fileId> --out <path>`
  - 在 Ubuntu 环境中运行 `gog` 命令，并将文件下载到 `/tmp`（因为 `/root` 目录通常具有写入权限限制）。

**包含的辅助脚本：**

- `skills/todolist-md-clawdbot/scripts/todolist_drive_folder_agent.mjs`：
  - 该脚本会列出文件夹中的所有 `.md` 文件，检测变化，仅下载已更改的文件，并在文件顶部添加 `<!-- bot: suggested -->` 标记。
  - 使用 Drive API 的 `files.update` 方法来更新文件（避免重复下载）。
  - 包含版本控制机制（`headRevisionId`），以防止在 Chrome 中编辑时覆盖文件。
  - 支持 OAuth 认证；首次运行时会显示认证链接，用户确认后可以使用 `--authCode <CODE>` 重新运行脚本。
  - **最小化令牌使用**：仅在文件发生变化时才调用 LLM，并且只发送提取的未完成任务信息。

- `skills/todolist-md-clawdbot/scripts/todolist_agent_entrypoint.mjs`：
  - 用于单个文件的辅助脚本（便于调试）：按文件 ID 下载文件并更新内容。

## 允许使用的机器人标记

- `<!-- bot: suggested -->`：用于显示机器人建议的内容
- `<!-- bot: question -->`：用于在文件内提问或接收回答
- `<!-- bot: digest -->`：用于显示摘要或总结
- `<!-- bot: note -->`：用于添加简短的审核备注（可选）

## 与 LLM 的协作流程（最小化令牌使用）

当您需要 LLM 的帮助，但希望保持 Google Drive 作为数据来源（同时控制成本）时，可以按照以下两步流程操作：

### 第一步：准备数据
- 列出文件夹中的所有文件（无需下载）。
- 比较每个文件的 `modifiedTime/size` 与本地状态文件。
- 仅下载已更改的 `.md` 文件。

### 第二步：应用结果
- 将机器人生成的建议内容写入特定的文件部分。

**规则：**
- 仅更新以下部分：
  - `## Tasks (bot-suggested)`
  - `<!-- bot: suggested -->`
- 请勿将任务标记为已完成。
- 使用 Drive API 的 `files.update` 方法按 `fileId` 更新文件（避免重复）。
- 使用版本控制机制（`headRevisionId`）来防止覆盖文件。

**建议的 JSON 格式：**

### 为什么这样能节省令牌？

- 假设一个文件夹中有 50 个 Markdown 文件，但只有 1 个文件发生了变化：
  - LLM 仅会被调用一次，且只会处理已更改的文件内容。

## 内容更新规则

- 机器人建议的任务应单独显示，以便用户进行审核。

### 在文件内提问/接收回答

- 使用任务描述下的块引用来提问或接收回答：

### 回答方式

- 答案应直接在同一行中添加，以保持内容的行顺序不变：

### 存档问答记录（建议在回答后执行）

- 如果您希望保持任务列表的整洁同时保留历史记录：
  - 在 `## Bot Log` 中添加新的记录。
  - 将原始的问答内容替换为简短的占位符：

### 创建机器人日志（仅追加）

- 如果日志文件缺失，可以创建一个新的日志文件：

### 总结内容

- 在聊天中提供简要的总结。
- 可以选择将总结内容以单行注释的形式写入Markdown文件中：

### 完整的示例流程

- **初始状态**：
  （此处应展示初始的待办事项列表）

- **机器人提问**：
  （此处应展示机器人提出的问题）

- **用户回答**：
  （用户在同一行中编辑答案）

- **机器人处理回答后**：
  （此处应展示机器人如何处理用户的回答）

### 集成注意事项

- 请始终使用 `<!-- bot: ... -->` 标记来标识机器人生成的内容。
- 请勿在现有任务项或描述内容中添加或删除行。
- 除非用户明确确认，否则请勿将任务标记为已完成。