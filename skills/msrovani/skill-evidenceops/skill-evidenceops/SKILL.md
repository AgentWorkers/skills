---
name: evidenceops
description: >
  **法医媒体分类与证据管理**  
  适用于接收需要按照证据标准进行处理、进行完整性验证以及记录审计轨迹的图像、视频、音频文件或文档时。
version: 1.0.0
author: OpenClaw Community
metadata:
  openclaw:
    emoji: "🔬"
    tools:
      - evidence.ingest
      - evidence.verify
      - evidence.manifest
      - evidence.export
      - evidence.access_log
      - Read
      - Write
      - Bash
    install:
      npm: "@openclaw/evidence-vault"
    os:
      - darwin
      - linux
      - win32
    categories:
      - forensics
      - security
      - compliance
    tags:
      - evidence
      - chain-of-custody
      - forensic
      - integrity
      - audit
---
# EvidenceOps - 法医级媒体文件处理系统

## 功能概述

EvidenceOps 提供了法医级别的媒体文件处理能力，确保了文件处理的完整性和安全性：

1. **媒体文件接收**：支持从任何渠道接收图片、视频、音频、PDF 和文档文件。
2. **不可篡改的存储**：将原始文件存储在只读的加密存储库中，并为每个文件生成哈希值。
3. **元数据提取**：在不修改原始文件的情况下提取 EXIF 标签、文件属性和媒体信息。
4. **衍生文件生成**：在单独的文件夹中生成缩略图、文字记录和预览文件。
5. **文件完整性验证**：通过哈希链确保文件在存储过程中未被篡改。
6. **审计日志记录**：生成详细的 JSONL 格式审计日志，以符合合规性要求。

## 禁止的操作

- **严禁** 在文件接收后修改原始证据文件。
- **严禁** 将密钥、API 密钥或凭证存储在日志或清单中。
- **严禁** 接受未经清理的用户输入路径。
- **严禁** 执行不受信任的代码或下载远程脚本。
- **严禁** 未经明确配置就向外部服务传输数据。
- **严禁** 违反渠道访问规则或配对要求。
- **严禁** 在示例文件中存储真实的个人数据。

## 使用前提

在使用该功能之前，请确保：
- 已安装并初始化 `@openclaw/evidence-vault` 插件。
- 存储库目录具有适当的权限设置。
- 仅允许来自可信渠道的文件上传。
- 保留策略符合法律要求。

## 工作流程

### 第 1 步：接收媒体文件

当通过任何渠道接收到媒体文件时：

**所需信息：**
- 文件内容（来自附件）
- 原始文件名
- 来源渠道（WhatsApp、Telegram、电子邮件等）
- 发件人标识符
- 消息 ID（如果有的话）

### 第 2 步：创建或选择案件编号

案件编号格式：`case-{年份}-{序列号}`  
- 必须符合以下格式：`^case-[a-zA-Z0-9_-]+`  
- 例如：`case-2026-001`、`case-incident-alpha`、`case-legal-2026-q1`

### 第 3 步：将文件设置为只读状态

在文件上传之前：
1. 将接收到的文件保存到临时存储区。
2. 立即计算文件的 SHA-256 哈希值。
3. 记录文件大小和 MIME 类型。
4. **严禁** 修改文件内容。

### 第 4 步：提取元数据

在不修改原始文件的情况下提取元数据：
- **对于图片**：提取 EXIF 数据（如相机信息、GPS 位置、时间戳）、尺寸、颜色配置文件等。
- **对于视频**：提取时长、编码格式、分辨率等信息。
- **对于音频**：提取时长、采样率、编码格式等。
- **对于 PDF**：提取页数、作者信息（如果存在）、创建日期等。

### 第 5 步：生成衍生文件（可选）

在单独的文件夹中生成衍生文件：
- **缩略图**：低分辨率的图片或视频预览。
- **文字记录**：将音频或视频转换为文本。
- **预览文件**：PDF 或文本格式的文件。
- **OCR 文本**：从图片中提取文本。

### 第 6 步：将文件上传到存储库

调用 `evidence.ingest` 工具将文件上传到存储库：

**返回结果：** 包含文件 ID、哈希值和上传时间的响应。

### 第 7 步：更新清单

上传操作会自动更新清单文件：
- **清单文件位置**：`{vault}/cases/{caseId}/manifest.json`
- **清单内容**：包含案件元数据、文件信息（及其哈希值）、衍生文件信息、文件处理记录以及保留策略。

### 第 8 步：向用户提供文件接收确认

向用户提供文件接收的确认信息。

## 工具参考

### `evidence.ingest`

将文件上传到存储库：
- **参数**：
  | 参数类型 | 是否必填 | 说明 |
  |-----------|---------|-------------|
  | filePath | 字符串 | 是 | 文件的临时存储路径 |
  | filename | 字符串 | 是 | 原始文件名 |
  | caseId | 字符串 | 是 | 案件编号 |
  | channel | 字符串 | 否 | 来源渠道 |
  | sender | 字符串 | 否 | 发件人标识符 |
  | messageId | 字符串 | 否 | 来源消息 ID |
  | retentionDays | 数字 | 否 | 文件保留天数 |
  | metadata | 对象 | 否 | 额外元数据 |
- **返回值**：`{ evidenceId, sha256, vaultUrl, timestamp }`

### `evidence.verify`

验证文件的完整性：
- **参数**：
  | 参数类型 | 是否必填 | 说明 |
  |-----------|---------|-------------|
  | evidenceId | 字符串 | 需要验证的文件 ID |
  | caseId | 字符串 | 是否限制搜索范围（仅限指定案件） |
- **返回值**：`{ verified, details: { originalIntact, hashMatch, lastVerifiedAt } `

### `evidence.manifest`

获取案件清单：
- **参数**：
  | 参数类型 | 是否必填 | 说明 |
  |-----------|---------|-------------|
  | caseId | 字符串 | 案件编号 |
- **返回值**：包含所有案件信息的完整清单。

### `evidence.export`

将案件数据导出为压缩文件：
- **参数**：
  | 参数类型 | 是否必填 | 说明 |
  |-----------|---------|-------------|
  | caseId | 字符串 | 案件编号 |
  | format | 字符串 | 导出格式（默认为 zip） |
- **返回值**：`{ exportPath, sha256, size, itemCount }`

### `evidence.access_log`

获取审计日志：
- **参数**：
  | 参数类型 | 是否必填 | 说明 |
  |-----------|---------|-------------|
  | caseId | 字符串 | 案件编号 |
  | limit | 数字 | 最大事件数量（默认为 100） |
- **返回值**：`{ events: [ ... ], count }`（包含所有事件记录）

## 安全配置

### 渠道访问规则配置

配置允许提交文件的渠道：

### 配对要求

- **直接消息（DM）**：必须先完成配对才能上传文件；默认情况下，未配对的 DM 会被拒绝。
- **群组渠道**：确保来源渠道在允许列表中；来自不受信任渠道的文件会被拒绝；禁止自动上传。

### 路径清理规则

所有路径都会经过以下验证：
- **禁止路径遍历**：拒绝包含 `../` 的路径。
- **禁止空字节**：拒绝以 `\0` 开头的路径。
- **禁止使用 home 目录**：拒绝以 `~/` 开头的路径。
- **路径规范化**：在验证前对路径进行规范化处理。
- **路径必须位于存储库目录内**：违反规则会导致 `E_PATH_TRAVERSAL` 错误，并记录在审计日志中。

### 破坏性操作确认

在执行任何可能具有破坏性的操作之前：
- **导出操作**：需要用户确认导出目的地。
- **删除操作**：需要用户明确确认。
- **数据保留/释放**：需要用户明确确认。

### 秘密信息处理

**严禁** 将以下信息记录在日志或清单中：**
- API 密钥
- 密码
- 令牌
- 信用卡号码
- 电子邮件地址（已屏蔽）
- 电话号码（已屏蔽）
- 社会安全号码（SSN）（已屏蔽）

这些敏感信息会通过正则表达式自动屏蔽。

## 故障排除

### 错误：`E_PATH_TRAVERSAL`

**原因**：文件名或路径中包含不允许的字符。
**解决方法**：
- 文件名会自动进行清洗处理。
- 如果错误仍然存在，请检查文件名中是否有异常字符；原始文件名会保存在清单元数据中。

### 错误：`E_INVALID_MIME`

**原因**：文件类型不在允许的列表中。
**解决方法**：
- 检查 `allowedMimeTypes` 配置。
- 如有必要，将相关 MIME 类型添加到允许列表中。
- 确认文件未被损坏。

### 错误：`E_SIZE_LIMIT`

**原因**：文件大小超过允许的最大限制。
**解决方法**：
- 检查 `maxFileSizeBytes` 配置。
- 如有必要，将大文件分割后再上传；并在上传前压缩文件（请在元数据中注明）。

### 错误：`E_CHANNEL_BLOCKED`

**原因**：文件来自被禁止或不在允许列表中的渠道。
**解决方法**：
- 确认来源渠道是否在允许列表中。
- 检查是否需要完成配对操作。
- 重新检查安全配置。

### 错误：`E_HASH_MISMATCH`

**原因**：文件在上传后被修改。
**解决方法**：
- 这可能表明文件被篡改；请查看相关案件的访问日志。
- 按照事件处理流程进行上报。

### 验证失败

**症状**：`verified` 的值为 `false`。
**诊断步骤**：
1. 确认原始文件是否存在。
2. 将当前文件的哈希值与清单中的哈希值进行比较。
- 查看审计日志以确认是否有文件被修改。
- 检查文件系统的权限设置。

## 配置示例

### 法律与合规性注意事项

- 使用 `sensitivityTag` 标记敏感数据。
- 配置适当的文件保留期限。
- 严禁在示例文件中存储真实的个人数据。
- 实施数据主体访问请求流程。

### 文件保留政策

| 数据敏感性 | 默认保留期限 |
|-------------|-------------------|
| 公共数据 | 365 天 |
| 内部数据 | 1825 天（5 年） |
| 机密数据 | 2555 天（7 年） |
| 限制访问数据 | 需根据法律要求保留 |

### 审计要求

所有操作都会被记录在 JSONL 格式的审计日志中：
- 案件创建/删除
- 文件上传
- 验证操作
- 数据导出
- 访问请求

**审计日志的保留期限**：与文件保留期限相同。