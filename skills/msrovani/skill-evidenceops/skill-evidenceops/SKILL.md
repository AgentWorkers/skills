---
name: evidenceops
description: >
  **法医媒体分类与证据保管链管理**  
  适用于接收需要按照证据标准进行处理、进行完整性验证以及记录审计轨迹的图片、视频、音频文件或文档时。
version: 1.0.0
author: OpenClaw Community
metadata:
  openclaw:
    emoji: "🔬"
    tools:
      - evidence.ingest
      - evidence.verify
      - evidence.manifest
      - evidence.export
      - evidence.access_log
      - Read
      - Write
      - Bash
    install:
      npm: "@openclaw/evidence-vault"
    os:
      - darwin
      - linux
      - win32
    categories:
      - forensics
      - security
      - compliance
    tags:
      - evidence
      - chain-of-custody
      - forensic
      - integrity
      - audit
---
# EvidenceOps - 法医级媒体文件处理系统

## 功能概述

EvidenceOps 提供了法医级别的媒体文件处理能力，并确保了文件处理的完整追溯性（即“证据保管链”）：

1. **媒体文件接收**：支持从任何渠道接收图片、视频、音频、PDF 和文档文件。
2. **不可篡改的存储**：将原始文件存储在只读的加密存储库中，并为每个文件生成哈希值。
3. **元数据提取**：在不修改原始文件的情况下提取 EXIF 标签、文件属性和媒体相关信息。
4. **衍生文件生成**：在单独的文件夹中生成缩略图、文字记录和预览内容。
5. **证据保管链**：通过哈希值链维护不可篡改的审计轨迹。
6. **文件完整性验证**：确保文件在接收后未被修改。
7. **审计日志**：生成详细的 JSONL 格式审计日志，以满足合规性要求。

## 明确禁止的行为

- **绝对禁止** 在接收文件后修改原始证据文件。
- **绝对禁止** 在日志或清单中存储任何敏感信息（如 API 密钥、凭证等）。
- **绝对禁止** 接受未经清理的用户输入路径。
- **绝对禁止** 执行未经验证的代码或下载远程脚本。
- **绝对禁止** 未经明确配置的情况下将数据导出到外部服务。
- **绝对禁止** 违反渠道访问规则或配对要求。
- **绝对禁止** 在示例文件中存储真实的个人身份信息。

## 使用前提

在使用该功能之前，请确保：
- 已安装并初始化 `@openclaw/evidence-vault` 插件。
- 存储目录已配置适当的权限。
- 仅允许来自可信渠道的文件被接收。
- 保留策略符合相关法律要求。

## 工作流程

### 第一步：接收媒体文件

当通过任何渠道接收到媒体文件时：

**所需信息：**
- 文件内容（来自附件）
- 原始文件名
- 来源渠道（如 WhatsApp、Telegram、电子邮件等）
- 发件人标识
- 消息 ID（如有的话）

### 第二步：创建或选择案件编号

案件编号格式：`case-{年份}-{序列号}`  
- 必须符合以下格式：`^case-[a-zA-Z0-9_-]+`  
- 例如：`case-2026-001`、`case-incident-alpha`、`case-legal-2026-q1`

### 第三步：将文件放入只读临时存储区

在文件接收之前：
1. 将文件保存到临时存储区。
2. 立即计算文件的 SHA-256 哈希值。
3. 记录文件大小和 MIME 类型。
4. **严禁** 修改文件内容。

### 第四步：提取元数据

在不修改原始文件的情况下提取元数据：
- **对于图片**：提取 EXIF 数据（如相机信息、GPS 位置、时间戳等）、尺寸和颜色配置文件。
- **对于视频**：提取时长、编码格式和分辨率。
- **对于音频**：提取时长、采样率和编码格式。
- **对于 PDF**：提取页数、作者信息（如果文件中包含的话）和创建日期。

### 第五步：生成衍生文件（可选）

在单独的文件夹中生成衍生文件：
- **缩略图**：降低分辨率的图片或视频预览。
- **文字记录**：将音频或视频转换为文本。
- **预览文件**：PDF 或文本形式的文件。
- **OCR 文本**：从图片中提取文本。

### 第六步：将文件上传到存储库

调用 `evidence.ingest` 工具将文件上传到存储库：

**返回结果：** （具体返回内容取决于工具的实现）

### 第七步：更新文件清单

文件上传后，系统会自动更新文件清单：
- 文件清单存储路径：`{vault}/cases/{caseId}/manifest.json`
- 清单内容包括：案件元数据、文件的哈希值、生成的衍生文件以及文件处理的完整记录。
- 保留策略也会被记录在清单中。

### 第八步：向用户提供接收确认

向用户提供文件接收的确认信息。

## 工具参考

### `evidence.ingest`

用于将文件上传到证据存储库：
- **参数：**
  | 参数类型 | 是否必填 | 说明 |
  |-----------|------|----------|
  | filePath | 字符串 | 是 | 文件的临时存储路径 |
  | filename | 字符串 | 是 | 原始文件名 |
  | caseId | 字符串 | 是 | 案件编号 |
  | channel | 字符串 | 否 | 文件来源渠道 |
  | sender | 字符串 | 否 | 发件人标识 |
  | messageId | 字符串 | 否 | 来源消息的 ID |
  | retentionDays | 数字 | 否 | 文件保留天数 |
  | metadata | 对象 | 否 | 额外元数据 |
- **返回值：** `{ evidenceId, sha256, vaultUrl, timestamp }`

### `evidence.verify`

用于验证文件的完整性：
- **参数：**
  | 参数类型 | 是否必填 | 说明 |
  |-----------|------|----------|
  | evidenceId | 字符串 | 需要验证的文件 |
  | caseId | 字符串 | 限制查询范围（仅限于指定案件） |
- **返回值：** `{ verified, details: { originalIntact, hashMatch, lastVerifiedAt } }`

### `evidence.manifest`

用于获取案件清单：
- **参数：**
  | 参数类型 | 是否必填 | 说明 |
  |-----------|------|----------|
  | caseId | 字符串 | 案件编号 |
- **返回值：** 包含所有案件详细信息的完整清单。

### `evidence.export`

用于将案件数据导出为压缩文件：
- **参数：**
  | 参数类型 | 是否必填 | 说明 |
  |-----------|------|----------|
  | caseId | 字符串 | 案件编号 |
  | format | 字符串 | 导出格式（默认为 'zip' 或 'tar'） |
- **返回值：** `{ exportPath, sha256, size, itemCount }`

### `evidence.access_log`

用于获取审计日志：
- **参数：**
  | 参数类型 | 是否必填 | 说明 |
  |-----------|------|----------|
  | caseId | 字符串 | 案件编号 |
  | limit | 数字 | 最大显示事件数（默认为 100） |
- **返回值：** `[ ... ]`（包含所有相关事件记录）`

## 安全配置

### 渠道访问控制

- **配置允许的提交渠道**：
  （具体配置方法未在文档中提供）

### 配对要求

- **直接消息（DM）**：
  - 必须先完成配对才能接收文件。
  - 默认情况下，未配对的 DM 会被拒绝。
  - 会记录所有被拒绝的上传尝试。

- **群组渠道**：
  - 确保渠道在允许列表中。
  - 来自不受信任渠道的文件会被拒绝。
  - **禁止** 自动从公共渠道接收文件。

### 路径清理规则

所有路径都会经过以下验证：
- **禁止** 路径遍历（例如：`../`）。
- **禁止** 包含空字节（`\0`）的路径。
- **禁止** 使用 `~/` 作为路径开头。
- **路径规范化**：在验证前会对路径进行标准化处理。
- **路径必须位于存储库目录内**。
- **违反规则会导致** `E_PATH_TRAVERSAL` 错误，并会被记录在审计日志中。

### 操作前的确认流程

在进行任何可能破坏文件的操作之前：
- **必须** 确认文件的导出目的地。
- **如果启用了保留删除功能**，必须获得明确确认。
- **对于需要法律保留的文件**，也必须获得明确确认。

### 敏感信息处理

- **严禁** 在日志或清单中存储以下信息：
  - API 密钥
  - 密码
  - 令牌
  - 信用卡号码
  - 电子邮件地址（已屏蔽）
  - 电话号码（已屏蔽）
  - 社会安全号码（SSN）（已屏蔽）

- 这些敏感信息会通过正则表达式自动屏蔽。

## 常见问题及解决方法

### 错误：`E_PATH_TRAVERSAL`

**原因**：文件名或路径中包含不允许的字符。
**解决方法**：
- 文件名会自动进行清理。
- 如果错误仍然存在，请检查文件名中是否有异常字符。
- 原始文件名会保存在清单元数据中。

### 错误：`E_INVALID_MIME`

**原因**：文件类型不在允许的列表中。
**解决方法**：
- 检查 `allowedMimeTypes` 配置。
- 如有必要，将文件类型添加到允许列表中。
- 确认文件没有损坏。

### 错误：`E_SIZE_LIMIT`

**原因**：文件大小超过允许的最大限制。
**解决方法**：
- 检查 `maxFileSizeBytes` 配置。
- 如有必要，可以将大文件分割后再上传。
- 在上传前对文件进行压缩（并在元数据中注明）。

### 错误：`E_CHANNEL_BLOCKED`

**原因**：文件来自被禁止或不在允许列表中的渠道。
**解决方法**：
- 确认渠道是否在允许列表中。
- 检查是否需要完成配对操作。
- 重新检查安全配置。

### 错误：`E_HASH_MISMATCH`

**原因**：文件在上传后被修改。
**解决方法**：
- 这可能表明文件被篡改。
- 查看相关案件的访问日志。
- 按照事件处理流程进行进一步处理。

### 验证失败

**症状**：`verified` 的值为 `false`。
**诊断步骤**：
1. 确认原始文件是否存在。
2. 将当前文件的哈希值与清单中的哈希值进行比较。
- 查看审计日志中是否有文件被修改的记录。
- 检查文件系统的权限设置。

### 配置示例

（具体配置内容未在文档中提供）

## 法律与合规性注意事项

- **LGPD/GDPR 规范**：
  - 使用 `sensitivityTag` 标记敏感数据。
  - 配置适当的文件保留期限。
- **严禁** 在示例文件中存储真实的个人身份信息。
- 需要实施数据主体访问请求处理流程。

### 文件保留政策

| 数据敏感性 | 默认保留期限 |
|-------------|-------------------|
| 公共数据 | 365 天 |
| 内部数据 | 1825 天（5 年） |
| 机密数据 | 2555 天（7 年） |
| 限制访问的数据 | 需根据法律要求保留 |

### 审计要求

所有操作都会被记录在 JSONL 格式的审计日志中：
- 案件创建/删除
- 文件上传
- 验证操作
- 文件导出
- 访问请求

**审计日志的保留期限**：与文件保留期限相同。