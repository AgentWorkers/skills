---
name: ci-whisperer
description: "分析 GitHub Actions 的失败原因并提出修复方案。当用户提供失败的 GitHub Actions 运行 URL 或 ID、表示“持续集成（CI）失败”、询问“为什么这个工作流会失败”、希望获取日志摘要、希望进行最小化的修复，或者希望自动创建一个 Pull Request 来解决该问题时，可以使用此方法。通过使用 GitHub CLI (`gh`) 和 GitHub API，可以安全地获取运行元数据和日志，并生成一份简洁的根源原因及下一步操作的报告。"
---
# CI Whisperer

该工具用于获取 GitHub Actions 的运行详情，定位故障原因，并提供简单的修复建议。

这个工具的设计目的是让使用者能够像资深工程师一样快速地进行“CI 自动诊断”。

## 模式

### 只读模式（默认）
- 收集故障证据，分析根本原因，并提出修复方案。
- **禁止提交代码、创建 Pull Request（PR）或分支。**

### PR 修复模式（可选）
只有满足以下两个条件时，才能使用 PR 修复模式：
1) 用户明确请求创建 PR。
2) 用户启用了相应的开关（“on/off 按钮”）：
   - 环境变量：`CI_WHISPERER_WRITE=1`

如果开关未启用，请礼貌地拒绝用户的请求，并说明如何启用它。

## 工作流程

### 1) 确定目标运行任务
可以接受以下信息：
- 工作流运行任务的 URL
- 运行任务的 ID
- PR 编号（然后查找最新的运行记录）

必须确定以下信息：
- 任务的所有者（owner）和仓库（repo）
- 运行任务的 ID

如果用户未指定仓库，请询问或根据上下文推断。

### 2) 收集故障证据（依赖工具辅助）
优先使用可靠的工具进行数据收集。当系统中存在多个 `gh` 命令时，建议使用 `/usr/bin/gh`。

建议使用的命令：
- `gh run view <run-id> --repo owner/repo --json status,conclusion,createdAt,updatedAt,event,headBranch,headSha,url,name`
- `gh run view <run-id> --repo owner/repo --log-failed`
- `gh run view <run-id> --repo owner/repo --log`（仅在必要时使用；该命令可能会输出大量信息）

如果用户未进行身份验证，请停止操作并要求用户执行以下命令：
- `/usr/bin/gh auth login`

### 3) 生成“CI 自动诊断”报告
报告内容包括：
- 失败的任务及其具体步骤
- 失败的具体错误信息（仅显示关键部分，隐藏敏感信息）
- 可能的根本原因（按严重程度排序）
- 最简单的修复方案
- 修复方案的可靠性评估

### 4) （可选）创建 PR（需用户明确同意且开关处于开启状态）
如果用户请求修复且 `CI_WHISPERER_WRITE=1`，则执行以下操作：
- 创建一个新的分支
- 应用最简单的修复代码
- 如果有测试工具，运行本地测试
- 创建 PR 并附上详细的描述以及指向失败运行任务的链接

如果用户请求修复但开关处于关闭状态：
- 提供修复所需的代码修改内容，但禁止直接推送代码。

## 安全性注意事项
- 绝不要打印用户的访问令牌（tokens）。
- 除非用户明确要求，否则禁止创建 PR 或推送任何代码更改。
- 如果日志中包含敏感信息，在引用日志内容前请先删除这些信息。

## 集成脚本
使用以下脚本实现重复性的数据获取和解析操作：
- `scripts/ci_autopsy.py`（用于获取运行任务元数据和失败日志）