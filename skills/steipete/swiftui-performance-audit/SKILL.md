---
name: swiftui-performance-audit
description: 通过代码审查和架构设计来审计并提升 SwiftUI 应用的运行性能。该方法可用于诊断以下问题：渲染速度缓慢、滚动效果不佳、CPU/内存使用过高、视图更新过于频繁，以及布局更新导致的性能问题。同时，当仅依赖代码审查时，该方法还能为用户提供的 Instruments 分析工具提供使用指导。
---

# SwiftUI 性能审计

## 来源：复制自 @Dimillian 的 `Dimillian/Skills`（2025-12-31）。

## 概述

本文档用于端到端地审计 SwiftUI 视图的性能，包括性能监控、基准测试、根本原因分析以及具体的修复步骤。

## 工作流程决策树

- 如果用户提供了代码，请先进行“代码优先审查”（Code-First Review）。
- 如果用户仅描述了问题症状，请要求用户提供最少的代码或上下文信息，然后进行“代码优先审查”。
- 如果代码审查无法得出明确结论，请引导用户使用性能分析工具进行性能分析，并要求提供相关的数据跟踪记录或截图。

## 1. 代码优先审查（Code-First Review）

收集以下信息：
- 目标视图/功能的代码。
- 数据流：状态、环境、可观察模型。
- 问题症状及重现步骤。

重点关注以下问题：
- 由于状态变化导致的视图失效问题。
- 列表中的对象身份不稳定（每次渲染时 `id` 或 `UUID` 的频繁变化）。
- `body` 部分执行了大量的计算任务（如格式化、排序、图像解码）。
- 布局更新过于频繁（导致堆栈深度过大，使用 `GeometryReader` 或偏好设置链）。
- 大尺寸图像在渲染时没有进行缩放或调整大小。
- 高级动画层次结构（大型视图树上的隐式动画）。

提供以下内容：
- 可能的根本原因及对应的代码位置。
- 建议的修复方案和代码重构方法。
- 如有需要，提供简单的重现步骤或性能监控建议。

## 2. 引导用户使用性能分析工具（Guide the User to Profile）

解释如何使用性能分析工具收集数据：
- 使用 SwiftUI 提供的性能分析模板（Release 版本）。
- 重现具体的交互行为（如滚动、导航、动画等）。
- 捕获 SwiftUI 的时间线数据及性能分析结果。
- 导出相关的数据或截图。

要求用户提供：
- SwiftUI 的性能分析数据以及时间线分析中的调用树。
- 设备/操作系统/构建版本的配置信息。

## 3. 分析与诊断

优先排查以下可能影响性能的问题：
- 由于状态变化导致的视图失效问题。
- 列表中的对象身份不稳定。
- `body` 部分执行了大量的计算任务。
- 布局更新过于频繁。
- 大尺寸图像在渲染时没有进行缩放或调整大小。
- 高级动画层次结构。

根据性能分析工具提供的数据总结问题原因。

## 4. 修复问题

应用针对性的修复措施：
- 缩小状态更新的范围（将 `@State`/`@Observable` 的作用域限制在更接近视图叶节点的部分）。
- 稳定列表中对象的身份（避免在循环中频繁更新对象的 `id`）。
- 将计算密集型任务移出 `body` 部分（提前计算结果、使用缓存）。
- 对于计算成本较高的子树，使用 `equatable()` 或值包装器。
- 在渲染前对图像进行缩放处理。
- 尽可能简化布局结构或使用固定大小的视图元素。

## 常见的代码问题及修复方法

在代码审查过程中注意以下问题及其对应的修复方案：

### `body` 部分存在计算成本较高的操作

**修复方法：**  
在模型中缓存计算结果，或使用专门的辅助函数来处理这些操作。

### 计算属性执行了大量计算

**修复方法：**  
在属性值发生变化时提前计算结果并缓存。

### 在 `body` 或 `ForEach` 中进行排序/过滤操作

**修复方法：**  
在视图更新之前先完成排序或过滤操作。

### 在 `ForEach` 中使用内联过滤

**修复方法：**  
使用预先过滤好的数据集，以确保对象的身份稳定。

### 对象身份不稳定

**修复方法：**  
对于不稳定的对象，避免使用 `id: \.self`；应使用稳定的标识符。

### 在主线程上解码图像

**修复方法：**  
将图像解码操作移到后台线程，并将结果存储在缓存中。

### 可观察模型中的依赖关系过于复杂

**修复方法：**  
使用更细粒度的视图模型或为每个元素维护独立的状态，以减少不必要的状态更新。

## 5. 验证修复效果

要求用户重新运行测试，并与基准数据对比性能指标。
如果提供了基准数据，总结性能变化的详细情况（如 CPU 使用率、帧率下降、内存峰值等）。

## 输出结果

提供以下内容：
- 简短的性能指标对比表（如有必要，可显示修改前后的数据）。
- 按影响程度排序的主要问题列表。
- 建议的修复方案及预估的修复工作量。

## 参考资料

根据用户提供的资料，添加 Apple 的官方文档和 WWDC 相关资源：
- 《使用性能分析工具优化 SwiftUI 性能》：`references/optimizing-swiftui-performance-instruments.md`
- 《理解并提升 SwiftUI 性能》：`references/understanding-improving-swiftui-performance.md`
- 《分析应用程序中的卡顿问题》：`references/understanding-hangs-in-your-app.md`
- 《揭秘 SwiftUI 性能优化技巧（WWDC23）》：`references/demystify-swiftui-performance-wwdc23.md`