---
name: sohopay
description: "使用 EIP-712 签名在 SOHO Pay 信用层发起支付。"
invocation: manual
require_confirmation: true
---
# SOHO Pay — 信用层支付

该技能通过使用 `spendWithAuthorization` EIP-712 流程，经由 SOHO Pay 的 `Creditor` 智能合约来协调支付过程。

**该技能仅能通过手动方式调用**，不得由模型自动触发。每次调用都需要用户的明确确认。

---

## 架构 — 三方分离

**SoHo 仅作为信用层服务使用**。它不负责保管、持有、生成或控制任何签名密钥或密钥片段，也不生成 EIP-712 签名。

所有 EIP-712 签名均来自用户或代理操作者（例如 Turnkey/Privy/Fireblocks 等 MPC 提供商，或用户钱包）拥有和控制的 **钱包签名器**。

该技能负责协调以下各方的交互：
- **钱包签名器** — 负责签名（由用户/操作者控制）
- **SoHo** — 进行信用检查及即时资金调配（仅限信用层操作）
- **区块链** — 完成交易结算

---

## 使用方法

| 参数          | 说明                                                         |
| ----------------- | ------------------------------------------------------------------ |
| `amount`          | 十进制 USDC 金额（例如 `10`、`0.5`）                             |
| `merchantAddress` | 带前缀 `0x` 的 EVM 地址（已进行校验）。**严禁使用地址名称**。 |
| `payerAddress`    | 当 `SIGNER_PROVIDER=WALLET_SIGNER_REMOTE` 时必须提供             |

### 示例 — 使用本地密钥的 Sepolia 环境（仅限开发使用）

### 示例 — 使用远程钱包签名器的 Sepolia 环境（生产环境模式）

---

## 工作流程

1. **配置验证** — 启动时使用 Zod 工具检查所有环境变量；未知的链地址将被拒绝。
2. **解析输入** — 验证金额和明确的商家地址（禁止根据名称生成地址）。
3. **信用检查** — SoHo 信用层会验证借款人的注册信息、活跃状态及信用额度。
4. **生成 EIP-712 签名** — 由钱包签名器（用户控制）生成签名；SoHo 本身不参与签名过程。
5. **提交交易** — 调用 `Creditor` 合约上的 `spendWithAuthorization` 函数。
6. **返回结果** — 交易哈希值及区块编号。

---

## 支持的网络

| 网络       | 链 ID | 状态                                     |
| ------------- | -------- | ------------------------------------------ |
| Base Sepolia  | 84532    | 支持                                      |
| Base Mainnet  | 8453     | 需设置 `SOHO_MAINNET_CONFIRM=YES`        |

在配置验证阶段，未知的链 ID 会被拒绝。

## 合约地址（Base Sepolia）

| 合约         | 地址                                      |
| ---------------- | -------------------------------------------- |
| Creditor         | `0x669324C8c8011c3C0cA31faFBdD9C76219C06dB1` |
| Borrower Manager | `0xFdcb4abf261944383dbac37cB8E9147E50E2a609` |
| USDC (test)      | `0x08B1797bB535C4cf86f93424137Cb3e004476624` |

---

## 安全模型

### 密钥保管规则

| 实体         | 角色                                 | 是否保管密钥？ |
| -------------- | ------------------------------------ | ----------- |
| **钱包签名器** | 生成 EIP-712 签名       | **是** — 由用户/操作者控制 |
| **SoHo**       | 负责信用授权及即时资金调配   | **否** — 仅作为信用层服务使用 |
| **本技能** | 负责协调上述各方的交互      | **否** — 仅传递输入数据给签名器 |

SoHo 绝不负责保管、持有、生成或控制任何签名密钥或密钥片段。

### 钱包签名器提供商

| 提供商                 | 使用场景                | 风险等级 |
| ------------------------ | -------------------------- | ---------- |
| `WALLET_SIGNER_REMOTE`  | **生产环境/主网**   | 低风险 — 密钥保存在用户的 MPC/HSM 中（如 Turnkey、Privy、Fireblocks 等） |
| `LOCAL_PRIVATE_KEY`      | **仅限开发/测试网**     | 高风险 — 密钥以原始形式保存在环境中 |

- **默认及推荐方案**：使用 `WALLET_SIGNER_REMOTE`。该技能会将 EIP-712 相关数据发送到用户的钱包签名服务，不会直接处理私钥。
- **仅限开发环境的备用方案**：`LOCAL_PRIVATE_KEY` 仅适用于测试网；在主网上使用需设置 `DEV_ALLOW_LOCAL_KEY=YES`，且强烈不建议这样做。

### 主网安全机制

在 Base Mainnet（`CHAIN_ID=8453`）上，除非设置了 `SOHO_MAINNET_CONFIRM=YES`，否则交易将被拒绝。这可防止开发过程中意外进行主网交易。

### 收件人地址规则

该技能 **绝不** 根据商家名称生成地址。`merchantAddress` 参数必须是一个明确、有效的、经过校验的 EVM 地址。任何非地址格式的输入都会被拒绝并返回错误。

### 调用规则

- **调用方式**：必须手动触发；不得自动执行。
- **需要用户确认**：执行前必须获得用户的确认。
- 如果环境变量 `SOHO_AUTONOMOUS` 被设置为 `true`，系统会拒绝执行。

---

## 威胁模型及应对措施

| 威胁            | 应对措施                                      |
| ---------------------- | ---------------------------------------- |
| **签名器被攻破**     | 默认使用 `WALLET_SIGNER_REMOTE`（MPC/HSM）；密钥始终保存在用户的签名服务中；本地密钥仅限测试网使用。 |
| **重放攻击**     | 每笔交易使用随机生成的 32 字节随机数；设置 `validAfter`/`expiry` 时间限制（10 分钟）；在 `Creditor` 合约中进行链上验证。 |
| **错误的商家地址**     | 禁止根据名称生成地址；仅接受经过校验的 EVM 地址；签名前会进行地址验证。 |
| **意外触发主网交易**     | 在链 ID 为 8453 的情况下，必须设置 `SOHO_MAINNET_CONFIRM=YES`。 |
| **自动调用**       | 在元数据中明确指定调用方式为手动；执行前必须获得用户确认。 |
| **SoHo 被误用作签名器**   | 架构设计确保 SoHo 仅负责信用层操作；技能不会将密钥传递给 SoHo API。 |
| **未声明的环境变量**     | 所有环境变量都必须在 `skill.json` 中明确声明，并指定类型和敏感级别。 |
| **钱包签名器服务被中间人攻击** | 使用 HTTPS 协议连接 `WALLET_SIGNER_SERVICE_URL`；通过 `SIGNER_SERVICE_AUTH_TOKEN` 进行令牌认证。 |

---

## 环境变量

### 所有模式均需设置的变量

| 变量          | 示例值                          | 说明                                      |
| ----------------- | -------------------------------- | ---------------------------------------- |
| `RPC_URL`         | `https://sepolia.base.org`       | JSON-RPC 服务端点                         |
| `CHAIN_ID`        | `84532`                          | Sepolia（84532）或 Mainnet（8453）                     |
| `SIGNER_PROVIDER` | `WALLET_SIGNER_REMOTE`           | 指定使用 `WALLET_SIGNER_REMOTE` 或 `LOCAL_PRIVATE_KEY`         |

### `WALLET_SIGNER_REMOTE` 需要设置的变量

| 变量                     | 说明                                          | 是否涉及敏感信息          |
| ---------------------------- | ---------------------------------------------------- | ------------------------- |
| `WALLET_SIGNER_SERVICE_URL`  | 用户/操作者钱包签名服务的 URL                 | 不涉及敏感信息     |
| `SIGNER_SERVICE_AUTH_TOKEN`  | 钱包签名服务的令牌认证                 | 必须设置                     |

### SoHo 信用层相关变量

| 变量       | 说明                                           | 是否涉及敏感信息          |
| -------------- | ----------------------------------------------------- | ------------------------- |
| `SOHO_API_URL` | SoHo 信用层 API 地址                          | 不涉及敏感信息     |

### `LOCAL_PRIVATE_KEY`（仅限开发/测试网）需设置的变量

| 变量               | 说明                                  | 是否涉及敏感信息          |
| ---------------------- | -------------------------------------------- | ------------------------- |
| `SOHO_DEV_PRIVATE_KEY` | 用户/操作者的原始十六进制私钥（非 SoHo 所有）         | 必须设置                     |

### 条件性变量

| 变量               | 设置条件                                      | ---------------------- | ------------------------- |
| `SOHO_MAINNET_CONFIRM` | 当 `CHAIN_ID` 为 8453 时必须设置为 `YES`            |                          |
| `DEV_ALLOW_LOCAL_KEY` | 如需在非测试网环境中使用本地密钥，请设置为 `YES`         |                          |

---

## 依赖项

请使用以下包进行安装：

| 包名        | 用途                                      |                          |
| -------------- | ---------------------------------------- | --------------------------- |
| `ethers`      | 用于与 EVM 交互及生成 EIP-712 签名                |                          |
| `dotenv`      | 用于加载 `.env` 配置文件                         |                          |
| `zod`       | 启动时验证环境变量                         |                          |