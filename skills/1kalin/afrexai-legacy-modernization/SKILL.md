# 遗留系统现代化引擎

这是一套完整的现代化方法论，用于评估、规划并执行遗留系统的现代化改造——从系统拆分到迁移至云端。适用于任何技术栈和任何规模的项目。

---

## 第1阶段：系统评估

### 现代化概述

```yaml
system_name: "[Name]"
age_years: 0
primary_language: ""
framework: ""
database: ""
deployment: "on-prem | VM | container | serverless"
lines_of_code: 0
team_size: 0
monthly_users: 0
annual_revenue_supported: "$0"
compliance_requirements: []
known_pain_points: []
business_driver: "cost | speed | talent | risk | compliance | scale"
timeline_pressure: "low | medium | high | critical"
budget_range: "$0-$0"
sponsor: ""
```

### 技术债务清单

对每个维度评分1-5分（1=严重问题，5=良好状态）：

| 维度 | 评分 | 依据 |
|---------|-------|---------|
| **代码质量** — 测试覆盖率、复杂性、代码重复 | | |
| **架构** — 代码耦合度、模块化程度、边界清晰度 | | |
| **基础设施** — 部署自动化、监控能力、扩展性 | | |
| **依赖关系** | 过时库、已终止支持的框架、安全漏洞 | | |
| **数据** | 数据库模式质量、迁移历史、备份/恢复机制 | | |
| **文档** | 文档的准确性、完整性、新员工的培训效果 | | |
| **运维** | 部署频率、平均故障恢复时间、故障发生率 | | |
| **安全性** | 认证机制、加密措施、审计追踪能力 | | |
| **开发体验** | 构建时间、本地开发环境、调试工具 | | |
| **业务逻辑** | 业务规则的文档化程度、逻辑部分的测试覆盖率 | | |

**总分：/50**

- **40-50分**：系统状况良好，需要逐步改进 |
- **30-39分**：系统逐渐老化，需要针对性地现代化改造 |
- **20-29分**：系统属于传统架构，需要系统化的现代化改造 |
- **10-19分**：系统状况严重，需要立即进行现代化改造或替换 |

### 依赖关系风险矩阵

对于每个主要依赖项：

```yaml
dependency: ""
current_version: ""
latest_version: ""
eol_date: ""  # End of life
security_vulns: 0  # Known CVEs
upgrade_difficulty: "trivial | moderate | hard | rewrite"
business_risk: "low | medium | high | critical"
alternatives: []
```

**优先级规则：**
- 在12个月内终止支持的依赖项 → P0 |
- 存在已知未修补的安全漏洞 → P0 |
- 依赖版本落后3个以上版本 → P1 |
- 无维护者 → P1 |
- 其他情况 → P2 |

---

## 第2阶段：策略选择

### 现代化策略决策矩阵

| 策略 | 适用场景 | 风险 | 成本 | 效率 | 干扰程度 |
|---------|-------------|------|------|-------|------------|
| **重新托管**（迁移并保持现有架构） | 需要离开现有数据中心，改动最小 | 低 | 低 | 快速 | 低 |
| **重新平台**（迁移并优化现有架构） | 利用云平台的优势，无需重写代码 | 低-中等 | 中等 | 中等 | 低-中等 |
| **重构**（调整代码结构） | 代码质量良好，但架构落后 | 中等 | 中等 | 中等 | 中等 |
| **重新设计**（彻底重构系统架构） | 将单体应用拆分为微服务 | 高 | 高 | 慢速 | 高 |
| **重建**（完全重写代码） | 系统规模较小，需求明确 | 非常高 | 非常高 | 非常慢 | 非常高 |
| **替换**（购买新的软件/使用SaaS服务） | 功能较为通用 | 中等 | 变化较大 | 快速 | 高 |
| **废弃** | 系统不再需要 | 无额外成本 | 无干扰 | 立即 | 低 |
| **保留**（不做任何改动） | 系统目前运行正常，但有其他优先事项 | 无持续改进需求 | 不适用 | 不适用 |

### 策略选择决策树

```
Is the system still needed?
├─ No → RETIRE
├─ Yes → Is it a commodity (CRM, email, etc.)?
│  ├─ Yes → REPLACE (buy SaaS)
│  └─ No → Is the code maintainable?
│     ├─ Yes → Is the architecture the problem?
│     │  ├─ Yes → RE-ARCHITECT (strangler fig)
│     │  └─ No → Is the infrastructure the problem?
│     │     ├─ Yes → REPLATFORM
│     │     └─ No → REFACTOR incrementally
│     └─ No → Is the system small (<50K LOC)?
│        ├─ Yes → Can requirements be clearly defined?
│        │  ├─ Yes → REBUILD
│        │  └─ No → REFACTOR + RE-ARCHITECT
│        └─ No → STRANGLER FIG (never big-bang rewrite)
```

### 避免全面重写的最佳实践

**切勿对大型系统进行全面的重写。** 这种方法失败的概率超过70%，原因如下：
1. 旧系统会不断添加新功能，导致目标不断变化；
2. 隐藏在代码中的业务规则容易被忽略；
3. 项目周期通常会比预期长2-3倍；
4. 过渡期间需要维护两个系统；
5. 团队可能在项目完成前就精疲力尽。

**最佳实践是采用“逐步替换”的方法。**

---

## 第3阶段：逐步替换（Strangler Fig）模式

### 实施步骤

1. **确定改造的边界** — 指定一个功能、页面或API接口；
2. **构建替代方案** — 使用新的技术栈和架构；
3. **路由请求** — 通过代理或外观层将请求转发到新旧系统；
4. **验证功能一致性** — 确保新旧系统的行为和数据一致；
5. **逐步替换** — 移除旧系统，停止使用旧代码；
6. **重复上述步骤** — 对下一个边界重复上述过程。

### Strangler Facade YAML 示例

```yaml
facade_name: "[API Gateway / Reverse Proxy / BFF]"
routing_rules:
  - path: "/api/users/*"
    target: "new-service"
    status: "migrated"
    migrated_date: "2025-01-15"
  - path: "/api/orders/*"
    target: "legacy"
    status: "planned"
    target_date: "2025-Q2"
  - path: "/api/reports/*"
    target: "legacy"
    status: "not-planned"
    notes: "Low priority, rarely used"
```

### 迁移顺序规则

1. 从最简单、最独立的模块开始迁移，建立信心；
2. 接着迁移价值最高的业务功能，尽早验证投资回报率；
3. 最后将最复杂、耦合度最高的模块留到最后处理；
4. **切勿过早迁移认证/身份验证部分** — 因这部分功能会影响整个系统的运行；
5. 在迁移业务逻辑之前，先迁移数据访问层；
6. **始终保留旧系统作为备用方案**，直到新系统稳定运行。

### 数据同步策略

| 方法 | 适用场景 | 复杂度 | 风险 |
|---------|------|-----------|------|
| **同时写入** | 两个系统同时写入数据 | 高 | 数据不一致的风险 |
| **CDC（变更数据捕获）** | 从旧数据库向新数据库实时传输数据变更 | 中等 | 数据延迟和顺序问题 |
| **ETL批量同步** | 定期批量同步数据 | 低 | 数据可能过时 |
| **事件源桥接** | 从旧系统捕获事件，并在新系统中重新处理 | 高 | 需要处理数据模式映射问题 |
| **从新系统读取数据，写入旧系统** | 过渡期间使用 | 中等 | 需要处理数据路由问题 |

**黄金法则：** 确保数据来源的唯一性。切勿让两个系统同时拥有相同的数据。

---

## 第4阶段：系统拆分

### 领域分析

在拆分单体应用之前，先明确各个功能的边界：

1. **事件风暴法**（推荐） — 使用便利贴记录相关事件、命令和数据聚合信息；
2. **代码分析** — 找出相关的类或表；
3. **团队分析** — 明确哪些团队负责哪些功能的开发；
4. **数据耦合分析** — 分析哪些表之间存在关联。

### Bounded Context YAML 示例

```yaml
context_name: ""
description: ""
team: ""
entities: []
commands: []
events_published: []
events_consumed: []
database_tables: []
external_integrations: []
coupling_score: 0  # 0=independent, 10=deeply coupled
extraction_difficulty: "easy | moderate | hard | very-hard"
business_value: "low | medium | high | critical"
```

### 功能提取优先级矩阵

根据**业务价值**（Y轴）和**提取难度**（X轴）来安排迁移顺序：

| | 易于提取 | 中等难度 | 难度较高 |
|---|---|---|---|
| **高价值功能** | 🟢 首先迁移 | 🟡 次要迁移 | 🟠 仔细评估后再迁移 |
| **中等价值功能** | 🟢 快速迁移 | 🟡 评估投资回报率后再迁移 | 🔴 可能不值得迁移 |
| **低价值功能** | 🟡 如果容易提取，可以迁移 | 🔴 跳过迁移 |

### 功能提取检查清单

对于每个需要迁移的服务，需确保：
- **边界明确**；
- **API接口设计完成**（遵循OpenAPI规范）；
- **数据库已分离**（避免数据共享）；
- **认证/授权机制已集成**；
- **具备跨服务通信的能力**；
- **具备回调到旧系统的机制**；
- **监控和警报机制已配置**；
- **部署流程独立**；
- **具备流量路由的控制机制**；
- **有回滚计划**；
- **性能基线已记录**（迁移前后对比）；
- **数据迁移脚本已测试**；
- **与旧系统的集成测试通过**；
- **有相应的操作手册**。

---

## 第5阶段：数据库现代化

### 数据库迁移策略

| 策略 | 描述 | 停机时间 | 风险 |
|---------|-------------|----------|------|
| **并行迁移** | 新数据库与旧数据库同时运行并同步数据 | 无停机时间 | 需要较高的技术复杂性 |
| **蓝绿部署** | 全量数据复制后切换DNS | 几分钟 | 中等风险 |
| **逐步迁移** | 逐表迁移数据 | 每张表迁移时几乎无停机时间 | 中等风险 |
| **一次性迁移** | 停止旧系统，然后迁移所有数据 | 需要较长时间 |

### 数据库模式演变规则

1. **始终采用增量式修改** — 每次版本更新只添加新列/表，绝不删除现有数据；
2. **分两阶段删除旧数据** — 第一阶段停止写入新数据；第二阶段删除旧数据；
3. **为所有新列设置默认值**；
4. **确保向后兼容** — 旧代码在新数据库模式下仍能正常运行；
5. **同步创建索引** — 在迁移过程中避免锁定生产数据库；
6. **使用真实生产数据测试** — 即使只有100条数据，也要进行真实环境下的测试。

### 数据质量检查

**迁移数据前必须通过以下检查：**

```yaml
table: ""
row_count_source: 0
row_count_target: 0
count_match: false
checksum_match: false
null_analysis: "pass | fail"
referential_integrity: "pass | fail"
business_rule_validation: "pass | fail"
sample_manual_review: "pass | fail"
performance_benchmark: "pass | fail"
rollback_tested: false
```

**规则：所有检查都必须通过才能进行迁移。** 无一例外。

---

## 第6阶段：云迁移

### 云平台适配性评估

对每个工作负载进行评估：

| 评估因素 | 评分（1-5分） | 备注 |
|--------|-------------|-------|
| **无状态设计** | | |
| **配置信息外部化** | | |
| **日志输出到标准输出流** | | |
 | 
| **具备优雅关闭机制** | | |
| **具备水平扩展能力** | | |
| ** secrets管理规范** | | |
| **符合12项云平台安全标准** | | |

**评分范围：**
- **35-40分**：系统已具备云原生平台的适配能力；
- **25-34分**：需要少量修改；
- **15-24分**：需要大规模重构；
- **8-14分**：需要彻底重新设计。

### 云迁移检查清单

- **网络架构设计完成**（VPC、子网、安全组配置）；
- **身份和访问管理机制已配置**；
- **数据存储要求已验证**；
- **合规性要求已满足**；
- **成本估算已完成**（包括总拥有成本）；
- **灾难恢复计划已更新**；
- **监控和警报机制已迁移**；
- **DNS和证书管理已配置**；
- **在云环境中进行了负载测试**；
- **备份和恢复机制已验证**；
- **操作手册已更新**；
- **团队已接受云平台的使用**；
- **评估了供应商的锁定风险**。

### 从第一天起优化成本

- **选择合适大小的云实例** — 根据实际需求选择实例规模；
- **按需预留资源** — 仅在系统使用三个月后开始按需扩展资源；
- **灵活使用资源** — 根据需求使用预留资源（如批量作业、持续集成/持续交付、开发/测试环境）；
- **自动扩展** — 在夜间或周末自动调整资源使用量；
- **根据访问模式划分存储层次**；
- **为所有资源分配标签**，便于成本管理；
- **每月审查资源使用情况**，及时释放闲置资源或调整实例规模。

---

## 第7阶段：API现代化

### 针对无API的遗留系统的API现代化方案

1. **屏幕抓取适配器** — 解析旧系统的HTML界面；
2. **直接从旧数据库读取数据**（仅限读取权限）；
3. **基于文件的集成** — 监控文件变化并解析文件内容；
4. **消息队列中间件** — 将旧系统的写入操作放入消息队列，新系统从队列中读取数据；
5. **RPC封装** — 通过REST或gRPC接口暴露旧系统的功能。

### API合同优先的迁移策略

```yaml
endpoint: "/api/v2/orders"
legacy_source: "stored_procedure: sp_GetOrders"
new_implementation: "orders-service"
migration_status: "legacy | dual-run | new-only"
contract_changes:
  - field: "order_date"
    old_format: "MM/DD/YYYY string"
    new_format: "ISO 8601"
    adapter: "date_format_adapter"
  - field: "status"
    old_values: ["A", "C", "P"]
    new_values: ["active", "completed", "pending"]
    adapter: "status_code_mapper"
parity_tests: 47
parity_passing: 47
```

---

## 第8阶段：测试策略

### 迁移测试流程

### 并行测试框架

对于每个迁移的功能，都需要进行并行测试：

```yaml
feature: ""
test_type: "api_parity | ui_parity | data_parity"
method: "shadow traffic | replay | parallel run"
sample_size: 0
match_rate: "0%"  # Target: 99.9%+
mismatches_investigated: 0
mismatches_accepted: 0  # Known intentional differences
mismatches_bugs: 0
sign_off: false
```

**影子流量测试** — 将生产环境的请求复制到新系统，并比较新旧系统的响应结果（此时不要向用户提供新系统的响应）。

### 性能回归测试规则

- 新系统的延迟不得超过旧系统的95%；
- 在相同负载下，新系统的吞吐量必须达到或超过旧系统的水平；
- 每个请求的数据库查询次数不得增加；
- 内存使用量不得超过旧系统的20%；
- 如果有任何指标出现退步，必须在进行下一步操作之前进行调查。

---

## 第9阶段：团队与流程管理

### 现代化团队架构

| 角色 | 责任 | 需要参与的时间 |
|------|---------------|-------------|
| **现代化项目负责人** | 制定策略、安排迁移顺序、解决阻碍因素 | 全职 |
| **遗留系统专家** | 了解系统的现状和潜在问题 | 兼职，随时待命 |
| **新平台工程师** | 负责构建新系统的架构 | 全职 |
| **数据工程师** | 负责数据迁移、数据同步和验证 | 根据项目阶段需求参与 |
| **质量保证/测试工程师** | 负责并行测试和自动化测试 | 全职 |
| **DevOps/平台工程师** | 负责持续集成/持续交付和基础设施维护 | 兼职 |
| **产品负责人** | 确定业务优先级和验收标准 | 全职 |

### 从遗留系统中提取有价值的信息

现代化过程中最危险的部分是**丢失未文档化的业务规则**。以下是获取这些规则的方法：
1. **代码分析** — 通过git blame工具查找最古老的未修改代码，并理解其用途；
2. **访谈利益相关者** — 询问“如果修改某个功能会导致什么问题”；
3. **分析生产日志** — 了解实际发生的边缘情况；
4. **审查错误处理逻辑** — 每个错误处理逻辑都代表了某种业务规则；
5. **检查测试用例** — 确保测试用例能够覆盖所有可能的业务场景；
6. **审查配置文件** — 检查配置文件中的特殊参数和功能开关。

### 沟通计划

| 对象 | 沟通频率 | 内容 |
|---------|-----------|---------|
| **高层管理者** | 每两周一次 | 项目进展、风险、预算、时间表 |
| **工程团队** | 每周一次 | 项目进度、技术决策、遇到的问题 |
| **依赖团队** | 每月一次 | 即将进行的变更、迁移计划、API变更信息 |
| **最终用户** | 每次迁移时 | 了解变更内容、变更时间、对用户的影响 |

---

## 第10阶段：风险管理

### 常见的风险及应对措施

### 常见的风险（预先制定好的应对措施）

| 序号 | 风险 | 发生概率 | 影响程度 | 应对措施 |
|------|------|-----------|--------|------------|
| 1 | 丢失未文档化的业务规则 | 高 | 非常严重 | 通过代码分析、访谈利益相关者和并行测试来避免 |
| 2 | 项目进度估计错误 | 非常高 | 高 | 通过制定详细的项目计划和阶段性检查点来避免 |
| 3 | 数据迁移过程中数据损坏 | 中等 | 通过校验和机制、并行迁移和回滚计划来避免 |
| 4 | 功能之间的兼容性问题 | 高 | 通过影子流量测试和用户验收测试来避免 |
| 5 | 团队成员流失 | 中等 | 高 | 通过详细记录所有信息、采用结对编程和知识共享来避免 |
| 6 | 迁移过程中遗留系统出现变化 | 中等 | 高 | 通过冻结相关功能或使用双重写入机制来避免 |
| 7 | 性能下降 | 中等 | 高 | 在每个阶段进行负载测试并设置性能预算来避免 |
| 8 | 项目范围不断扩大 | 非常高 | 在迁移过程中严格遵循“先迁移、不改进”的原则来避免 |

### 终止现代化改造的判断标准

如果出现以下情况，应停止现代化改造：
- 预算超出初始预算的2倍，且改造完成度低于50%；
- 迁移后无法验证关键的业务规则；
- 团队在项目进行过程中流失超过30%的成员；
- 由于迁移导致遗留系统的稳定性下降；
- 业务环境发生变化（如公司合并、业务方向调整等）。

**如果出现上述情况，应稳定现有系统，记录所有经验教训，并在6个月后重新评估是否继续进行现代化改造。**

---

## 第11阶段：技术模式与操作手册

### 不同语言/框架的现代化改造方案

### Java → 现代Java（8→17版本）**

- 使用新的类库和模式匹配机制；
- 使用虚拟线程（如Project Loom）来处理每个请求；
- 更新构建工具（例如从Maven升级到Gradle，或更新Maven插件）；
- 将Spring Boot 2升级到Spring Boot 3，并修改命名空间。

### Python 2 → Python 3**

- 使用`2to3`工具进行自动化转换；
- 修复一些Python 2中的老旧代码（如`print()`函数、除法运算、unicode处理、字典相关的方法）；
- 确保依赖库与Python 3兼容。

### jQuery → React/Vue**

- 从页面中提取可复用的组件；
- 用状态管理替代DOM操作；
- 将事件处理逻辑封装成组件方法；
- 将Ajax请求替换为API调用。

### 单体应用 → 微服务

- 采用逐步替换的方法（如Strangler Fig模式）；
- 先处理数据相关的功能；
- 先迁移无状态的服务；
- 最后迁移共享数据库。

### 从本地部署环境 → 云平台

- 首先进行重新托管（迁移并保持现有架构）；
- 然后进行平台迁移（优化现有服务）；
- 最后进行架构重构（采用云原生模式）；
- 请务必按照上述步骤逐步进行，每个步骤都有其价值。

### COBOL/大型机系统的现代化改造

- 使用API封装技术将CICS/IMS系统的交易暴露为REST API；
- 自动化处理与终端的交互；
- 逐步迁移数据（一次处理一个交易）；
- 将数据库从DB2/VSAM迁移到PostgreSQL或云数据库；
- 将COBOL代码中的业务规则提取出来并单独管理；
- **切勿一次性全部重写代码**，因为旧系统中可能存在大量的边缘情况。

### 应避免的错误做法

### 应避免的现代化改造错误做法

| 错误做法 | 表现症状 | 应对措施 |
|-------------|---------|-----|
| **将所有服务部署在一起** | 应将相关服务分开部署 | 需要识别并解除代码之间的耦合 |
| **多个服务共享同一个数据库** | 应为每个服务分配独立的数据库 | |
| **服务之间的调用顺序固定** | 应根据实际需求调整调用顺序 | |
| **创建大量微服务** | 应将相关的服务合并 | |
| **使用共享库处理业务逻辑** | 应为每个服务分配独立的数据库 | |
| **不使用API版本控制** | 应为每个API版本设置版本号并逐步淘汰旧版本 | |

---

## 第12阶段：指标与报告

### 现代化改造健康状况监控仪表盘

### 现代化改造质量评估标准

| 评估维度 | 权重 | 评分（0-10分） | 加权得分 |
|---------|--------|-------------|----------|
| 策略的清晰度 | 15% | |
| 风险管理 | 15% | |
| 测试的严谨性 | 15% | |
| 数据的完整性 | 15% | |
| 架构质量 | 10% | |
| 团队的能力 | 10% | |
| 利益相关者的参与度 | 10% | |
| 文档的完整性 | 10% | |
| **总分** | 100% | |

**评分范围：**
- **90-100分**：项目表现优异，可作为参考；
- **70-89分**：需要改进；
- **50-69分**：存在不足，需要进一步优化；
- **低于50分**：存在严重问题，需要暂停并重新评估。

### 周度项目进度报告模板

---

## 特殊情况处理

### 常见问题及应对策略

**“我们需要现代化改造，但又无法停止添加新功能”**

- 采用逐步替换的方法，围绕新功能逐步进行现代化改造；
- 在迁移某个模块时，暂时冻结该模块的功能开发；
- 新功能从一开始就使用新的技术栈进行开发。

**“我们不清楚系统的具体功能”**

- 先使用日志记录、跟踪和分析系统行为；
- 运行系统2-4周，了解实际的使用情况；
- 通过代码覆盖率分析确定哪些代码被实际使用；
- 采访经验最丰富的团队成员，了解系统的实际运行情况。

**“多个系统需要同时进行现代化改造”**

- 按照依赖关系的顺序进行迁移；
- 共享的服务（如认证、数据服务）先进行现代化改造；
- 同时进行的现代化改造步骤不要超过两个。

**“原始开发人员已经离职”**

- 将现有代码视为系统的文档；
- 在进行任何迁移工作之前，花2-4周时间研究现有代码；
- 新开发人员应与业务团队合作；
- 在进行任何修改之前，先为现有功能编写测试用例。

**“我们正在合并系统”**

- 先确定各个系统的功能边界；
- 为每个系统选择合适的现代化方案；
- 在合并系统之前，先实现系统的接口集成；
- 设定18个月的合理迁移时间表。

**“合规性要求保留旧系统”**

- 在迁移过程中确保系统的合规性；
- 在整个迁移过程中，同时进行两次合规性审计；
- 从一开始就让合规性团队参与迁移规划；
- 记录旧系统和新系统之间的控制逻辑映射关系。

### 常用命令

| 命令 | 功能 |
|---------|--------|
| “评估该系统的现代化改造可行性” | 运行技术债务清单 |
| “我们应该选择哪种现代化改造策略？” | 使用策略决策树进行决策 |
| “制定逐步替换的迁移计划” | 生成相应的操作手册和迁移顺序 |
| “拆分这个单体应用” | 进行领域分析和边界定义 |
| “迁移这个数据库” | 进行数据质量检查和迁移策略规划 |
| “评估系统的云平台适配性” | 运行云平台适配性评估 |
| “制定迁移测试计划” | 生成详细的测试计划 |
| “这个现代化改造项目的情况如何？” | 运用质量评估标准进行评估 |
| “我们应该终止这个现代化改造项目吗？” | 根据判断标准进行决策 |

---

这些文档提供了从系统评估到迁移完成的全过程指导，涵盖了技术细节、团队管理、风险控制等多个方面。