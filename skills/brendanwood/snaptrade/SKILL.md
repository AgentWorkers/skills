---
name: snaptrade-portfolio
description: 通过 SnapTrade SDK 连接到用户的投资账户，并生成投资组合报告（例如每日总价值）。适用于用户需要基于 SnapTrade 的经纪服务连接（如 Webull、E*TRADE 等）、账户注册功能或自动化投资组合汇总的情况。
---

# SnapTrade 投资组合管理工具

## 概述  
通过 SnapTrade 连接各个经纪商账户，并生成每日投资组合的总价值报告。该工具使用了官方的 SnapTrade Python SDK（`snaptrade_client`），请求签名过程由 SDK 自动处理。

## 工作流程  

### 2d) 下单（买入/卖出股票/ETF）  
运行以下命令：  
```
python3 scripts/snaptrade_order.py buy|sell TICKER UNITS --account-id <ACCOUNT_ID> [--order-type market|limit] [--limit-price <PRICE>] [--tif Day|GTC|IOC|FOK]
```  
默认参数：  
- 订单类型：**市价单（market）**  
- 有效时间：**一天（Day）**  
- 限价：仅限限价单需要设置  

可选功能：监控订单状态（每隔 **10 秒** 检查一次订单状态，最长持续 **120 秒**）：  
```
python3 scripts/snaptrade_order.py buy|sell TICKER UNITS --account-id <ACCOUNT_ID> --watch
```  
- 可通过 `--watch-interval` 和 `--watch-seconds` 参数调整检查间隔。  

通过订单 ID 监控订单状态：  
```
python3 scripts/snaptrade_watch_order.py --account-id <ACCOUNT_ID> --order-id <BROKERAGE_ORDER_ID>
```  
- 同样使用默认的 10 秒/120 秒的间隔，可通过 `--watch-interval` 和 `--watch-seconds` 参数调整。  

使用 **account_orders` 端点** 在用户请求时确认订单成交情况，并报告未成交的订单。  

### 0) 创建 SnapTrade 账户及 API 密钥  
您需要一个 SnapTrade 账户来连接经纪商。请在 **https://snaptrade.com** 注册免费账户，生成 **客户端 ID**（Client ID）和 **消费者密钥**（Consumer Key），并将其添加到工具配置中。  

### 1) 安装依赖项  
```
pip3 install -r requirements.txt
```  

### 2) 配置凭据（一次性设置）  
将凭据存储在本地配置文件中（该文件不会被提交到代码仓库）。`user_id` 会在首次运行时自动生成：  
```
/home/openclaw/.openclaw/workspace/secrets/snaptrade.json
```  

示例配置：  
```
{
  "client_id": "YOUR_CLIENT_ID",
  "consumer_key": "YOUR_CONSUMER_KEY",
  "user_id": "<auto-generated-uuid>"
}
```  

### 2) 注册用户并生成连接门户链接  
运行以下命令：  
```
python3 scripts/snaptrade_portal.py
```  
该命令会：  
- 如果缺少 `user_secret`，则完成用户注册；  
- 将 `user_secret` 保存回配置文件；  
- 打印用户用于连接经纪商账户的门户链接。  

### 2b) 重新连接已禁用的账户  
运行以下命令：  
```
python3 scripts/snaptrade_reconnect.py [brokerage-name]
```  
该命令会：  
- 列出所有被禁用的账户；  
- 生成重新连接的链接（可选，可按经纪商名称筛选）；  
- 打印用户用于重新连接的链接。  

### 2c) 列出可使用的经纪商（允许连接的账户）  
运行以下命令：  
```
python3 scripts/snaptrade_brokers.py
```  
该命令会调用 `/snaptrade/partners` 接口，返回允许使用的经纪商列表（显示名称）。  

### 3) 获取投资组合总价值  
运行以下命令：  
```
python3 scripts/snaptrade_total.py
```  
输出结果为 JSON 格式：  
```
{"total_value": 123456.78, "currency": "CAD"}
```  

**实现说明：**  
脚本首先列出所有已连接的经纪商信息，以识别被禁用的账户（这些账户会被跳过，但仍会显示其最后的账户余额）。接着，脚本会等待已启用账户的同步时间戳更新。随后，通过 `list_user_accounts` 获取所有未关闭的账户信息，并使用 `get_user_holdings` 方法读取每个账户的 `account.balance.total` 值。被禁用的账户会以 `disabled_connections` 的形式显示在输出结果中。  

### 4) 定时生成每日报告  
使用 cron 任务定期运行 `snaptrade_total.py` 脚本，生成简洁的 WhatsApp 消息并发送给用户。报告内容仅包含投资组合的总价值。  

## 相关脚本：  
- `scripts/snaptrade_common.py`：配置文件读写及客户端创建  
- `scripts/snaptrade_portal.py`：用户注册及连接门户链接生成  
- `scripts/snaptrade_reconnect.py`：为被禁用的账户生成重新连接链接  
- `scripts/snaptrade_brokers.py`：列出当前客户端可使用的经纪商  
- `scripts/snaptrade_order.py`：下达买入/卖出订单（市价单/限价单），支持订单状态监控  
- `scripts/snaptrade_watch_order.py`：通过订单 ID 监控订单状态  
- `scripts/snaptrade_total.py`：计算所有账户的投资组合总价值  

## 注意事项：  
- 请求签名通过 SDK 的 `request_after_hook` 机制完成，使用 `consumer_key` 进行身份验证。  
- 投资组合总价值是通过累加所有账户的 `account.balance.total` 计算得出的，这样可以避免账户添加或删除时出现错误。  
- 如果存在多种货币，脚本会使用首次遇到的货币进行计算。  
- 请将敏感信息（如 API 密钥）保存在具有 `chmod 600` 权限的本地配置文件中。