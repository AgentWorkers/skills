---
name: snaptrade-portfolio
description: 通过 SnapTrade SDK 连接到用户的投资账户，并生成投资组合报告（例如每日总价值）。适用于用户需要基于 SnapTrade 的经纪服务连接（如 Questrade 等）、账户注册功能或自动化投资组合汇总的情况。
---

# SnapTrade 投资组合管理

## 概述  
通过 SnapTrade 连接经纪商账户，并生成每日总资产报告。该功能使用官方的 SnapTrade Python SDK（`snaptrade_client`），请求签名过程由 SDK 自动处理。

## 工作流程  

### 0) 安装依赖项  
```
pip3 install -r requirements.txt
```  

### 1) 配置凭据（仅一次）  
将凭据存储在本地配置文件中（不会被提交到代码仓库）。`user_id` 在首次运行时自动生成：  
```
/home/openclaw/.openclaw/workspace/secrets/snaptrade.json
```  

示例：  
```
{
  "client_id": "YOUR_CLIENT_ID",
  "consumer_key": "YOUR_CONSUMER_KEY",
  "user_id": "<auto-generated-uuid>"
}
```  

### 2) 注册用户 + 生成连接门户链接  
运行以下命令：  
```
python3 scripts/snaptrade_portal.py
```  
该命令会：  
- 如果缺少 `user_secret`，则注册用户；  
- 将 `user_secret` 保存回配置文件；  
- 打印用户需要打开的连接门户 URL。  

### 2b) 重新连接已禁用的账户  
运行以下命令：  
```
python3 scripts/snaptrade_reconnect.py [brokerage-name]
```  
该命令会：  
- 列出所有已禁用的账户；  
- 生成重新连接的链接（可选：按经纪商名称筛选）；  
- 打印用户用于重新连接的 URL。  

### 2c) 列出可使用的经纪商（允许连接的账户）  
运行以下命令：  
```
python3 scripts/snaptrade_brokers.py
```  
该命令会调用 `/snaptrade/partners` 并返回 `allowed_brokerages` 列表（显示名称）。  

### 3) 获取投资组合总资产  
运行以下命令：  
```
python3 scripts/snaptrade_total.py
```  
输出结果为 JSON 格式：  
```
{"total_value": 123456.78, "currency": "CAD"}
```  

**实现说明：**  
脚本首先列出所有已授权的经纪商信息，以识别已禁用的账户（这些账户会被跳过，但仍会显示其最后的余额）；然后等待已启用账户的同步时间戳更新。接着，通过 `list_user_accounts` 函数遍历所有当前未关闭的账户，并使用 `get_user_holdings` 函数获取每个账户的 `account.balance.total` 值。已禁用的账户会以 `disabled_connections` 的形式包含在输出结果中。  

### 4) 安排每日报告任务  
使用 cron 任务定期运行 `snaptrade_total.py` 脚本，生成简洁的 WhatsApp 消息并发送给用户。报告仅包含总资产信息。  

## 相关脚本：  
- `scripts/snaptrade_common.py`：配置文件加载/保存及客户端创建  
- `scripts/snaptrade_portal.py`：用户注册及连接门户链接生成  
- `scripts/snaptrade_reconnect.py`：为已禁用的账户生成重新连接链接  
- `scripts/snaptrade_brokers.py`：列出该用户可使用的经纪商  
- `scripts/snaptrade_total.py`：计算所有账户的总资产  

## 注意事项：  
- 请求签名过程由 SDK 通过 `request_after_hook` 和 `consumer_key` 处理。  
- 总资产是通过汇总所有账户的 `account.balance.total` 值计算得出的，这样可以避免账户添加或删除时产生的错误。  
- 如果存在多种货币，脚本会使用首次遇到的货币进行计算。  
- 请将敏感信息（如凭据）保存在具有 `chmod 600` 权限的本地配置文件中。