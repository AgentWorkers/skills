---
name: snaptrade-portfolio
description: 通过 SnapTrade SDK 连接到用户的投资账户，并生成投资组合报告（例如每日总价值）。适用于用户需要基于 SnapTrade 的经纪服务连接（如 Webull、E*TRADE 等）、账户注册功能或自动化投资组合汇总的情况。
---

# SnapTrade投资组合

## 概述
通过SnapTrade连接经纪账户，并生成每日总价值报告。该技能使用官方的SnapTrade Python SDK（`snaptrade_client`），请求签名功能由SDK自动处理。

## 工作流程

### 2d) 下单（股票/ETF）
运行：
```
python3 scripts/snaptrade_order.py buy|sell TICKER UNITS --account-id <ACCOUNT_ID> [--order-type market|limit] [--limit-price <PRICE>] [--tif Day|GTC|IOC|FOK]
```
默认参数：
- 订单类型：**市价**
- 有效时间：**当日**
- 限价：仅限限价订单需要设置

可选的订单监控功能（每隔一定时间检查最新订单）：
```
python3 scripts/snaptrade_order.py buy|sell TICKER UNITS --account-id <ACCOUNT_ID> --watch
```
- 默认每**10秒**检查一次，最多检查**120秒**
- 可通过`--watch-interval`和`--watch-seconds`参数进行调整

通过订单ID监控现有订单：
```
python3 scripts/snaptrade_watch_order.py --account-id <ACCOUNT_ID> --order-id <BROKERAGE_ORDER_ID>
```
- 同样默认每10秒/120秒检查一次，可通过`--watch-interval`和`--watch-seconds`参数进行调整

使用**账户订单接口**在用户请求时确认订单成交情况，并报告未成交的订单。

### 0) 创建SnapTrade账户 + 获取API密钥
您需要一个SnapTrade账户来连接经纪商。请在**https://snaptrade.com**注册一个免费账户，生成您的**客户端ID**和**消费者密钥**，然后将其添加到技能配置中。

### 1) 安装依赖项
```
pip3 install -r requirements.txt
```

### 2) 配置凭据（一次性设置）
将凭据存储在本地配置文件中（不会被提交到代码仓库）。`user_id`在首次运行时自动生成：

```
/home/openclaw/.openclaw/workspace/secrets/snaptrade.json
```

示例：
```
{
  "client_id": "YOUR_CLIENT_ID",
  "consumer_key": "YOUR_CONSUMER_KEY",
  "user_id": "<auto-generated-uuid>"
}
```

### 2) 注册用户 + 生成连接门户链接
运行：
```
python3 scripts/snaptrade_portal.py
```

此操作将：
- 如果缺少`user_secret`，则完成用户注册
- 将`user_secret`保存回配置文件
- 打印用户需要打开的**连接门户URL**以链接各个账户

### 2b) 重新连接已禁用的账户
运行：
```
python3 scripts/snaptrade_reconnect.py [brokerage-name]
```

此操作将：
- 列出所有已禁用的连接
- 生成重新连接的链接（可选，可按经纪商名称进行筛选）
- 打印用户用于重新连接的**链接**

### 2c) 列出可用的经纪商（允许连接的经纪商）
运行：
```
python3 scripts/snaptrade_brokers.py
```

该命令会调用 `/snaptrade/partners` 接口，返回`allowed_brokerages` 列表（显示名称）。

### 3) 获取投资组合总价值
运行：
```
python3 scripts/snaptrade_total.py
```

输出格式为JSON：
```
{"total_value": 123456.78, "currency": "CAD"}
```

### 3b) 按经纪商划分的总价值（转换后的货币）
运行：
```
python3 scripts/snaptrade_broker_totals.py --currency CAD
```

输出JSON中包含按经纪商划分的总价值以及使用的汇率。

**实现说明：**
- 尽量避免使用`get_user_holdings`接口；优先使用`get_user_account_positions`接口获取持仓数据。只有在用户明确要求时，才需要获取持仓的余额/现金信息。

### 4) 安排每日报告
使用cron任务定期运行`snaptrade_total.py`脚本，生成简洁的WhatsApp消息并发送给用户。只需报告总价值即可。

## 脚本
- `scripts/snaptrade_common.py` — 配置文件加载/保存 + 客户端创建
- `scripts/snaptrade_portal.py` — 注册用户 + 生成连接门户链接
- `scripts/snaptrade_reconnect.py` — 为已禁用的账户生成重新连接链接
- `scripts/snaptrade_brokers.py` — 显示该客户可使用的经纪商列表
- `scripts/snaptrade_order.py` — 下单（市价/限价），支持可选的订单监控功能
- `scripts/snaptrade_watch_order.py` — 通过订单ID监控订单成交情况
- `scripts/snaptrade_total.py` — 计算所有账户的总价值
- `scripts/snaptrade_brokertotals.py` — 按经纪商划分的总价值（包含汇率转换）

## 注意事项：
- 请求签名功能由SDK通过`request_after_hook`接口使用`consumer_key`进行处理。
- 总价值是通过汇总每个账户的`account.balance.total`计算得出的；这样可以避免在账户添加或删除时出现错误。
- 如果存在多种货币，脚本将使用首次遇到的货币进行计算。
- 请将敏感信息（如`user_secret`）存储在具有`chmod 600`权限的本地配置文件中。