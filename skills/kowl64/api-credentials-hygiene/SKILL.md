---
name: api-credentials-hygiene
description: 审计并加强 API 凭据管理（环境变量、分离存储、定期轮换凭据、最小权限原则、可审计性）。在集成服务或准备生产环境部署时使用这些措施，以确保敏感信息得到安全管理。
---

# API凭证管理：环境变量、凭证轮换、最小权限原则与可审计性

## 目的
加强对API凭证管理的审计和安全性（包括使用环境变量、分离凭证、制定轮换计划、遵循最小权限原则以及确保可审计性）。

## 使用场景
- 当需要增强该集成系统的凭证安全性，并将敏感信息移至环境变量中时。
- 需要为这些API设计低停机时间的凭证轮换方案时。
- 需要对系统的访问权限进行审计，明确每个凭证的用途时。
- 需要为项目创建环境变量映射文件及安全的`.env`模板时。
- 需要在开发环境和生产环境中分离凭证，并保留清晰的审计记录时。

## 不适用场景
- 当您试图未经授权获取凭证或绕过安全控制时。
- 当您需要法律/合规性审批时（本文档仅提供技术指导，不提供法律建议）。

## 输入内容
- 必需信息：
  - 集成系统/API的列表及其当前存储/使用凭证的位置。
  - 部署环境（本地开发环境、服务器、容器、n8n等）。
- 可选信息：
  - 当前的配置文件或被屏蔽的配置片段（`.env`文件、Compose配置文件、systemd配置文件、n8n凭证列表）。
  - 组织内部的规则（凭证轮换周期、凭证管理工具的偏好设置）。

## 输出内容
- 凭证映射表（服务 → 环境变量 → 权限范围 → 所有者 → 轮换周期）。
- 凭证轮换操作手册（包括具体步骤和回滚方案）。
- 最小权限检查清单及审计日志计划。
- 可选：`.env`模板（仅包含占位符）。

## 工作流程
1. 清点所有凭证：
   - 明确凭证的存储位置、使用场景及所有者。
2. 制定凭证分离策略：
   - 区分开发环境和生产环境；区分人工账户和服务账户；明确各集成系统的权限边界。
3. 将敏感信息移至环境变量或凭证管理工具中：
   - 创建环境变量映射表并更新配置方案（避免在代码或工作流程中直接使用原始凭证）。
4. 实施最小权限原则：
   - 为每个API列出所需操作的权限范围，并相应地限制用户权限。
5. 制定凭证轮换计划：
   - 如果支持双密钥机制，需规划密钥的轮换流程；确保轮换过程具有最低的停机时间；同时准备回滚方案。
6. 确保可审计性：
   - 明确需要记录的事件类型（如认证失败、令牌更新、凭证使用情况等）。
7. 在以下情况下请暂停操作并咨询相关人员：
   - 如果某些操作的具体步骤不明确；
   - 如果凭证注入方法不清楚；
   - 如果凭证轮换周期或所有者信息未指定。

## 输出格式
凭证映射表模板：

```text
CREDENTIAL MAP
- Integration: <name>
  - Env vars:
    - <VAR_NAME>: <purpose> (secret/non-secret)
  - Permissions/scopes: <list>
  - Used by: <service/workflow>
  - Storage: <secret manager/env var>
  - Rotation: <cadence> | <owner> | <procedure>
  - Audit: <what is logged and where>
```

如果需要提供模板，请输出`assets/dotenv-template.example`文件（其中仅包含占位符）。

## 安全性与特殊注意事项
- 绝不要直接输出真实的凭证信息、令牌或私钥，应使用占位符代替。
- 默认情况下，所有文件仅具有读取权限；除非用户明确要求修改文件，否则请以计划的形式提出修改建议。
- 除非有明确的需求，否则应避免设置过于宽泛的权限范围。

## 示例
- 输入：“n8n HTTP节点中直接硬编码了API凭证。”
  输出：环境变量映射表 + 将凭证移至n8n系统的计划 + 凭证轮换操作手册。

- 输入：“需要区分开发环境和生产环境中的凭证管理。”
  输出：两个环境变量映射表 + 适当的命名规则 + 权限边界检查清单。