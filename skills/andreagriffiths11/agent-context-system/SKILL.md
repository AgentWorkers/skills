---
name: agent-context-system
description: 这是一个专为AI编码代理设计的、仅限本地使用的持久性内存系统。系统由两个文件组成：`AGENTS.md`（已提交到版本控制系统，可供团队成员共享）和`.agents.local.md`（被Git忽略，属于个人数据）。代理在会话开始时读取这两个文件，在会话结束时更新临时存储的数据，并逐渐形成稳定的工作模式。该系统兼容Claude Code、Cursor、Copilot、Windsurf等工具，同时支持子代理的集成。整个系统无需任何插件、基础设施或后台进程即可正常运行。
license: MIT
metadata:
  author: AndreaGriffiths11
  version: "1.3.1"
  requires:
    bins:
      - bash
---

# 代理上下文系统

## 问题

每次会话开始时，代理都会从零状态开始。你可能需要花费一个小时来让编程代理熟悉项目，然后关闭会话，第二天又得从头开始。代理会忘记之前的一切，每次会话都像是一次全新的开始。

这并非模型的限制，而是一个上下文传递的问题。代理本身是有记忆能力的，只是它们没有在正确的时间、以正确的格式获得所需的输入。

## 解决方案

使用两个 Markdown 文件：一个被提交到版本控制（git commit），另一个被 Git 忽略（git ignore）。代理在每次会话开始时都会读取这两个文件，并在会话结束时更新本地的 `.agents.local.md` 文件。

- **`AGENTS.md`**：项目的核心知识库，被提交到版本控制，并且所有团队成员都可以访问。文件长度应控制在 120 行以内，包含压缩后的项目信息：常用模式、项目边界、需要注意的问题、可执行的命令以及项目架构。

- **`.agents.local.md`**：个人的临时记录本，被 Git 忽略。随着代理在每次会话中学习到的内容不断增加，这个文件也会逐渐变大。其中记录了会话笔记、遇到的问题以及尚未被正式纳入核心知识的模式。

就这么简单。不需要任何插件、额外的基础设施或后台进程，所有的规则都包含在这些文件本身中，代理只需按照这些规则来操作。

## 工作原理

### 1. 设置

运行初始化脚本。该脚本会根据模板创建 `.agents.local.md` 文件，并确保它被 Git 忽略；同时配置代理工具所需的配置文件（例如，Claude Code 使用 `CLAUEDE.md`，Cursor 使用 `.cursorrules`，Windsurf 使用 `.windsurfrules`，Copilot 使用 `.github/copilot-instructions.md`）。

```bash
# If you cloned the template repo:
./scripts/init-agent-context.sh

# If you installed as a skill (npx skills add):
bash .agents/skills/agent-context-system/scripts/init-agent-context.sh
```

然后根据你的项目具体情况编辑 `AGENTS.md`，包括项目名称、使用的开发工具栈、可执行的命令以及代码库中的常用模式和需要注意的问题。这是最重要的编辑步骤。

### 2. 会话期间

代理在会话开始时会读取这两个文件：`AGENTS.md` 提供压缩后的项目知识，`.agents.local.md` 则记录了之前会话中的学习内容。这样，代理就能在会话之间保持上下文的一致性。

会话结束时，代理会向用户展示拟议的会话日志内容，然后等待用户的确认才能将其写入 `.agents.local.md`。大多数代理（如 Copilot Chat、Cursor、Windsurf）没有会话结束时的自动处理机制，因此这依赖于 `AGENTS.md` 中的规则是否被正确执行，或者用户是否明确指示“记录这次会话”。

### 3. 长期维护

随着时间的推移，`.agents.local.md` 文件会逐渐变大。当文件超过 300 行时，代理会对其进行压缩处理：删除重复的内容、合并相关的记录，并保留稳定的模式。在压缩过程中，如果某个模式在多个会话中出现，代理会使用与 `AGENTS.md` 相同的格式将其标记为“待推广”。

何时将标记的内容从临时记录本转移到 `AGENTS.md` 中由你决定。临时记录本用于存放实验性的内容，而 `AGENTS.md` 则存放经过验证的知识。

```
Session notes → .agents.local.md → agent flags stable patterns → you promote to AGENTS.md
                    (personal)                                        (shared)
```

## 脚本

模板中包含了五个脚本：

### `init-agent-context.sh`

用于设置本地代理的临时记录本和代理工具的集成。每次克隆项目时运行一次，可以安全地重复执行。

- 根据模板创建 `.agents.local.md` 文件。
- 确保 `.agents.local.md` 被 Git 忽略。
- 询问你使用的代理工具（Claude、Cursor、Windsurf、Copilot），并配置相应的设置文件。
- 为 Claude Code 创建 `CLAUEDE.md` 符链接。

### `compress.sh`

当 `.agents.local.md` 超过 300 行时，对其进行压缩处理：删除重复内容、合并相关记录，并标记需要推广的模式。具体实现方式在 `AGENTS.md` 的“Local Context”部分有说明。

### `promote.sh`

将 `.agents.local.md` 中标记为“待推广”的内容转移到 `AGENTS.md` 中。目前这仍是一个手动操作。

### `validate.sh`

验证 `AGENTS.md` 的长度是否在 120 行以内，并检查格式是否一致。目前尚未实现。

### `publish-template.sh`

将 `agents.md` 文件推送到 GitHub 并标记为模板仓库。只需运行一次，系统会创建一个私有的 GitHub 仓库，并将其标记为模板，这样你就可以使用 `gh repo create my-project --template YOUR_USERNAME/agent-context-system --private` 命令来创建新的项目。

## 知识流动

知识不会固定在一个地方，而是会不断流动：

- 学习的内容最初会以会话笔记的形式保存在 `.agents.local.md` 中，代理在每次会话结束时将其写入。
- 在压缩过程中，如果某个模式在多个会话中出现，代理会将其标记为“待推广”。
- 最终由你来决定何时将这些内容转移到 `AGENTS.md` 中。

```
Session notes → .agents.local.md → agent flags stable patterns → you promote to AGENTS.md
                    (personal)                                        (shared)
```

`agents.local.md` 用于存放实验性的内容，而 `AGENTS.md` 则存放经过验证的知识。代理负责标记需要推广的内容，而你负责最终决定是否将其纳入核心知识库。

## `AGENTS.md` 模板结构

`AGENTS.md` 模板包含以下内容：

### 项目信息

- 基本元数据：项目名称、使用的开发工具栈、包管理器（保持简洁，每条信息只占一行）。

### 可执行命令

- 用于构建、测试、代码检查（lint）和启动开发服务器的可执行命令。这些命令需要立即使用，因此应尽早添加到文件中。

### 项目架构

- 每个目录对应一行，代理无需额外查找即可了解项目的整体结构。

### 项目知识（压缩版）

这是最重要的部分，包含三个子部分：
- **常用模式**：采用 `pattern | where-to-see-it` 的格式。只列出名称，服务器相关的组件默认列出，客户端状态的配置（Zustand）和结果类型（是否需要异常处理）也会列出。
- **项目边界**：采用 `rule | reason` 的格式。禁止修改 `src/generated` 文件，环境变量通过 `src/config` 进行配置，不允许直接导出样式。
- **需要注意的问题**：采用 `trap | fix` 的格式。`pnpm build` 命令会隐藏类型错误，开发会话在 24 小时后失效，集成测试需要数据库支持。

Vercel 的研究显示，当信息以被动形式提供时（始终显示在提示界面），通过率可达 100%，而当代理需要主动查找信息时，通过率仅为 53%。这个部分提供了被动式的上下文支持，代理可以自动获取这些信息。

### 规则

- 以编号列表的形式列出。在使用代码之前，先阅读 `AGENTS.md` 和 `.agents.local.md`。计划好操作步骤，修改文件前先确认文件位置，只修改任务所需的部分，每次修改后都要运行测试，并总结修改内容。

### 深入参考资料

- 当任务需要更详细的信息时，会指向 `agent_docs/` 目录。该目录包含常规设置、项目架构、需要注意的问题等详细内容，可以根据需要加载。

### 本地上下文设置

- 包含如何读取和更新 `.agents.local.md` 的说明，解释了会话间的知识传递机制、压缩规则以及内容推广的流程，同时指示子代理也需要阅读临时记录本（因为它们不会继承主会话的记录历史）。

## `.agents.local.md` 模板结构

`agents.local.md` 模板包含以下内容：

### 个人偏好设置

- 你的编码风格、代码偏好以及项目规划方面的个人习惯。注意保持语言的友好性，避免过于技术性的表达；在编写代码前先明确计划。

### 常用模式

- 关于这个项目的固定规则和最佳实践，将反复出现的经验教训记录在这里。

### 需要注意的问题

- 描述那些看似正确但实际上存在问题的情况，并说明原因。

### 失败的尝试

- 记录曾经尝试过但失败的方法及失败原因，以避免重复同样的错误。

### 待推广的内容

- 当某个模式在多个会话中出现时，代理会将其标记为“待推广”。使用与 `AGENTS.md` 相同的格式进行标记。最终由你来决定是否将其纳入核心知识库。

### 会话日志

- 在文件末尾添加新的会话记录，每个会话记录一条，每条记录控制在 5-10 行以内。记录内容包括：发生了什么、哪些方法有效、哪些无效、所做的决策以及学到的内容。

### 压缩日志

- 当文件超过 300 行时，会进行压缩处理，并将压缩后的日志记录在这里。

## 代理兼容性

该模板适用于所有主要的代理工具：

| 代理工具 | 配置文件 | 功能说明 |
|---|---|---|
| Claude Code | `CLAUEDE.md` | 创建一个指向 `AGENTS.md` 的符号链接（Claude Code 在会话开始时不会直接读取 `AGENTS.md`） |
| Cursor | `.cursorrules` | 指向 `AGENTS.md` 的配置文件 |
| Windsurf | `.windsurfrules` | 指向 `AGENTS.md` 的配置文件 |
| GitHub Copilot | `.github/copilot-instructions.md` | 指向 `AGENTS.md` 的配置文件 |

### Claude Code 的自动记忆功能

Claude Code 在 2025 年底加入了自动记忆功能。它会创建一个 `~/.claude/projects/<project>/memory/` 目录来存储自己的笔记，并在会话开始时加载这些笔记。这实际上就是将 `.agents.local.md` 的功能内置于工具中。

如果你只使用 Claude Code，自动记忆功能会处理会话间的知识传递，此时临时记录本是可选的。对于你来说，`AGENTS.md` 文件本身以及知识推广的机制才是最重要的。

如果你的团队同时使用多种代理工具（例如 GitHub 提供的 Copilot、Claude 和 Codex），临时记录本就变得非常重要，因为自动记忆功能仅在 Claude Code 中生效。而临时记录本在所有代理工具中都适用。

## 子代理的上下文设置

Claude Code 现在支持子代理功能。Copilot 的 CLI 版本也提供了子代理功能（目前仍处于测试阶段）。这两种工具都在朝着同一个目标发展：通过一个主导代理来协调团队成员的工作。

子代理不会继承主会话的记录历史，每个子代理都会从零开始工作。它们共享的唯一信息就是 `AGENTS.md` 文件中的配置。

因此，当你的团队从使用一个代理扩展到五个并行代理时，`AGENTS.md` 从“提供有用的项目上下文”变成了“防止五个代理独立地对项目做出冲突决策的关键工具”。

压缩后的项目知识、项目边界以及需要注意的问题构成了团队共享的知识库。如果没有这个文件，每个子代理都需要重新了解整个项目。

这就是为什么模板中明确要求子代理也需要阅读 `.agents.local.md` 的原因。如果没有这个提示，子代理可能无法获取这些信息。因此，规范化的配置文件尤为重要。如果 `AGENTS.md` 的长度超过 120 行，那么每个子代理都需要为此付出额外的开销。不过，将文件长度控制在 120 行以内其实是一个优势，而不是限制。

## 研究基础

这个模板基于以下研究结果设计：

- **LangChain**：为代理设计的上下文管理框架（包括内容的编写、选择、压缩和隔离功能）。
- **HumanLayer**：关于如何编写有效的 `AGENTS.md` 文件的指导原则。
- **GitHub**：从 2,500 多个仓库中总结出的经验，了解哪些 `agents.md` 文件能够真正发挥作用。
- **Vercel**：研究显示，当信息以被动形式提供时（始终显示在提示界面），通过率可达 100%，而当代理需要主动查找信息时，通过率仅为 53%。
- **Anthropic**：关于如何为代理提供更完善的上下文支持的研究。
- **AI Hero**：关于 `agents.md` 的完整使用指南，以及跨平台的标准化应用。
- **Anthropic**：关于 Claude Code 的子代理功能以及自定义代理的实现。

**关键发现**：前沿的 large language models（LLMs）通常能遵循大约 150-200 条指令。Claude Code 的系统提示界面已经使用了大约 50 条指令。因此，如果 `AGENTS.md` 中的内容不具有普遍适用性，就有可能被忽略。

这就是为什么 `AGENTS.md` 的长度被控制在 120 行以内，并且采用压缩格式（使用竖线分隔各项内容）。简洁的表达方式比冗长的描述更有效。

另一个关键发现是：Vercel 的研究显示，当信息以被动形式提供时，通过率更高。将关键信息放在代理能够直接看到的地方（例如提示界面），可以提高通过率。

## 入门步骤

### 新项目设置

### 从模板创建新仓库

### 现有项目设置

### OpenClaw 用户

将模板文件克隆到你的项目目录中，OpenClaw 会在下一次会话中将其作为工作技能自动识别。

### Copilot 的自定义技能设置

### 将 `SKILL.md` 文件复制到相应的目录中

### 将模板文件发布为公共模板

## 设置完成后

1. **编辑 `AGENTS.md`：**填写项目名称、使用的开发工具栈和可执行命令。将模板中的通用内容替换为你的实际配置。
2. **更新 `agent_docs/` 文件**：添加更详细的参考资料，删除不适用的部分。
3. **自定义 `.agents.local.md`：**添加你的个人偏好设置。
4. **开始使用代理**：代理会读取所有配置文件，执行任务，并更新临时记录本。
5. **推广稳定的内容**：在压缩过程中，代理会将多个会话中重复出现的模式标记为“待推广”，最终由你来决定是否将其纳入 `AGENTS.md`。

## 文件结构

### 安全性措施

- **无需外部下载**：所有文件都包含在仓库中，安装过程中不会从外部 URL 下载任何二进制文件。
- **写入临时记录本需要用户确认**：代理在写入 `.agents.local.md` 之前，会先向用户展示拟议的会话日志内容并等待用户确认。
- `.agents.local.md` 被 Git 忽略，确保个人数据不会被提交到版本控制系统中。
- **操作范围限制**：命令行工具仅在当前工作目录内操作，不会遍历项目根目录外的文件或写入包含 `..` 的路径。
- **安全边界**：`.agents.local.md` 位于用户的个人项目目录中，并被 Git 忽略。其安全性与 `.bashrc`、`.env` 或 IDE 配置文件相同；如果攻击者能够修改用户的本地项目文件，代理的上下文信息也不会受到威胁。
- **临时记录本的内容仅用于记录事实**：代理将 `.agents.local.md` 视为事实性的会话记录，记录了实际发生的情况和结果。

## 许可证

本项目的许可证为 MIT 许可证。