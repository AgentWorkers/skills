---
name: env-setup
description: 扫描代码库以查找环境变量，生成 `.env.example` 文件，验证 `.env` 文件的内容，并确保 `.gitignore` 文件的安全性。
version: 1.0.0
author: Sovereign Skills
tags: [openclaw, agent-skills, automation, productivity, free, env, environment, configuration, security]
triggers:
  - scan env vars
  - generate env example
  - check env
  - environment setup
  - env audit
---
# env-setup — 环境变量管理器

系统会扫描您的代码库中所有引用的环境变量，生成 `.env.example` 文件，验证当前的 `.env` 文件，并确保敏感信息不会被提交到版本控制系统中。

## 步骤

### 1. 扫描代码库中的环境变量

在所有常见的代码模式中查找环境变量的引用：

```bash
# Node.js / JavaScript / TypeScript
grep -rn "process\.env\.\w\+" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" . | grep -v node_modules | grep -v dist

# Python
grep -rn "os\.environ\|os\.getenv\|environ\.get" --include="*.py" . | grep -v __pycache__ | grep -v .venv

# Rust
grep -rn "env::var\|env::var_os\|dotenv" --include="*.rs" . | grep -v target

# Go
grep -rn "os\.Getenv\|os\.LookupEnv\|viper\." --include="*.go" . | grep -v vendor

# Docker / docker-compose
grep -rn "\${.*}" --include="*.yml" --include="*.yaml" docker-compose* 2>/dev/null

# General .env references in config files
grep -rn "env\." --include="*.toml" --include="*.yaml" --include="*.yml" . 2>/dev/null
```

**Windows PowerShell 的替代方法：**
```powershell
Get-ChildItem -Recurse -Include *.js,*.ts,*.jsx,*.tsx -Exclude node_modules,dist | Select-String "process\.env\.\w+"
Get-ChildItem -Recurse -Include *.py -Exclude __pycache__,.venv | Select-String "os\.environ|os\.getenv"
```

### 2. 提取变量名称

解析 grep 的输出以提取唯一的变量名称：

- `process.env.DATABASE_URL` → `DATABASE_URL`
- `os.environ.get("SECRET_KEY", "default")` → `SECRET_KEY`（默认值：`default`）
- `os.getenv("API_KEY")` → `API_KEY`
- `env::var("RUST_LOG")` → `RUST_LOG`

对提取到的变量名称进行去重并按字母顺序排序。同时记录每个变量在代码中的引用位置（文件和行号）。

### 3. 对变量进行分类

将变量分为不同的类别：

| 类别 | 模式 | 示例 |
|----------|---------|---------|
| 🔴 敏感信息 | `*KEY*`, `*SECRET*`, `*TOKEN*`, `*PASSWORD*`, `*CREDENTIAL*` | `API_KEY`, `JWT_SECRET` |
| 🟡 服务地址 | `*URL*`, `*HOST*`, `*ENDPOINT*`, `*URI*` | `DATABASE_URL`, `REDIS_HOST` |
| 🟢 配置参数 | `*PORT*`, `*ENV*`, `*MODE*`, `*LEVEL*`, `*DEBUG*` | `PORT`, `NODE_ENV`, `LOG_LEVEL` |
| ⚪ 其他 | 其他所有变量 | `APP_NAME`, `MAX_RETRIES` |

### 4. 生成 `.env.example` 文件

创建一个包含变量名称、类别及默认值的 `.env.example` 文件：

```env
# ============================================
# Environment Configuration
# Generated by env-setup skill
# ============================================

# --- App Configuration ---
NODE_ENV=development
PORT=3000
LOG_LEVEL=info

# --- Database ---
DATABASE_URL=postgresql://user:password@localhost:5432/dbname

# --- Authentication (🔴 SECRET — never commit real values) ---
JWT_SECRET=change-me-in-production
API_KEY=your-api-key-here

# --- External Services ---
REDIS_URL=redis://localhost:6379
```

规则：
- 敏感信息使用占位符（如 `change-me`, `your-xxx-here`）；
- 配置参数使用合理的默认值；
- 按类别分组，并为敏感变量添加注释提示；
- 对敏感变量添加 `🔴 SECRET` 的警告标记。

### 5. 验证当前的 `.env` 文件

如果存在 `.env` 文件，将其内容与扫描到的变量进行比较：

```markdown
## .env Validation Report

### ❌ Missing (required by code but not in .env)
- `STRIPE_SECRET_KEY` — referenced in src/billing.ts:14
- `SMTP_PASSWORD` — referenced in src/email.ts:8

### ⚠️ Unused (in .env but not referenced in code)
- `OLD_API_ENDPOINT` — may be safe to remove

### ✅ Present and referenced
- `DATABASE_URL` ✓
- `PORT` ✓
- `NODE_ENV` ✓
```

### 6. 确保 `.env` 文件未被包含在 `.gitignore` 文件中

检查 `.env` 文件是否在 `.gitignore` 文件中：

```bash
grep -q "^\.env$\|^\.env\.\*" .gitignore 2>/dev/null
```

如果未包含在其中，建议将其添加到 `.gitignore` 文件中：
```
# Environment files
.env
.env.local
.env.*.local
```

同时检查 Git 历史记录中是否意外提交了 `.env` 文件：
```bash
git log --all --diff-filter=A -- .env .env.local .env.production 2>/dev/null
```

如果发现此类文件，提醒用户敏感信息可能已存在于 Git 历史记录中，并建议使用 `git filter-branch` 或 `BFG Repo-Cleaner` 工具进行清理。

### 7. 输出总结

```markdown
# Environment Variable Report
| Metric | Count |
|--------|-------|
| Total vars found | 15 |
| 🔴 Secrets | 4 |
| ❌ Missing from .env | 2 |
| ⚠️ Unused in .env | 1 |
| ✅ Properly configured | 12 |
| .gitignore protection | ✅ |
```

## 特殊情况

- **特定框架的环境变量**：Next.js 使用 `NEXT_PUBLIC_*`（客户端可访问的变量）；需要对这些变量进行特别标记；
- **Docker 环境变量**：还需检查 `docker-compose.yml` 文件中的 `environment:` 部分；
- **存在多个 `.env` 文件**（如 `.env.development`, `.env.production`, `.env.test`）——需要逐一验证；
- **没有 `.env` 文件**：生成 `.env.example` 文件以及一个默认的 `.env` 文件；
- **Shell 脚本中的变量**：使用 `${VAR:-default}` 进行变量插值——需要提取变量名称。

## 错误处理

| 错误类型 | 处理方法 |
|-------|-----------|
| 未找到环境变量 | 可能是项目未使用环境变量——请与用户确认 |
| `.env` 文件语法错误 | 标记不符合 `KEY=value` 格式的行 |
| 扫描过程中遇到二进制文件 | 使用 `--binary-files=without-match` 选项排除这些文件 |
- 访问 `.env` 文件时被拒绝权限 | 检查文件权限；可能需要提升访问权限 |

---
*由 Clawb (SOVEREIGN) 开发——更多功能即将推出*