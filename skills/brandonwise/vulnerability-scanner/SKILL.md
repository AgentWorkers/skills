# 漏洞扫描器

该工具提供针对 OWASP 2025 标准的高级漏洞分析功能，支持供应链安全评估、攻击面映射以及风险优先级排序。

## 产品描述

**适用场景：**
- 审查代码中的安全漏洞
- 检查依赖项是否存在供应链风险
- 扫描硬编码的秘密信息或凭证
- 识别危险的代码模式（如注入攻击、跨站脚本攻击（XSS）、反序列化漏洞）
- 为安全审计或渗透测试做准备
- 根据风险优先级对漏洞进行修复

**不适用场景：**
- 需要运行时动态分析时（请使用专业的渗透测试工具）
- 需要扫描已编译的二进制文件（本工具专注于源代码分析）
- 需要特定合规性审计时（如 PCI-DSS、HIPAA 等，有专门的审计工具）

## 脚本

| 脚本 | 功能 | 使用方法 |
|--------|---------|-------|
| `scripts/security_scan.py` | 全面安全扫描 | `python scripts/security_scan.py <路径> [--scan-type all\|deps\|secrets\|patterns\|config]` |

### 快速入门

```bash
# Full scan
python scripts/security_scan.py /path/to/project

# Just check for secrets
python scripts/security_scan.py /path/to/project --scan-type secrets

# Summary output
python scripts/security_scan.py /path/to/project --output summary
```

## 参考文件

| 文件 | 用途 |
|------|---------|
| [checklists.md](checklists.md) | OWASP 十大漏洞、身份验证、API、数据保护检查清单 |

---

## 1. 安全专家的思维方式

### 核心原则

| 原则 | 应用方式 |
|-----------|-------------|
| **假设已被入侵** | 以攻击者已入侵的系统为设计基准 |
| **零信任** | 从不信任任何东西，始终进行验证 |
| **深度防御** | 多层防御，避免单一薄弱点 |
| **最小权限** | 仅授予必要的访问权限 |
| **安全优先** | 出现错误时立即拒绝访问 |

### 威胁建模问题

在扫描之前，请思考以下问题：
1. 我们需要保护什么？（资产）
2. 谁可能会发起攻击？（威胁者）
3. 他们会如何攻击？（攻击途径）
4. 攻击会造成什么后果？（业务风险）

---

## 2. OWASP 2025 十大漏洞

### 风险类别

| 排名 | 类别 | 需要考虑的因素 |
|------|----------|-------------|
| **A01** | 访问控制漏洞 | 谁可以访问什么？IDOR（身份验证缺失/错误）、SSRF（跨站请求伪造） |
| **A02** | 安全配置错误 | 默认设置、暴露的服务 |
| **A03** | 软件供应链风险 | 依赖项管理、持续集成/持续交付（CI/CD）过程中的漏洞 |
| **A04** | 加密失败 | 弱加密算法、秘密信息泄露 |
| **A05** | 注入攻击 | 用户输入被用于执行系统命令 |
| **A06** | 不安全的设计 | 存在漏洞的架构 |
| **A07** | 认证失败 | 会话管理、凭证处理问题 |
| **A08** | 数据完整性问题 | 未签名的更新、数据被篡改 |
| **A09** | 日志记录与警报机制 | 监控盲点 |
| **A10** | 异常情况 | 错误处理不当导致的安全风险 |

### 2025 年度的关键变化

```
2021 → 2025 Shifts:
├── SSRF merged into A01 (Access Control)
├── A02 elevated (Cloud/Container configs)
├── A03 NEW: Supply Chain (major focus)
├── A10 NEW: Exceptional Conditions
└── Focus shift: Root causes > Symptoms
```

---

## 3. 供应链安全（A03）

### 攻击面

| 攻击途径 | 相关风险 | 需要关注的问题 |
|--------|------|-----------------|
| **依赖项** | 恶意软件包 | 是否会对新依赖项进行安全审计？ |
| **文件锁定** | 文件完整性攻击 | 文件是否经过验证？ |
| **构建流程** | 持续集成/持续交付（CI/CD）过程中的安全问题 | 谁可以修改代码？ |
| **代码仓库** | 代码仓库中的恶意行为 | 代码来源是否经过验证？ |

### 防御原则

- 验证依赖项的完整性（使用校验和）
- 固定软件版本，定期审计更新
- 对关键依赖项使用私有代码仓库
- 对生成的代码文件进行签名和验证

---

## 4. 攻击面映射

### 需要映射的内容

| 类别 | 具体元素 |
|----------|----------|
| **入口点** | API 接口、表单、文件上传 |
| **数据流** | 数据输入 → 处理过程 → 输出结果 |
| **信任边界** | 认证/授权检查的位置 |
| **资产** | 包含敏感信息的资产（如秘密信息、个人身份信息 PII） |

### 优先级矩阵

```
Risk = Likelihood × Impact

High Impact + High Likelihood → CRITICAL
High Impact + Low Likelihood  → HIGH
Low Impact + High Likelihood  → MEDIUM
Low Impact + Low Likelihood   → LOW
```

---

## 5. 风险优先级排序

### CVSS 评分与上下文分析

| 评分因素 | 权重 | 需要考虑的问题 |
|--------|--------|----------|
| **CVSS 分数** | 基础严重程度 | 漏洞的严重性如何？ |
| **EPSS 分数** | 被利用的可能性 | 该漏洞是否已被利用？ |
| **资产价值** | 业务影响 | 该漏洞对业务造成的影响有多大？ |
| **暴露程度** | 攻击面范围 | 该漏洞是否暴露在互联网上？ |

### 优先级决策树

```
Is it actively exploited (EPSS >0.5)?
├── YES → CRITICAL: Immediate action
└── NO → Check CVSS
         ├── CVSS ≥9.0 → HIGH
         ├── CVSS 7.0-8.9 → Consider asset value
         └── CVSS <7.0 → Schedule for later
```

---

## 6. 异常情况（A10）

### 安全策略：失败时是“开放”还是“关闭”？

| 情况 | “开放策略”（不良做法） | “关闭策略”（良好做法） |
|----------|-----------------|---------------------|
| 认证错误 | 允许访问 | 拒绝访问 |
| 解析失败 | 接受用户输入 | 拒绝用户输入 |
| 超时 | 无限重试 | 限制重试次数并终止操作 |

### 需要检查的内容：

- 通用异常处理机制（可能忽略所有异常）
- 安全操作中的错误处理缺失情况
- 认证/授权过程中的竞态条件
- 资源耗尽的情况

---

## 7. 扫描方法

### 基于阶段的分步扫描方法

```
1. RECONNAISSANCE
   └── Understand the target
       ├── Technology stack
       ├── Entry points
       └── Data flows

2. DISCOVERY
   └── Identify potential issues
       ├── Configuration review
       ├── Dependency analysis
       └── Code pattern search

3. ANALYSIS
   └── Validate and prioritize
       ├── False positive elimination
       ├── Risk scoring
       └── Attack chain mapping

4. REPORTING
   └── Actionable findings
       ├── Clear reproduction steps
       ├── Business impact
       └── Remediation guidance
```

---

## 8. 代码模式分析

### 高风险代码模式

| 模式 | 相关风险 | 需要关注的代码特征 |
|---------|------|----------|
| **查询中的字符串拼接** | 注入攻击 | 如 `"SELECT * FROM " + 用户输入` |
| **动态代码执行** | 远程代码执行（RCE） | `eval()`、`exec()`、`Function()` |
| **不安全的反序列化** | 远程代码执行（RCE） | `pickle.loads()`、`unserialize()` |
| **路径操作** | 用户输入被用于文件路径构造 | |
| **安全功能被禁用** | 例如 `verify=False`、`--insecure` 等配置 |

### 秘密信息相关模式

| 秘密类型 | 识别标志 |
|------|-----------|
| API 密钥 | `api_key`、`apikey` 等 |
| 令牌 | `token`、`bearer`、`jwt` 等 |
| 凭据 | `password`、`secret` 等 |
| 云服务相关标识 | `AWS_`、`AZURE_`、`GCP_` 等前缀 |

---

## 9. 云服务安全注意事项

### 责任划分

| 负责范围 | 你负责的部分 | 服务提供商负责的部分 |
|-------|---------|---------------|
| 数据 | ✅ | ❌ |
| 应用程序 | ✅ | ❌ |
| 操作系统/运行时环境 | 取决于具体情况 | 取决于服务提供商 |
| 基础设施 | ❌ | ✅ |

### 云服务特有的安全检查项：

- 是否应用了最小权限策略（IAM）？
- 存储服务：公共存储桶的使用情况？
- 网络安全：安全组设置是否严格？
- 是否使用了安全的秘密管理工具？

---

## 10. 应避免的错误做法

| 不应做的行为 | 应该做的行为 |
|----------|-------|
| 在不了解情况的情况下进行扫描 | 先完成攻击面映射 |
| 对每个漏洞都发送警报 | 根据漏洞的利用难度和资产价值来排序处理 |
| 忽视误报 | 保持经过验证的安全基线 |
| 只修复表面问题 | 解决根本原因 |
| 部署前仅扫描一次 | 实施持续的安全扫描 |
| 盲目信任第三方依赖项 | 验证依赖项的完整性和代码安全性 |

---

## 11. 报告原则

### 报告内容的结构

每条漏洞报告应包含以下信息：
1. **漏洞类型**：明确的漏洞描述
2. **位置**：具体的文件位置、代码行号或 API 端点
3. **原因**：漏洞产生的根本原因
4. **影响**：漏洞对业务造成的影响
5. **修复方法**：具体的修复建议

### 严重程度分类

| 严重程度 | 判断标准 |
|----------|----------|
| **严重** | 导致远程代码执行（RCE）、绕过认证机制、大规模数据泄露 |
| **较高** | 数据泄露、权限提升 |
| **中等** | 影响范围有限，但需要特定条件才能触发 |
| **较低** | 仅涉及信息泄露，属于最佳实践范围内的问题 |

---

> **提醒：** 漏洞扫描可以发现安全问题，但专家的分析才能确定哪些问题真正需要优先处理。请始终思考：“攻击者会如何利用这些漏洞？”