---
name: dep-audit
description: >
  **审计项目依赖项中的已知漏洞（CVEs）**  
  支持 npm、pip、Cargo 和 Go 等包管理工具。无需使用任何 API 密钥。默认设置为“仅报告”模式；执行修复命令前需要用户确认。
version: 0.1.4
author: CacheForge
tags: [security, audit, dependencies, cve, supply-chain, discord, discord-v2]
---
# 依赖项审计功能

该功能用于检测并报告项目中依赖项树中存在的已知漏洞。支持 **npm**、**pip (Python)**、**Cargo (Rust)** 和 **Go** 环境。

**无需任何 API 密钥或配置信息**，只需将工具指向项目目录即可开始审计。

## 激活条件

当用户输入以下关键词时，该功能会被激活：
- “audit”（审计）
- “vulnerability”（漏洞）
- “CVE”（通用漏洞标识符）
- “dependency check”（依赖项检查）
- “supply chain”（供应链安全）
- “security scan”（安全扫描）

**功能用途**：
- 检查依赖项、锁定文件（lockfiles）或软件包是否存在问题
- 生成软件物料清单（Software Bill of Materials, SBOM）

## 示例命令：
1. “审计这个项目中的漏洞”
2. “检查 ~/projects 目录下的所有仓库中是否存在已知的 CVE 漏洞”
3. “目前是否有需要立即修复的关键漏洞？”
4. “为这个项目生成 SBOM”
5. “这个项目中有哪些依赖项需要更新？”
6. “仅审计 Python 依赖项”

## 权限设置
（具体权限信息请参考相应的代码块）

## 代理工作流程

请严格按照以下步骤执行：

### 第一步：检测
运行检测脚本，以识别项目的锁定文件（lockfiles）及可用的审计工具：

（具体脚本内容请参考相应的代码块）

如果未指定目标目录，系统将使用当前工作目录（`.`）。

解析检测结果输出的 JSON 数据，记录哪些依赖项系统使用了锁定文件，以及哪些审计工具可用。

### 第二步：审计每个依赖项系统
对于第一步中检测到的每个依赖项系统：
- **如果该系统的审计工具可用**，则运行相应的审计脚本：
  （具体脚本内容请参考相应的代码块）
- **如果工具缺失**，向用户提示所需工具的名称及安装命令，并跳过该系统，继续审计其他系统。

> **注意**：`yarn.lock` 和 `pnpm-lock.yaml` 分别对应于 `yarn` 和 `pnpm` 依赖项系统。在 v0.1.x 版本中，`package-lock.json` 也被视为有效的锁定文件格式。如果仅存在 `yarn.lock` 或 `pnpm-lock.yaml`，系统会提示用户该系统的审计功能尚未实现，并建议手动执行 `yarn audit` 或 `pnpm audit`。

每个审计脚本会将处理结果以标准化 JSON 格式输出到标准输出（stdout）。

### 第三步：汇总结果
将每个依赖项系统的审计结果合并到一个统一的 JSON 文件中：

（具体脚本内容请参考相应的代码块）

汇总后的 JSON 文件会同时输出到标准输出（stdout）和 Markdown 格式的报告文件（stderr）中。输出文件分别为：`2>report.md`（Markdown 报告）和 `1>unified.json`（统一 JSON 数据）。

### 第四步：展示结果
向用户展示汇总后的 Markdown 报告，重点显示：
- 按严重程度分类的漏洞总数
- 首先显示关键和高风险的漏洞（这些漏洞需要立即处理）
- 显示已扫描和未扫描的依赖项系统

- 如果未发现任何漏洞，报告 “✅ 未发现已知漏洞。”
- 如果未找到锁定文件，报告 “在 <dir> 目录中未找到锁定文件。该功能支持 npm、pip、Cargo 和 Go 项目。”

### Discord v2 使用方式（OpenClaw v2026.2.14 及更高版本）
当用户位于 Discord 频道中时：
- 首先发送一条简短的回复，列出漏洞总数及关键/高风险漏洞信息。
- 保持回复内容在 1200 个字符以内，避免使用过长的 Markdown 表格。
- 如果支持相关 Discord 功能，提供以下操作选项：
  - “查看完整报告”
  - “查看修复命令”
  - “生成 SBOM”
- 如果相关功能不可用，以编号列表的形式提供相同选项。
- 以短片段的形式分批发送详细信息（每段不超过 15 行），以提高可读性。

### 第五步：提供修复建议（仅用户请求时提供）
如果用户要求修复漏洞：
1. 列出每个漏洞的修复命令，包括包名、当前版本和目标版本。
2. 建议用户先创建一个临时分支：`git checkout -b dep-audit-fixes`
3. 在执行任何修复命令之前，务必获得用户的明确确认。
4. 绝不自动批量执行修复命令。

### 示例交互流程
（具体交互流程请参考相应的代码块）

### 第六步：生成 SBOM（仅用户请求时提供）
报告 SBOM 文件的位置及包含的依赖项数量。

## 错误处理机制
| 错误情况 | 处理方式 |
|-----------|----------|
| 缺少审计工具 | 显示缺失的工具名称及安装命令，并继续使用其他可用工具进行审计。 |
| 审计工具失败 | 记录错误信息（例如：“[ecosystem] 的审计失败：[error]”），并继续审计其他系统。 |
| 审计超时（每个工具超时超过 30 秒） | 报告 “[ecosystem] 的审计超时，已跳过该系统。” |
| 目标目录不存在或无法访问 | 报告 “未找到目标目录”，并停止对该系统的审计。 |
| 未找到锁定文件 | 报告 “未找到锁定文件”，并列出支持的依赖项系统。 |
| 未安装 `jq` 工具 | 尽管没有 `jq`，系统仍可进行审计；但审计和结果汇总需要 `jq`，建议用户先安装该工具。 |
| 错误的锁定文件格式 | 报告该系统的解析错误，并继续审计其他系统。 |

### 性能优化
- `aggregate.sh` 脚本现在可以处理混合格式的输入数据（包括有效结果和错误信息）。
- 无效的输入数据会被记录在统一 JSON 文件的 `errors` 部分，并在报告中以 “跳过 / 错误输入” 的形式显示。
- 如果没有有效的依赖项系统审计结果，汇总输出会将状态设置为 “error” 而不会导致程序崩溃。

## 安全性注意事项：
- **默认模式下，该功能仅负责生成报告，不会修改项目文件**。除非用户明确请求并确认，否则不会执行任何修改操作。
- 审计工具仅读取锁定文件，不会执行项目代码。
- 修复命令（如 `npm audit fix`、`pip install --upgrade`）仅以建议形式提供；执行前会请求用户确认。
- 该功能会查询已知的漏洞数据库（如 OSV、GitHub Advisory DB、RustSec），但无法检测零日漏洞或运行时漏洞。
- 除依赖项工具自身查询的公开漏洞数据库外，不会向第三方服务发送任何数据。
- 该功能不收集任何使用数据，也不进行任何追踪或上报操作。