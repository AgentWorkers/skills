---
name: dep-audit
description: 审计项目依赖项中是否存在已知的漏洞（CVEs）。支持 npm、pip、Cargo 和 Go。无需使用任何 API 密钥。默认设置为“安全”模式（仅报告漏洞），执行修复命令时需要用户确认。
version: 0.1.3
author: Anvil AI
tags: [security, audit, dependencies, cve, supply-chain, discord, discord-v2]
---
# 依赖项审计功能

该功能用于检测并报告项目中依赖项树中存在的已知漏洞。  
支持 **npm**、**pip (Python)**、**Cargo (Rust)** 和 **Go** 环境的审计。  
无需使用 API 密钥或配置文件，只需指定项目路径即可开始审计。

## 激活方式

当用户输入以下关键词时，该功能会被激活：  
- “audit”（审计）  
- “vulnerability”（漏洞）  
- “CVE”（漏洞编号）  
- “dependency check”（依赖项检查）  
- “supply chain”（供应链安全）  
- “security scan”（安全扫描）  
- 检查依赖项、锁文件（lockfile）或包是否存在问题  
- 生成软件物料清单（SBOM，Software Bill of Materials）

## 示例命令  

1. “审计该项目中的漏洞”  
2. “检查我所有位于 ~/projects 目录下的仓库中是否存在已知的 CVE 漏洞”  
3. “是否有需要立即修复的严重漏洞？”  
4. “为该项目生成 SBOM”  
5. “该项目中有哪些依赖项需要更新？”  
6. “仅审计 Python 依赖项”  

## 权限设置  
（具体权限信息请参考相关文档或代码块。）  

## 代理工作流程  

请严格按照以下步骤执行：  

### 第 1 步：检测  
运行检测脚本，以识别项目的锁文件（lockfile）及可用的审计工具：  
（具体脚本内容请参考相关代码块。）  
如果未指定目标目录，系统将使用当前工作目录（`.`）。  
解析检测结果输出的 JSON 数据，记录哪些依赖项系统使用了锁文件，以及可用的审计工具。  

### 第 2 步：审计每个依赖项系统  
对于第 1 步中检测到的每个依赖项系统：  
- **如果该系统的审计工具可用**，则运行相应的审计脚本：  
  （具体脚本内容请参考相关代码块。）  
- **如果工具缺失**，向用户提示所需工具及其安装命令，并跳过该系统，继续审计其他系统。  
> **注意**：`yarn.lock` 和 `pnpm-lock.yaml` 分别对应于 `yarn` 和 `pnpm` 依赖项系统。在 v0.1.x 版本中，仅支持对 `package-lock.json` 文件的审计。如果系统中仅存在 `yarn.lock` 或 `pnpm-lock.yaml`，系统会提示用户该系统不支持专门的审计工具，并建议手动执行 `yarn audit` 或 `pnpm audit`。  
每个审计脚本会将结果以标准 JSON 格式输出到标准输出（stdout）。  

### 第 3 步：汇总结果  
将每个依赖项系统的审计结果汇总到统一处理脚本中：  
（具体脚本内容请参考相关代码块。）  
汇总脚本会将处理后的 JSON 数据输出到标准输出（stdout），并将审计报告以 Markdown 格式输出到标准错误输出（stderr）：  
- `2>report.md` 用于输出 Markdown 报告  
- `1>unified.json` 用于输出汇总后的 JSON 数据  

### 第 4 步：展示结果  
向用户展示汇总后的 Markdown 报告，重点显示：  
- 按严重程度分类的漏洞总数  
- 首先显示严重性和高风险的漏洞（这些漏洞需要立即处理）  
- 显示已扫描和未扫描的依赖项系统  

- 如果未发现任何漏洞，报告：“✅ 未发现已知漏洞。”  
- 如果未找到锁文件，报告：“<目录> 中未找到锁文件。该功能支持 npm、pip、Cargo 和 Go 项目。”  

### Discord v2 交付模式（OpenClaw v2026.2.14+）  
当用户使用 Discord 通道时：  
- 首先发送一条简短的消息，列出漏洞总数及严重性较高的漏洞信息。  
- 确保消息长度不超过 1200 个字符，避免使用过长的 Markdown 表格。  
- 如果支持相关 Discord 功能，提供以下操作选项：  
  - “查看完整报告”  
  - “查看修复命令”  
  - “生成 SBOM”  
- 如果相关功能不可用，以编号列表的形式提供相同选项。  
- 分段发送详细信息（每段不超过 15 行），以提高可读性。  

### 第 5 步：提供修复建议（用户主动请求时）  
如果用户要求修复漏洞：  
1. 列出每个漏洞的修复命令，包括包名、当前版本和目标版本。  
2. 建议用户先创建一个临时分支：`git checkout -b dep-audit-fixes`  
3. 在执行任何修复命令前，务必获取用户的明确确认。  
4. 绝不允许批量执行修复命令。  
（具体交互流程请参考相关代码块。）  

### 第 6 步：生成 SBOM（用户主动请求时）  
报告 SBOM 文件的位置及包含的依赖项数量。  

## 错误处理  
| 错误情况 | 处理方式 |  
|-----------|----------|  
| 检测工具未找到 | 显示缺失的工具名称及安装命令，继续使用其他可用工具。 |  
| 审计工具失败 | 记录错误信息，并报告 “[依赖项系统] 审计失败：[错误原因]”，继续审计其他系统。 |  
| 检测超时（每个工具超过 30 秒） | 报告 “[依赖项系统] 审计超时，跳过该系统。” |  
| 目标目录不存在或无法访问 | 报告 “未找到目标目录”，并停止对该系统的审计。  
| 未找到锁文件 | 报告 “未找到锁文件”，并列出支持的依赖项系统。  
| 未安装 `jq` 工具 | 尽管没有 `jq`，系统仍可进行审计，但审计和汇总步骤需要 `jq`；建议先安装该工具。  
| 锁文件格式错误 | 报告该系统的解析错误，继续审计其他系统。 |  

### 总结  
- `aggregate.sh` 脚本现在可以处理混合格式的输入数据（有效结果和错误信息）。  
- 无效的输入数据会作为错误记录在汇总后的 JSON 中，并在 Markdown 报告的 “Skipped / Error Inputs” 部分显示。  
- 如果没有有效的依赖项系统审计结果，汇总脚本会将状态设置为 “error”。  

## 安全性说明  
- **默认模式下，该功能仅负责生成报告，不会修改项目文件。**  
- 审计工具仅读取锁文件，不会执行项目代码。  
- 修复命令（如 `npm audit fix`、`pip install --upgrade`）仅作为建议提供；执行前会请求用户确认。  
- 该功能会查询已知的漏洞数据库（如 OSV、GitHub Advisory DB、RustSec），但无法检测零日漏洞或运行时漏洞。  
- 所有数据仅限于系统内部使用，不会发送给第三方服务（仅查询公开的安全数据库）。  
- 该功能不收集任何用户数据，也不会发送任何监控信息。