---
name: ios-keyboard-limitations
description: iOS键盘扩展的技术限制及解决方法。在规划或开发具有语音/音频功能、语音输入功能或系统集成需求的iOS自定义键盘时，请参考本文档。内容涵盖内存限制、沙箱环境限制、麦克风使用权限、应用程序启动方式以及可行的替代架构方案。
---

# iOS键盘扩展的局限性

在开发具有语音/音频功能的iOS自定义键盘时，通过PolyVoice项目发现了以下一些重要的局限性。

## 🔴 无法绕过的硬性限制

### 1. **麦克风访问权限** — **被禁止**
**键盘扩展无法访问麦克风**：
- 使用`AVAudioRecorder`时会遇到权限错误
- `SFSpeechRecognizer`无法使用
- 无法从键盘上下文调用Siri

**原因：**苹果的安全模型规定：键盘运行在沙箱环境中，可能会记录音频。

### 2. **打开其他应用程序** — **被阻止**
**键盘无法通过编程方式打开主应用程序或其他任何应用程序**：
- `UIApplication.shared.open()`会返回`false`
- URL方案（如`myapp://`）无法使用
- `ExtensionContext.open()`也不可用

**原因：**这是为了防止恶意键盘在用户未同意的情况下启动应用程序。

### 3. **内存限制** — 约50MB
**键盘扩展的内存使用受到严格限制（通常为30-60MB）**：
- 如果超出内存限制，应用程序会无声地终止
- 无法生成崩溃日志，只会直接消失
- 进行复杂的音频处理会导致应用程序立即崩溃

**缓解措施：**
- 以16kHz单声道格式进行录音（而非44.1kHz）
- 最大使用32kbps的比特率
- 录音完成后立即清理文件
- 录音时间最长为60秒

### 4. **没有持久化存储空间**
**无法使用`UserDefaults`，只能使用App Groups（应用组）**：
- 标准的`UserDefaults`无法保存数据
- 必须使用`UserDefaults(suiteName: "group.com.company.app")`
- 两个目标平台（iOS和macOS）都必须支持App Groups功能

### 5. **网络请求需要“完全访问权限”**
**如果没有用户在设置中启用“允许完全访问”，API调用会失败**：
- 用户需要明确在设置中启用该权限：设置 → 通用 → 键盘 → [键盘名称] → 允许完全访问
- 大多数用户不会主动这样做
- 无法通过键盘用户界面有效地提示或解释这个步骤

## 🟡 部分解决方法（但会增加用户操作难度）

### **“打开应用程序”的解决方法**
**目标：**让用户通过点击按钮来打开主应用程序进行录音。

**尝试：**
```swift
// This does NOT work
extensionContext?.open(URL(string: "myapp://record")!)
```

**实际问题：**虽然可以在扩展之外调用`UIApplication.shared.open()`，但键盘本身无法直接执行这个操作。

### **手动切换模式**
**实际可行的方法（但操作较为繁琐）：**
1. **用户点击键盘上的按钮** → 显示提示：“是否要打开PolyVoice进行录音？”
2. **用户手动切换到主应用程序**（通过Home键、滑动等方式）
3. **主应用程序检测到活动会话**（通过App Groups或共享状态）
4. **主应用程序开始自动录音**
5. **录音2秒后自动停止**
6. **录音内容自动复制到剪贴板**
7. **用户手动切换回目标应用程序**
8. **目标应用程序重新出现时，录音内容会自动粘贴**

**用户操作流程：**
```
Keyboard → Tap mic → [Manual: Switch to app] → App auto-records → 
[Manual: Switch back] → Keyboard auto-pastes
```

**操作难点：**
- 需要用户手动进行两次应用程序切换
- 切换上下文会打断操作流程
- 用户可能会忘记返回到原始应用程序
- 剪贴板的内容可能会被覆盖

## 🟢 替代架构

### **选项1：使用分享扩展**（更适合音频功能）**
**使用分享面板而不是键盘**：
- 可以使用应用程序的所有功能
- 可以录制音频
- 可以处理并返回文本

**限制：**这不是一个真正的键盘，用户需要针对每个文本字段单独打开分享面板。

### **选项2：仅使用完整的应用程序**
**不使用键盘扩展，直接使用主应用程序**：
- 用户打开应用程序
- 进行语音输入
- 复制输入内容
- 切换回目标应用程序
- 手动粘贴内容

**优点：**没有内存限制，可以完全访问麦克风，可靠性较高。
**缺点：**操作步骤比使用键盘更繁琐。

### **选项3：集成Siri快捷指令**
**提供Siri语音转文本的快捷指令**：
- 例如：“嘿Siri，用PolyVoice进行语音输入”
- 将转录结果返回到当前应用程序
- 完全得到苹果官方的支持

**限制：**转换过程不是即时的，需要先设置Siri快捷指令。

## 📊 决策矩阵

| 方法 | 麦克风访问权限 | 内存限制 | 用户操作难度 | 是否获得苹果官方认可 |
|----------|-----------|---------|---------------|----------------|
| 键盘扩展 | ❌ 否 | ⚠️ 50MB | 低（无音频使用时） | ✅ 是 |
| 键盘 + 音频解决方案 | ❌ 否 | ⚠️ 50MB | 🔴 高 | ✅ 是 |
| 使用分享扩展 | ✅ 是 | ✅ 全功能 | 🟡 中等 | ✅ 是 |
| 仅使用完整应用程序 | ✅ 是 | ✅ 全功能 | 🟡 中等 | ✅ 是 |
| Siri快捷指令 | ✅ 是 | ✅ 全功能 | 🟡 中等 | ✅ 是 |

## 🎯 建议

**对于语音输入/人工智能转录：**
1. **不建议开发键盘扩展** — 因为存在诸多限制，使用起来非常不便。
2. **建议使用分享扩展** — 这是苹果官方支持的方法，功能齐全。
3. **或者直接使用完整的应用程序** — 最简单且最可靠。
4. **为高级用户提供Siri快捷指令** — 可以提高输入效率。

**对于非音频功能的键盘（如表情符号、翻译等）：**
键盘扩展仍然是一个很好的选择。只需避免使用音频相关功能即可。

## 📚 参考资料**
- 苹果官方文档：https://developer.apple.com/documentation/uikit/keyboards_and_input/creating_a_custom_keyboard
- 自定义键盘编程指南（WWDC演讲内容）
- PolyVoice项目的相关资料（~/Projects/polyvoice-keyboard/）