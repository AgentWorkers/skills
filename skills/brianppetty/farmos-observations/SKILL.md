---
name: farmos-observations
description: 查询和创建现场观测记录以及由人工智能处理的捕获数据（包括现场拍摄的照片、语音记录和文本笔记）。
tags: [farming, observations, field-reports]
---
# FarmOS 观察记录

这是一个基于人工智能的快速记录系统，用于记录田间观察结果、照片、语音笔记以及问题报告。

## 适用场景

**功能用途：**记录田间观察情况，包括病虫害/杂草的报告、作物生长状况、天气造成的损害、设备故障等信息。

**触发语句：**“在X田发现了[病虫害/杂草]”、“豆子长得不好”、“12田出了问题”、“创建一份观察记录”、“记录这个问题”、“今天有什么观察结果吗？”、“X田报告了什么情况？”

**不适用场景：**设备维护计划安排或设备状态查询（使用farmos-equipment模块）；任务/工作订单的创建（使用farmos-tasks模块，但系统会在记录观察结果后建议创建工作订单）；天气预报或喷洒条件查询（使用farmos-weather模块）。

**最低输入要求：**只需提及在田间观察到的任何情况，例如“豆子长得不好”，系统会自动提出进一步的询问。

## 数据完整性

1. `/api/integration/dashboard` 端点仅用于显示统计信息（观察记录数量和待审核记录），请勿用于列出单个观察记录。
2. 要列出所有观察记录，请使用 `GET /api/observations` 并设置相应的过滤条件。该端点支持分页查询，请使用 `limit` 参数，并注意总记录数。
3. 必须说明记录数量，例如：“本周在12田共发现了7条观察记录”，而不仅仅是列出记录列表。
4. 如果记录数量很少，请明确说明：“本周仅发现了2条记录，可能是数据不完整，或者观察记录服务出现了问题。”
5. 如果服务不可用，请直接告知用户，不要将空结果显示为“没有记录”。

## API 基础信息

http://100.102.77.110:8008

**注意：**观察记录的后端可能存在稳定性问题（有重启循环的反馈）。如果端点无法响应，请报告观察记录服务可能出现故障。

## 集成端点（无需认证）

### 仪表盘
GET /api/integration/dashboard

返回：观察记录数量、近期活动及待审核记录。

## 需要认证的端点（需要JWT令牌）

### 认证流程

该功能需要使用JWT令牌来访问受保护的FarmOS端点。

**获取令牌的方法：**
```bash
TOKEN=$(~/clawd/scripts/farmos-auth.sh manager)
```

**使用令牌的方法：**
```bash
curl -H "Authorization: Bearer $TOKEN" http://100.102.77.110:8008/api/endpoint
```

**令牌有效期：**令牌有效期为15分钟。如果收到401错误响应，请重新请求令牌。

### 列出观察记录
GET /api/observations?limit=10&field_id=12
Authorization: Bearer {token}

### 观察记录详情
GET /api/observations/{id}
Authorization: Bearer {token}

返回：包含人工智能分析结果、提取的实体信息、紧急程度评分以及相关操作（如任务、维护记录）的完整观察记录。

### 创建观察记录
POST /api/observations
Authorization: Bearer {token}
Content-Type: multipart/form-data

**表单字段：**
- `observation_type`（必填）：病虫害、杂草、天气损害、设备故障、作物生长状况等
- `description`（必填）：观察内容的文字描述
- `severity`（可选）：低、中、高（默认为中等）
- `field_id`（可选）：田地编号
- `equipment_id`（可选）：设备编号
- `photo`（可选）：图片文件附件

**使用curl的示例：**
```bash
curl -X POST http://100.102.77.110:8008/api/observations \
  -H "Authorization: Bearer $TOKEN" \
  -F "observation_type=weed" \
  -F "description=Found waterhemp in northeast corner near waterway" \
  -F "severity=high" \
  -F "field_id=22" \
  -F "photo=@/path/to/photo.jpg"
```

**当工作人员在#field-support或#field-ops频道报告问题时，建议创建观察记录。**从消息中尽可能提取详细信息（田地名称、观察类型、紧急程度），然后创建相应的观察记录。

## 使用注意事项

- 观察记录包含紧急程度评分（1-10分）。紧急程度为7分及以上的情况需立即处理。
- 人工智能会自动分类问题类型，并提取相关设备/田地/作物的信息。
- 观察记录可能会触发任务创建（通过Task Manager）或维护记录的生成（通过Equipment模块）。
- 如果服务不可用，应告知用户并建议他们手动记录观察结果。
- 该系统设计用于接收田间拍摄的照片，因此机器人应能接收图片并处理这些图片。
- **主动创建观察记录：**当工作人员在聊天频道中提到问题时（例如“12田里长了很多杂草”），建议将其记录为观察记录。不要未经询问就自动创建记录。
- **设备相关观察记录：**如果观察记录涉及设备问题，请在创建记录时提供设备编号，以便追踪特定设备的重复性问题。

---

## 智能观察检测

当用户报告可能与田间观察相关的内容时，系统会自动从消息中提取尽可能多的信息。

### 需要检测的内容

**田地识别：**
- 明确提及的田地名称：如“12田”、“F12”等
- 通过名称识别：如“Byrd农场”、“Kruckeberg农场”等已知田地名称
- 从聊天内容判断：如果对话已经涉及特定田地，则直接使用该名称
- 根据用户位置判断：如果用户提到“我所在的田地”等

**观察类型**：请参考下表。

**紧急程度判断**：请参考下表。

**常见病虫害/杂草识别：**
- 印第安纳州常见的病虫害：西部玉米根虫、日本甲虫、玉米穗虫、大豆蚜虫、豆叶甲虫、行军虫、黑切根虫、臭虫
- 常见病害：焦斑病、灰叶斑病、北方叶枯病、猝倒病、白霉病、蛙眼叶斑病、戈斯萎蔫病、炭疽病
- 常见杂草：水蓼、马尾草、巨型豚草、普通豚草、帕尔默苋菜、羊蹄草、狐尾草、绒毛叶草、牵牛花

**设备相关信息：**
- 通过名称或编号识别设备：如“8250号设备”、“Kinze播种机”、“喷雾器”
- 通过描述推断设备类型：例如“播种机无法正常工作”可能指的是8250号播种机

**田地内的位置描述：**
- 方向：如“东北角”、“南端”
- 地标：如“靠近水道”、“沿树线”、“在路边”、“堤岸”
- 分布范围：如“整个田地”、“零星分布”、“局部区域”

---

## 观察类型判断

| 关键词/信号 | 观察类型 |
|----------------|-----------------|
| 昆虫、蚜虫、根虫、行军虫、甲虫、切根虫、穗虫、臭虫、幼虫 | 病虫害 |
| 焦斑病、灰叶斑病、北方叶枯病、锈病、腐烂、叶斑、霉菌、萎蔫、猝倒病、炭疽病 | 病害 |
| 水蓼、马尾草、豚草、狐尾草、羊蹄草、帕尔默苋菜、杂草 | 杂草 |
| 冰雹、风害、洪水、霜冻、干旱、风暴、冰雹、冲刷、积水 | 天气造成的损害 |
- 设备故障：如设备损坏、泄漏、卡住、噪音、无法启动、过热、振动、警告灯、液压系统问题、轮胎爆裂 | 设备故障 |
- 土壤问题：如土壤压实、侵蚀、排水不良、积水、瓷砖损坏、沟槽、土壤测试、pH值异常 | 土壤问题 |
- 作物生长状况：如植株数量、出苗情况、颜色变化、生长不均匀、植株矮小、叶片发黄、植株变紫 | 作物生长状况 |

**如果多个类型符合描述**（例如“叶片发黄且有斑点”，可能是病害或土壤问题），请选择更具体的类型。如果确实难以判断，可询问：“这更像是病害问题还是普通的作物生长问题？”

## 紧急程度判断

| 语言描述 | 紧急程度 |
|-----------------|----------|
| “非常严重”、“普遍存在”、“整个田地都受影响”、“前所未见”、“最严重的情况”、“无法控制” | 高度紧急 |
| “有些”、“中等程度”、“正在扩散”、“情况恶化”、“比上周更严重”、“数量较多” | 中等程度 |
| “少量”、“小范围”、“刚刚发现”、“孤立现象”、“不太严重”、“刚刚开始” | 低度紧急 |

**如果语言描述中未明确紧急程度，默认判断为中等程度。**切勿随意猜测高度紧急的情况。

## 后续询问（智能提示）

当报告信息较少时，提出有针对性的后续问题。**每次交互最多提出2-3个问题，避免过度询问。**

### 常见问题：

- **范围：**“问题分布有多广？只是某个地方还是整个田地？”
- **相邻田地：**“在其他相邻田地也有类似情况吗？”
- **比例：**“大约有多少比例的田地受到影响？”
- **照片：**“有照片吗？照片有助于确定问题的具体类型。”
- **处理历史：**“这个田地最近是否接受过处理？”
- **重复情况：**“这是否是您之前报告过的同一问题？”（仅在有类似记录的情况下询问）
- **时间：**“您是什么时候第一次发现这个问题的？”
- **趋势：**“情况是在恶化还是保持稳定？”

### 根据不同情况选择问题：

| 缺失的信息 | 询问内容 |
|-------------|-----|
| 未提供田地名称 | “您现在在哪个田地？”（必须询问，因为无法创建记录） |
- 无法确定问题类型 | “您具体看到了什么？是杂草、虫害还是作物受损？” |
- 知道问题类型但不知道范围 | “问题分布有多广？” |
- 报告了病虫害/杂草 | “有照片吗？”（照片对于确认问题类型很有帮助） |
- 问题似乎反复出现 | “这是之前报告过的同一问题吗？” |

## 根据用户类型调整回答方式

### 详细信息提供者（农学家、经验丰富的工作人员）

他们会提供详细的信息，例如：“在22田的东北角发现了西部玉米根虫的损害，大约15%的植株受到影响，每株上有8只成虫。”
- **自动检测所有信息并确认细节，然后创建观察记录。**
- 跳过重复性问题，因为他们已经提供了所需的信息。
- 例如：**“明白了——22田东北角有根虫损害，大约15%的植株受到影响，严重程度为高，现在正在创建观察记录。”

### 信息提供较少的人（田间工作人员、季节性工人）

他们可能会简单地说“12田出了问题”或“豆子长得不好”。
- **提出2-3个有针对性的后续问题，避免过度询问。**
- 根据具体情况选择最相关的问题进行询问。
- 例如：
  - 工作人员：“12田的豆子长得不好。”
  - 机器人：“您看到的是杂草、虫害还是作物生长问题？整个田地都受影响了吗？”
  - 工作人员：“是杂草，主要在东北部。”
  - 机器人：“明白了，正在创建观察记录——12田东北部的杂草问题，严重程度为中等。需要我同时创建一个巡查任务吗？”

### 关键规则

- **创建记录前务必询问：**“您需要我创建观察记录吗？”除非用户明确要求，否则不要自动创建记录。
- **特殊情况：**如果用户直接说“记录这个问题”或“创建观察记录”，则可以立即创建记录。
- **每次最多提出3个后续问题。**超过3个问题后，根据现有信息创建记录，并记录未知的信息。

## 创建记录后的操作

成功创建记录后，可以提供以下相关操作建议：

- **工作订单：**“需要我为这个问题创建工作订单吗？”（特别是针对需要处理的病虫害/设备问题）
- **检查相邻田地：**“需要我检查其他相邻田地是否也有相同问题吗？”（有助于判断病虫害/杂草的扩散情况）
- **巡查任务：**“需要我安排一次巡查吗？”（针对需要监测的观察记录）
- **设备维护：**如果问题是设备故障，**“需要我将这个问题记录在设备维护记录中吗？”

每次只提供1-2个最相关的操作建议，避免让用户感到困惑。

## 紧急情况升级

在创建记录后，如果发现以下情况，请立即通知相关人员：

- **严重程度的作物损害**：可能导致产量损失，需要Brian知道情况。
- **设备安全问题**：如液压系统泄漏、结构故障等可能危及人员安全的情况。
- **化学物质泄漏**：如农药漂移、泄漏或违规使用等情况。
- **病虫害爆发**：如严重程度的病虫害（如焦斑病、猝倒病、严重的根虫危害）。
- **严重程度的天气损害**：如冰雹、洪水、风暴造成的损害。

在升级情况时，发送简洁的警报：“紧急：[问题类型]在[X田发生——[简要描述]。严重程度：高。观察记录编号：[id]已创建。”

**常规观察记录（低/中等程度、孤立问题或常规巡查结果）无需升级。**

## 模块间的关联

创建或查看观察记录后，可以与其他模块进行关联：

**观察记录 → 模式检测：**
- 当创建新的观察记录时，检查是否有类似的近期记录（相同类型、相邻田地、同一时间范围内）：“这是本周第三个关于水蓼的记录，可能需要全面喷洒而不是局部处理。”
- 在列出观察记录时，如果多个记录类型/田地/时间范围相同，可按模式进行分组：“本周有3条关于病害的记录，都在东部的田地，可能是扩散现象。”
- 跟踪问题升级情况：“上周二的报告是低程度紧急，现在4个田地都出现了高程度紧急情况，情况正在迅速恶化。”

**观察记录 → 任务：**
- 创建记录后，检查farmos-tasks中是否有与该田地或问题相关的工作订单：“昨天已经为22田创建了一个巡查任务，需要将这个记录添加进去吗？”
- 如果没有相关任务且问题需要处理（如病虫害/杂草），建议创建新的任务。
- 将观察记录与任务建议关联：“本周第三次发现水蓼，需要创建一次全面喷洒任务吗？”

**观察记录 → 天气：**
- 将近期天气情况与观察记录关联：“上周降雨后出现了3条病害记录，可能是雨水导致的。”
- 当创建天气损害记录时，获取实际天气数据：“您报告14田有冰雹损害，记录显示周二晚上降水量为1.2英寸。”
- 提醒潜在的天气风险：“预计周四还会下雨，这种病害可能会继续蔓延。”

**观察记录 → 设备：**
- 如果观察记录需要特定设备进行处理，检查设备的可用性：“如果您要喷洒除草剂，喷雾器可用——使用时间153小时，目前没有维护计划。”

在需要关联时，请进行适当的交叉参考。简单的“记录这个观察记录”可能不需要全面的模块间检查，但在发现规律或需要采取行动时，应进行关联。

## 图片辅助识别

当观察记录附有图片时（图片描述会显示为`[Image] Description: ...`），可以利用图片来完善记录内容。

### 利用图片提高识别准确性

**根据图片描述细化问题类型和紧急程度：**
- 如果图片显示叶片上的病害，根据病害的特征（形状、颜色、分布位置）调整观察类型为“病害”并尝试确定具体类型。
- 如果图片显示昆虫或虫害，根据昆虫种类或损害特征调整观察类型为“病虫害”。
- 如果图片显示杂草，根据杂草的形态、生长习性或花序特征调整观察类型为“杂草”。
- 如果图片显示设备问题，记录设备类型及可见问题，同时提供设备编号。
- 如果图片显示作物状况，记录生长阶段、颜色、植株数量、均匀度等特征，调整观察类型为“作物生长状况”。
- 如果图片显示天气损害，记录损害类型（如冰雹造成的损伤、风害造成的倒伏等），调整观察类型为“天气损害”。

**请务必在观察记录的`description`字段中包含图片描述。**将用户描述与图片内容结合起来：
> “用户：在12田的玉米上发现了一些奇怪的斑点。图片显示：叶片叶脉间有矩形棕色斑点，长度约为1-3厘米，符合灰叶斑病（Cercospora zeae-maydis）的特征。位于田地的东北部。”

### 处理图片质量

- **清晰的照片**：利用清晰的照片来提高识别准确性，请说明您看到的情况和您的判断。
- **图片不清晰/模糊/过暗**：请如实说明：“虽然能看清部分内容，但图片太模糊或太暗，无法准确判断。可以重新拍摄吗？或者请描述您看到的情况。”
- **图片与描述不符**：如果图片与用户描述不符，请说明：“您提到是杂草，但图片显示的可能是病害斑点，请确认一下。”
- **多种问题同时存在**：如果图片中同时出现多种问题，请全部记录：“图片中既有水蓼也有疑似病害的斑点，需要为这两种情况都创建记录吗？”

### 对于仅提供文字描述的报告

如果用户仅提供文字描述（如病虫害、杂草、损害情况）且未附图片，可以询问：“有照片吗？照片有助于确定问题的具体类型。”（这已经在后续问题中提到过。）
- **无需强制要求提供照片。**即使没有照片，根据文字描述也可以创建记录。

**附件图片**

在通过`POST /api/observations`创建记录时，如果`MediaPath`可用，请将图片作为`photo`字段上传。图片会与记录一起存档，以供后续参考。