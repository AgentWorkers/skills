---
name: openclaw-token-optimizer
description: 通过审计上下文注入（context injection）行为、优化工作区文件（WORKSPACE.md、SOUL.md、MEMORY.md文件以及每日内存使用情况）、启用提示缓存（prompt caching）、心跳机制（heartbeat）、上下文修剪（context pruning）、数据压缩（compaction）、内存搜索（memory search）功能、子代理（subagents）设置、模型分层（model tiering）以及调整Cron任务的执行频率（cron frequency），来优化OpenClaw令牌的使用效率和成本。当用户希望减少OpenClaw令牌的消耗、加快会话执行速度、压缩处理的数据量，或需要配置openclaw.json文件及内存搜索相关设置时，可采取这些优化措施。
---
# OpenClaw 令牌优化器

## 概述  
本工具提供了一套实用的审计和配置方案，旨在减少输入数据中的冗余信息和不必要的调用，同时保持回答的质量。具体内容包括配置修改建议、工作区文件优化指导以及分阶段的部署计划。

## 工作流程  

### 1) 确定配置范围并定位配置文件  
- 找到 OpenClaw 的配置文件位置（常见路径包括 `~/.openclaw/openclaw.json`、`.openclaw/openclaw.json` 或项目根目录下的配置文件）。  
- 列出需要优化的配置文件（例如 `AGENTS.md`、`SOUL.md`、`TOOLS.md`、`IDENTITY.md`、`USER.md`、`HEARTBEAT.md`、`MEMORY.md` 和 `memory/YYYY-MM-DD.md`）。  
- 确认所使用的模型是否支持提示缓存和内存搜索功能，以避免使用不受支持的配置项。  

### 2) 分析令牌来源  
- 将输入数据的成本分为几类：系统提示、工具架构、工作区文件、内存文件以及对话历史记录。  
- 如果无法获取精确的令牌数量，可以使用粗略的估算方法（例如每 4 个字符计为一个令牌），并明确说明该估算为近似值。  

### 3) 优化输入数据（以实现最高的投资回报率）  
- 首先优化工作区文件：  
  - `AGENTS.md`：仅保留必要的代理规则和政策。  
  - `SOUL.md`：简化为简短的个人信息条目。  
  - `MEMORY.md`：仅保留重要的数据，其余内容进行归档。  
  - `memory/YYYY-MM-DD.md`：定期清理或轮换日志文件。  
- 删除配置文件中未使用的部分（例如，如果 `TOOLS.md` 或 `IDENTITY.md` 未被使用）。  
- 对于较大的数据量，优先使用内存搜索功能而非完整文件加载方式；如果使用 qmd，仅索引所需路径。  

### 4) 缓存与上下文控制  
- 在支持的模型中启用提示缓存功能，将 `cacheRetention` 设置为较长的时间窗口，以最大化缓存利用率。  
- 配置心跳机制（例如每 55 分钟执行一次），使用低成本的模型生成提示内容。  
- 根据缓存窗口设置上下文数据的更新周期，防止历史记录无限制地增长。  
- 结合内存清理功能进行数据压缩，确保长时间会话中的重要决策得以保留，同时清理旧数据。  

### 5) 减少不必要的调用  
- 审查 cron 任务和定时任务，合并重复的检查项，降低执行频率，并将非核心任务分配给成本更低的模型处理。  
- 将数据传输方式设置为按需触发或仅在数据发生变化时执行，以避免不必要的调用。  

### 6) 模型策略  
- 对于常规任务，优先使用成本效益较高的模型；对于需要手动升级的场景，提供高级模型的别名。  
- 对于需要并行处理的独立任务，使用成本较低的子模型，以避免主上下文文件过大。  

### 7) 最终成果  
- 提供：  
  - 详细的审计总结及预估的节省效果。  
  - 修改后的 `openclaw.json` 配置文件或相应的 JSON 代码片段。  
  - 需要优化的文件列表，以及优化前后的文件大小目标。  
  - 分阶段的部署计划（先实现快速改进，再逐步引入高级功能）。  

## 参考资料  
- 请参考 `references/openclaw-token-optimization.md`，以获取配置示例、检查清单及 qmd 使用指南。