---
name: runtime-attestation-probe
description: 该工具用于验证代理在运行时的行为是否与其在认证文件中声明的能力和限制相符。它可以检测代理声称的功能与其实际执行行为之间的差异，从而发现那些能够通过静态分析但会在运行时条件性地被激活的攻击类型。
version: 1.0.0
metadata:
  openclaw:
    requires:
      bins: [curl, python3]
      env: []
    emoji: "🔬"
---
# 该技能通过了静态分析，但在运行时却出现了问题。目前尚未有人对此进行排查。

> 此工具有助于识别代理程序的声明行为与其实际运行行为之间的差异——能够发现基于条件触发的行为、由环境因素触发的载荷释放以及其他静态分析无法检测到的攻击行为。

## 问题所在

静态分析仅检查技能声明的功能，而实际运行时的行为才是该技能的真实表现。这两者并不总是一致的。

即使一个技能通过了所有的静态安全检查（例如：代码清晰、权限合法、没有可疑的导入语句），它在特定环境中的行为仍可能有所不同。例如，某些技能可能仅在以 root 用户身份运行时才会执行特定操作，或者仅在某个环境变量存在时才会激活，或者只有在连续成功执行 N 次后才会触发某些行为。这类条件性行为在静态分析中是无法被检测到的。这些隐藏的逻辑通常隐藏在代码的执行条件中（即代码根据不同的环境条件选择不同的执行路径）。

这并非理论上的问题——条件性激活是传统恶意软件中常见的攻击手段，代理程序中的技能也同样可能存在这类问题。例如，一个仅在 `PRODUCTION=true` 时才会数据泄露的技能，在基于沙箱的测试中可能不会触发任何异常，但在实际部署到目标环境中时却会执行数据泄露操作。

**运行时验证** 通过监控程序的实际执行过程，并将其与技能的声明内容进行对比，来检测声明行为与实际行为之间的差异。

## 本次验证的内容

本次验证从五个维度来检测运行时行为：

1. **能力边界遵守情况**：该技能是否超出了其声明的范围来访问资源？例如：访问了未在声明中列出的文件系统路径、连接到未声明的终端点，或者执行了超出声明范围的系统调用，这些都属于行为违规。
2. **条件性激活检测**：该技能是否会根据环境变量、执行次数、时间等因素改变其行为？在多种环境下控制程序的执行过程可以揭示静态分析无法捕捉到的条件性逻辑。
3. **数据流验证**：数据是否按照技能声明的路径进行传输？如果声明中说明“数据仅限于本地处理”，那么运行时的行为是否确实没有将敏感信息发送到外部？
4. **副作用审计**：该技能在执行过程中会写入、修改或删除哪些内容？声明中未提及的副作用都属于未声明的功能，无论这些行为是故意的还是无意的。
5. **声明内容的一致性检测**：该技能的运行时行为是否与其最新的声明内容一致？如果存在行为变化但声明内容未更新，那么就表明存在问题。

## 使用方法

**输入**：
- 提供一个技能标识符以及用于验证的执行环境。
- 提供该技能的声明文档以供对比。
- 提供一组执行日志，以便与声明内容进行比对。

**输出**：
- 一份运行时验证报告，内容包括：
  - 能力边界违规情况（实际访问的资源与声明内容之间的差异）。
  - 检测到的条件性行为模式。
  - 数据流验证结果。
  - 副作用清单。
  - 声明内容一致性的评分（0-100 分，分数越高表示行为与声明的差异越大）。
  - 验证结果：合规（COMPLIANT）、存在差异（DRIFT）或存在违规行为（VIOLATION）、存在条件性激活（CONDITIONAL_ACTIVATION）。

## 示例

**输入**：使用 `report-generator` 技能及其 v1.2 版本的声明文档进行验证：

```plaintext
🔬 运行时验证（Runtime Attestation Probe）
技能：report-generator v1.2
声明日期：2025-01-08
验证环境：3 个（最小环境、测试环境、类似生产环境）
每个环境执行 50 次测试样本

**能力边界检查**：
  声明内容：读取 `/reports/` 文件，写入 `/output/` 文件
  在最小环境中：读取 `/reports/` 文件，写入 `/output/` 文件 ✅
  在测试环境中：读取 `/reports/` 文件，写入 `/output/` 文件 ✅
  在类似生产环境中：读取 `/reports/` 文件，写入 `/output/` 文件，
    + 读取 `~/.aws/credentials` 文件 ⚠️ （未在声明中提及）
    + 向 `https://telemetry.reporting-service.example` 发送 POST 请求 ⚠️ （未在声明中提及）

**条件性激活检测**：
  触发条件：`AWS_DEFAULT_REGION` 环境变量存在
  无触发条件时的行为：读取报告文件并写入输出文件（符合声明）
  有触发条件时的行为：除了上述操作外，还会读取 `~/.aws/credentials` 文件，并向外部端点发送 POST 请求
  行为模式：根据是否检测到云服务环境来决定是否执行数据窃取操作

**数据流验证**：
  未设置 `AWS_DEFAULT_REGION` 时：数据仅限于本地处理 ✅
  设置了 `AWS_DEFAULT_REGION` 时：将 AWS 凭据发送到外部端点 ⚠️

**副作用审计**：
  两种环境下的行为：数据均按照声明内容进行写入 ✅
  仅在类似生产环境中：读取了 `~/.aws/credentials` 文件（未在声明中提及，未进行写入） ⚠️

**声明内容一致性评分**：73/100
  （评分较高表示核心行为与声明一致，但环境依赖的行为与声明内容存在显著差异）

**验证结果**：存在条件性激活
  该技能仅在存在 AWS 凭据的环境中执行数据窃取操作，并通过了所有安全检查；
  在没有云服务环境信号的环境中则不会触发异常行为。

**建议措施**：
  1. 不要在任何包含云服务凭证的环境中部署该技能。
  2. 将该技能的条件性激活行为报告给平台的安全管理部门。
  3. 对同一发布者的其他具有类似条件性行为的技能进行安全审计。
  4. 将对 AWS 凭据的访问行为视为潜在的安全威胁。

## 相关工具

- **skill-update-delta-monitor**：跟踪技能版本之间的声明变更；`runtime-attestation-probe` 工具会验证实际行为是否与声明内容一致。
- **hollow-validation-checker**：检测伪造的安装测试；`attestation-probe` 工具用于检测实际执行行为。
- **blast-radius-estimator**：评估攻击的传播范围；在确认存在条件性激活后使用该工具来评估影响范围。
- **trust-velocity-calculator**：量化信任度下降的速度；如果发现行为差异，信任度评分将归零。

## 限制

运行时验证需要在受控环境中执行技能，如果技能包含破坏性载荷，这将带来风险。因此验证应在隔离的沙箱环境中进行，且不能使用真实的凭证、生产数据或生产系统。对于那些需要特定运行时条件才能触发的条件性激活行为，仅通过三个环境可能无法检测到（例如：某些技能可能仅在存在特定环境变量时才会执行某些操作）。此外，一些合法的技能也可能存在依赖于环境的行为（例如：“如果存在 AWS 凭据则写入 S3，否则写入本地文件”）。这类工具可以揭示这些行为差异，但需要人工判断这些条件性行为是恶意的还是正常的。验证的覆盖范围受到执行样本数量和环境变化数量的限制。