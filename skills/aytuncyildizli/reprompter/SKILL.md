---
name: reprompter
description: >
  将杂乱无章的提示转化为结构清晰、高效的提示——适用于单代理或多代理场景。  
  适用场景：  
  - 重新提示（“reprompt”/“reprompt this”）  
  - 清理提示内容（“clean up this prompt”）  
  - 优化提示结构（“structure my prompt”）  
  - 需要使用 XML 标签和最佳实践的文本处理  
  - 多代理任务协调（“multi-agent tasks”）  
  - 并行工作流程（“parallel work”）  
  - 任何需要分配给代理团队的任务  
  不适用场景：  
  - 简单的问答场景  
  - 仅需要立即执行的任务  
  输出结果：  
  - 结构化的 XML/Markdown 格式提示  
  - 提示的质量评分（处理前/处理后）  
  - 可选的团队简报及每个代理的子提示内容  
  - 代理团队的执行结果文件  
  成功标准：  
  - 单代理模式下的提示质量评分 ≥ 7/10  
  - 每个代理的提示质量评分 ≥ 8/10  
  - 所有必要部分均完整呈现，且内容具体、可操作  
  （注：根据文档内容，某些术语可能未被直接翻译，例如 “Repromptception” 可保留原英文名称，因为其可能是特定领域的专有名词。）
compatibility: |
  Single mode works on all Claude surfaces (Claude.ai, Claude Code, API).
  Repromptception mode requires Claude Code with tmux and CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1.
metadata:
  author: AytuncYildizli
  version: 7.0.0
---
# RePrompter v7.0

> **你的提示太糟糕了。让我们来改进它。** 无论是单个提示还是整个代理团队——同一个技能，两种模式可供选择。

---

## 两种模式

| 模式 | 触发条件 | 功能 |
|------|---------|-------------|
| **单模式** | 输入“重新生成提示”或“优化这个提示” | 用于引导用户完成结构化的任务提示，并给出评分 |
| **Repromptception** | 输入“reprompter teams”等指令 | 用于协调多个代理团队，每个代理都会收到提示，并进行评估和重试 |

### 自动检测
如果任务涉及2个或更多系统、包含“audit”或“parallel”等关键词，系统会询问：“这看起来是一个需要多个代理协同的任务。您想使用Repromptception模式吗？”

**定义：** “2个或更多系统”指的是至少两个可以独立处理的不同的技术领域。例如：前端 + 后端、API + 数据库、移动应用 + 后端、基础设施 + 应用代码、安全审计 + 成本审计。

## 不适用的情况
- 用户需要一个简单的直接答案（不需要生成提示）
- 用户希望进行非正式的聊天或对话
- 任务只需要立即执行，不需要重新生成提示
- 任务范围不涉及提示的设计、结构或协调工作

> 说明：RePrompter **支持** 与代码相关的任务（如功能开发、bug修复、API开发、代码重构），它会生成更合适的提示。但在**单模式**下，它不会直接执行代码更改。如果需要执行代码，应使用专门的代码执行工具。

---

## 模式1：单模式

### 工作流程
1. **接收用户输入**
2. **输入验证**：如果输入为空、只包含一个单词且没有动词，或者明显不是任务请求，系统会要求用户描述他们想要完成的任务。
   - 不会被接受的输入示例："hi", "thanks", "lol", "what's up", 仅包含表情符号的输入
   - 被接受的输入示例："修复登录错误", "编写API测试代码", "改进这个提示"
3. **快速模式**：如果输入少于20个单词，且描述的是单一操作且没有复杂性提示，系统会立即生成提示。
4. **智能引导**：使用`AskUserQuestion`功能，向用户展示2-5个可选择的选项。
5. **生成提示并评分**：根据预设的模板生成提示，并显示生成前后的质量指标。

### ⚠️ 必须在引导完成后生成提示
引导完成后，系统会：
1. 根据任务类型选择合适的模板
2. 生成完整的、优化后的提示
3. 显示提示的质量评分（生成前后的对比结果）
4. 询问用户是想要立即执行任务还是复制提示内容

---

### 引导问题
引导问题通过`AskUserQuestion`功能提出。**总共最多5个问题**。

**标准问题**（按优先级排序，如果需要特定于任务的问题，则优先考虑这些问题）：
1. 任务类型：功能开发 / Bug修复 / 代码重构 / 编写测试代码 / API开发 / 用户界面设计 / 安全审计 / 文档编写 / 内容创作 / 研究 / 多代理协作
   - 如果用户在**单模式**下选择了**多代理协作**，系统会立即切换到**Repromptception阶段1（团队计划）**，并确认团队执行模式（并行执行还是顺序执行）。
2. 执行模式：单个代理执行 / 多个代理并行执行 / 由RePrompter决定执行模式
3. 任务目的：面向用户 / 内部工具使用 / Bug修复 / 探索性任务 / 可以跳过这些问题（根据需要）

### 自动检测复杂性
- 如果任务涉及2个或更多不同的技术领域（例如前端 + 后端、API + 数据库、移动应用 + 后端），系统会建议使用**多代理协作**模式。
- 如果任务包含数据采集、处理、部署等环节，系统会建议使用**多代理协作**模式。
- 如果任务只涉及单个文件或组件的处理，系统会建议使用**单个代理执行**模式。
- 如果输入中包含模糊的修饰词（如“better”, “improved”等），系统会要求用户提供更多详细信息，以便生成更准确的提示。

### 快速模式
满足以下条件时，系统会进入快速模式：
- 输入少于20个单词
- 包含明确的操作动词（如add, fix, remove, rename, move, delete, update, create, implement, write, change, configure, test, run）
- 任务目标明确（针对单个文件、组件或标识符）
- 输入中不包含连词（如and, or, plus, also）
- 输入中不包含模糊的修饰词

### 任务类型与模板
系统会根据用户输入自动判断任务类型，并从`docs/references/`目录下选择相应的模板：
- **功能开发**：`feature-template.md`
- **Bug修复**：`bugfix-template.md`
- **代码重构**：`refactor-template.md`
- **测试**：`testing-template.md`
- **API开发**：`api-template.md`
- **用户界面设计**：`ui-template.md`
- **安全审计**：`security-template.md`
- **文档编写**：`docs-template.md`
- **内容创作**：`content-template.md`
- **研究**：`research-template.md`
- **多代理协作**：`swarm-template.md`
- **团队协调**：`team-brief-template.md`

### 如何使用模板
系统会从`docs/references/{类型}-template.md`文件中读取相应的模板，并根据任务的具体内容进行填充。默认情况下，模板不会被预先加载到内存中，只有在生成提示时才会被读取。如果找不到相应的模板，系统会使用基础的XML结构。

### 添加新任务类型的方法
要添加新的任务类型，只需按照以下XML结构创建一个新的`docs/references/{类型}-template.md`文件，然后将其添加到模板列表中。

### 基础XML结构
所有模板都遵循以下核心结构（包含8个必填标签）。如果没有匹配的模板，系统会使用基础结构。

### 项目上下文检测
系统会自动从当前工作目录中检测技术栈信息：
- 扫描`package.json`, `tsconfig.json`, `prisma/schema.prisma`等文件
- 每次会话都会使用新的上下文信息
- 用户可以通过输入“no context”, “generic”或“manual context”来选择不使用上下文信息
- 系统不会扫描上级目录，也不会在会话之间携带上下文信息

---

## 模式2：Repromptception（代理团队）

### 简介
### 关键特点：**
RePrompter在重新生成提示的过程中不会消耗额外的 tokens——提示内容由用户自己编写，而不是由其他AI生成。

### 第1阶段：团队计划（约30秒）
1. 对原始提示进行评分（1-10分）：从清晰度、具体性、结构、约束条件、任务分解等方面进行评估。
2. 选择执行模式：并行执行（每个代理独立工作）或顺序执行（按依赖关系执行）。
3. 定义团队成员：最多2-5名代理，每个代理负责一个特定的技术领域，避免任务重叠。
4. 将团队计划内容写入`/tmp/rpt-brief-{taskname}.md`文件（使用唯一的任务名称以避免重复生成提示）。

### 第2阶段：提示生成与评估（约2分钟）
对于每个代理：
1. 从`docs/references/`目录中选择合适的模板。
2. 根据代理的职责和任务需求，对模板进行个性化修改：
   - `<role>`：指定该代理负责的具体领域
   - `<context>`：提供该代理需要处理的文件路径
   - `<requirements>`：列出至少5个具体且可验证的要求
   - `<constraints>`：明确与其他代理的协作范围和权限
   - `<output_format>`：指定输出文件的路径
   - `<success_criteria>`：定义评估标准

### 第3阶段：执行任务（使用tmux工具）
#### 重要规则
- 必须在CLI启动命令和提示中明确指定`--model opus`参数，以避免使用默认的Haiku模型。
- 每个代理都需要单独发送输入数据。
- 在输入数据和按下Enter键之间需要等待0.5秒，以便系统有足够的时间处理数据。
- 会话开始后需要等待12秒，以便Claude Code有足够的时间进行初始化。
- 每个代理都需要生成自己的输出文件，以避免文件冲突。

### 评估与重试
1. 阅读每个代理的报告，并根据评估标准进行评分：
   - 如果评分在8分以上，则接受结果
   - 如果评分在4-6分之间，则需要重新生成提示并给出具体改进方向
   - 如果评分低于4分，则需要重新生成提示并重新尝试

### 预期成本与时间
- 2名代理：约5-8分钟，成本约1-2美元
- 3名代理：约8-12分钟，成本约2-3美元
- 4名代理：约10-15分钟，成本约2-4美元
这些成本仅包括第3阶段的执行时间。第1-2阶段和每次重试需要额外的时间。

### 备用方案
当tmux或Claude Code不可用时，可以使用`sessions_spawn`工具（仅适用于OpenClaw环境）。

---

## 质量评分
系统会在生成提示前后显示质量指标：
| 评分维度 | 权重 | 评估标准 |
|-----------|--------|----------|
| 清晰度 | 20% | 任务描述是否清晰？ |
| 具体性 | 20% | 需求是否明确？ |
| 结构 | 15% | 文档结构是否合理？ |
| 约束条件 | 15% | 任务边界是否明确？ |
| 可验证性 | 15% | 任务结果是否可验证？ |
| 任务分解 | 15% | 任务是否被合理地分解？ |

### 偏见说明
评分结果仅供参考，不代表绝对的准确性。

---

## 闭环质量评估（v6.0及以上版本）
RePrompter支持任务执行后的评估：
- **改进**：根据用户提供的原始提示生成更清晰的提示
- **执行**：仅在Repromptception模式下，系统会将提示发送给代理团队并收集结果。
- **评估**：根据评估标准对执行结果进行评分（0-10分）
- **重试**：如果评分低于7分，则需要重新生成提示；如果评分低于8分，则需要重新尝试。

---

## 高级功能
- **推理导向的提示设计**：提示应侧重于任务的目标和要求，而不是具体的执行步骤。让模型自己决定执行策略。
- **响应预填充**：在某些情况下，系统会预先填充提示内容，以确保格式的一致性。
- **上下文优化**：生成的提示应补充运行时的上下文信息，而不是重复已有的信息。
- **token预算**：单模式生成的提示长度应控制在2000个tokens以内；每个代理生成的提示长度应控制在1000个tokens以内。过长的提示会浪费资源且无法提高质量。

---

## 设置选项
`CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS`是一个实验性设置，未来可能会发生变化。请查看[Claude Code文档](https://docs.anthropic.com/en/docs/claude-code)以获取最新信息。

在`~/.claude/settings.json`文件中可以配置以下选项：
- `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS`：启用代理团队协作功能
- `teammateMode`：指定团队协作使用的工具（`tmux`或`default`）
- `model`：指定团队协作使用的模型（`opus`或`sonnet`）

---

## 实际测试结果
- **单模式**：在处理简单任务时，提示质量显著提高。
- **多代理协作**：在处理复杂任务时，团队协作模式的效果更好。

---

## 使用建议
- 提供更多上下文信息可以减少提示生成的步骤。
- 如果快速模式生成的提示过于简单，可以重新进行引导。
- 对于简单任务，可以选择快速模式。
- 如果不需要自动检测上下文信息，可以忽略相关设置。
- 注意：每次切换目录时，系统会重新检测上下文信息。

---

## 测试方案
详细测试方案请参见[TESTING.md]文件。

---

## 扩展标签
模板中可以添加额外的领域特定标签。在使用扩展标签时，请确保先包含所有的基础标签。

---

## 注意事项
RePrompter的某些功能（如代理团队协作和自动检测）可能依赖于特定的环境和工具（如OpenClaw和tmux）。