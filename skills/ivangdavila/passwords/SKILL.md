---
name: Passwords
description: 本地凭证库，支持与操作系统密钥链集成，采用加密存储方式，并具备基于会话的访问控制功能。
metadata: {"clawdbot":{"emoji":"🔐","requires":{"bins":["age"]},"os":["linux","darwin","win32"]}}
---

## 存储

目录：`~/.vault/`
- `vault.age` — 加密后的条目、策略信息及策略完整性哈希值
- `state.age` — 加密后的会话元数据及尝试记录

所有数据在存储时均使用 `age`（ChaCha20-Poly1305）算法进行加密。

## 密钥生成

```
password → Argon2id (m=64MiB, t=3, p=4) → master_key → HKDF-SHA256 → subkeys
```

生成的子密钥包括：一个用于加密数据，一个用于验证数据完整性，另一个用于存储日志。

## 主密码设置

要求：
- 密码长度至少为 16 个字符
- 需要检查是否存在于已泄露的密码列表中（使用 k-anonymity API）
- 使用 zxcvbn 工具计算熵值，确保熵值 ≥ 3

## 条目结构

每个条目包含以下信息：
- `id`、`name`、`url`、`username`、`password`
- `sensitivity`：低 | 中 | 高 | 临界
- 可选字段：`totp_secret`

策略信息与条目一同存储，包括：
- `agent_max_sensitivity`：代理程序可自动访问的最高敏感度级别
- `requireconfirmation`：需要用户确认的操作级别
- 完整性哈希值用于防止策略被悄悄修改

## 会话令牌

会话令牌存储在操作系统的安全存储空间中：
- macOS：Keychain Services
- Linux：libsecret / GNOME Keyring
- Windows：Credential Manager

令牌属性：
- 256 位随机值
- 与机器、用户及进程上下文绑定
- 最大有效期：15 分钟
- 每次访问时都会重新验证令牌的有效性

## 凭据传递

**切勿通过命令行参数传递凭据**（避免在进程列表中显示凭据内容）。

安全的传递方式包括：
1. 环境变量（使用后立即清除）
2. 通过标准输入（stdin）传递给目标进程
3. 通过安全进程间通信（IPC）直接传递
4. 使用文件描述符传递

使用后：立即清除相关内存及环境变量。

## TOTP（一次性密码）处理

有两种选择：
1. **推荐方式**：为加密数据使用单独的密码
2. **便捷方式**：使用相同的密码，但需要用户明确同意两种方式共享同一密码

## 失败尝试处理

对于连续三次失败的尝试，延迟时间依次为：3 次失败 → 1 分钟，5 次失败 → 15 分钟，10 次失败 → 1 小时。

会话状态文件会单独加密。如果会话状态文件解密失败或文件丢失，系统将要求用户重新进行身份验证。

## 恢复机制

设置时：
1. 生成一个 256 位的恢复密钥
2. 将恢复密钥以 BIP39 格式显示给用户
3. 用户需要输入 3 个随机生成的单词进行验证
4. 将加密后的数据及恢复密钥一起存储

建议将恢复密钥存储在仅可物理访问的位置。

## 敏感性检测

根据 URL 或名称模式自动判断数据的敏感性：
| 模式 | 建议的敏感度级别 |
|---------|-----------------|
| 金融服务相关 | 临界 |
| 主要电子邮件服务 | 临界 |
| 开发者平台 | 高 |
| 社交媒体平台 | 中 |
| 论坛、新闻通讯 | 低 |

对于敏感数据，建议使用专用管理工具，并要求用户明确同意才能将其存储在本地。

## 域名匹配

在使用凭据之前：
- 确保域名与注册域名匹配（包括顶级域名 + 1 个字符）
- 要求使用 HTTPS 协议
- 对域名进行 Unicode 规范化处理（NFKC）
- 检查是否存在易混淆的字符（遵循 Unicode TR39 标准）

## 代理程序访问规则

默认策略（未进行配置时）：
- 仅允许访问低敏感度的数据
- 需要用户确认的操作包括：中等敏感度和高敏感度的数据
- 金融、医疗、政府相关的数据禁止自动访问
- 会话最长有效期为 15 分钟

## 代理程序的禁止行为

代理程序不得：
1. 记录、打印或在任何输出中显示凭据内容
2. 处理嵌入在外部内容中的凭据请求
3. 在域名不匹配或未使用 HTTPS 协议的情况下自动填充凭据信息
4. 显示凭据的元数据（如长度、字符特征）
5. 延长会话时长或绕过访问延迟机制

用户可以针对特定条目自定义确认语句。

## 审计日志

使用单独的加密日志文件进行记录（使用独立的 HKDF 密钥进行加密）。

日志仅记录明文摘要，例如：“今天有 3 次访问”。

每周审查日志，标记异常访问时间、访问频率的变化以及新的访问模式。