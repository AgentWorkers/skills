---
name: Billing
slug: billing
version: 1.0.0
description: 构建支持支付集成、订阅管理、发票生成的系统；这些系统需要具备Webhook处理功能，同时要符合税收法规并能够准确识别收入。
metadata: {"clawdbot":{"emoji":"💳","requires":{"bins":[]},"os":["linux","darwin","win32"]}}
---
## 使用场景

当用户需要实现或调试支付处理、订阅生命周期管理、发票生成或收入相关操作时，可以使用这些文档。系统管理员将负责处理与Stripe/Paddle的集成、Webhook架构的配置、多货币支持、税务合规性、退款处理、基于使用量的计费方式、市场交易中的收入分配以及收入确认规则等相关工作。

## 快速参考

| 主题 | 对应文件 |
|-------|------|
| Stripe集成 | `stripe.md` |
| Webhook与事件 | `webhooks.md` |
| 订阅生命周期 | `subscriptions.md` |
| 发票生成 | `invoicing.md` |
| 税务合规 | `tax.md` |
| 基于使用量的计费 | `usage-billing.md` |
| 退款与纠纷处理 | `disputes.md` |
| 市场交易支付 | `marketplace.md` |
| 收入确认 | `revenue-recognition.md` |

## 核心规则

### 1. 货币单位必须精确到最小单位
- Stripe及大多数支付服务提供商（PSP）使用分作为货币单位：`amount: 1000` 表示 $10.00
- 金额应存储为整数，切勿使用浮点数（浮点数运算可能导致错误）
- 变量名中必须明确货币单位，例如：`amount_cents_usd`
- 不同货币的小数位数不同（例如：JPY为0位，KWD为3位）

### 2. Webhook的安全性至关重要
- 在处理请求之前必须验证签名（使用`Stripe-Signature`头部）
- 存储`event_id`并检查请求的幂等性（防止重复请求）
- 事件可能以乱序到达，因此需要设计状态机而非顺序处理流程
- 使用原始请求体进行签名验证，而非解析后的JSON数据
- 详细实现方式请参考`webhooks.md`

### 3. 订阅状态机的使用
关键状态及其转换规则：
| 状态 | 含义 | 访问权限 |
|-------|---------|--------|
| `trialing` | 免费试用期 | ✅ 全部功能可用 |
| `active` | 已付费且当前有效 | ✅ 全部功能可用 |
| `past_due` | 支付失败，正在重试 | ⚠️ 有宽限期 |
| `canceled` | 订阅将在周期结束时终止 | ✅ 直到周期结束 |
| `unpaid` | 重试次数用尽 | ❌ 无访问权限 |

**注意**：切勿仅根据`status === 'active'`来授予访问权限，还需检查`current_period_end`。

### 4. 取消与删除的区别
- `cancel_at_period_end: true`：允许访问直到周期结束，但不会自动续订
- `subscription.delete()`：立即终止订阅，可能涉及退款
- 混淆这两种操作可能导致收入损失或引发客户不满
- 默认设置为`cancel_at_period_end`；只有在用户明确要求时才执行`subscription.delete()`。

### 5. 计费分摊方式需明确指定
在订阅周期中途更改计划时：
| 模式 | 行为 | 适用场景 |
|------|----------|----------|
| `create_prorations` | 退还未使用的费用，并重新计费 | 标准升级 |
| `none` | 仅在续订时进行费用调整 | 降级 |
| `always_invoice` | 立即收费/退款 | 企业级计费模式 |

**注意**：切勿依赖支付服务提供商的默认设置，每次都需要明确指定计费分摊方式。

### 6. 必须注意竞态条件
`customer.subscription.updated`通常会在`invoice.paid`之前触发。因此：
- 设计系统时要确保数据最终一致性
- 使用数据库事务来处理访问权限的变更
- 实现幂等性的处理逻辑，以便在出现问题时能够安全地重新处理请求
- 在授予或撤销访问权限前务必检查订阅状态

### 7. 税务合规是强制性的
- **不同场景下的处理方式**：
  - 同一国家内：收取本地增值税（VAT）/销售税
  - 欧盟B2B交易（且VAT有效）：采用0%的反向收费机制（需通过VIES验证）
  - 欧盟B2C交易：根据买家所在国家收取增值税（MOSS）
  - 美国：销售税因地区而异（超过11,000个司法管辖区）
  - 出口交易（非欧盟地区）：通常免征增值税

**注意**：缺少必要的发票字段会导致发票无效。详情请参阅`tax.md`。

### 8. PCI-DSS安全规范
- **严禁**存储信用卡卡号（PAN）、CVV码或磁条数据
- 仅存储支付服务提供商提供的令牌（如`pm_*`、`cus_*`）
- 令牌化过程应在客户端完成（例如使用Stripe.js、Elements库）
- 即使存储“最后四位数字+有效期”，也属于PCI安全规范禁止的范围
- 有关合规性实现方式，请参阅`disputes.md`。

### 9. 退款处理有时间限制
- **各个阶段的时间线及应对措施**：
  - 询问阶段（1-3天）：主动提供相关证据
  - 争议开启阶段（7-21天）：提交有力证据
  - 超过截止日期：自动视为退款失败
> 连续3次支付失败可能导致欺诈监控系统触发警报

### 10. 收入确认与实际收款不等于
- 根据ASC 606/IFRS 15标准，SaaS服务的收入确认方式如下：
  - 年度付款不等于年度收入（收入按月确认）
  - 延期收入属于负债，而非资产
  - 多元素合同中的收入需根据具体服务条款进行分配
- 详细会计处理方式请参阅`revenue-recognition.md`。

## 常见问题与注意事项

### 安全与合规性问题
- **Webhook安全**：
  - 未验证签名的Webhook可能导致攻击者伪造`invoice.paid`状态
  - 将令牌存储在前端JavaScript中可能导致数据泄露
  - 日志中包含CVV码违反PCI安全规范，可能面临巨额罚款
  - 无限次的重试循环可能触发欺诈监控机制

### 集成错误
- 未存储`subscription_id`会导致退款无法匹配
- 误认为支付成功即表示交易完成（即使使用了3D Secure技术）
- 忽略`payment_intent.requires_action`字段可能导致支付失败

### 财务错误
- 硬编码税率可能导致计算错误
- 当支付服务提供商要求使用分作为货币单位时，使用美元金额可能导致多倍收费
- 在年度订阅计划中一次性收取全部费用可能导致审计问题
- 对订单、账单和收入的混淆可能导致重大财务差异

### 操作错误
- 在合同宽限期发送支付提醒可能导致客户不满
- 未检查未解决的争议就发送催款通知可能导致双重收费
- 未指定计费分摊模式可能导致客户被意外收费
- 未检查是否存在退款请求就进行退款操作可能导致重复支付