---
name: JWT
slug: jwt
version: 1.0.1
description: 实现安全的 JWT（JSON Web Tokens）认证机制，包括适当的验证流程、令牌生命周期管理以及密钥管理。
metadata: {"clawdbot":{"emoji":"🔐","os":["linux","darwin","win32"]}}
---

## 快速参考

| 主题 | 文件 |
|-------|------|
| 算法选择 | `algorithms.md` |
| 令牌生命周期 | `lifecycle.md` |
| 验证检查表 | `validation.md` |
| 常见攻击 | `attacks.md` |

## 安全基础

- JWT（JSON Web Tokens）是经过签名处理的，而非加密的——任何人都可以解码并读取其内容；切勿在其中存储敏感信息（如密码）。
- 在信任令牌中的信息之前，务必验证其签名；未经验证的签名对身份验证毫无用处。
- **“alg: none”攻击**：应拒绝使用“alg: none”作为算法的令牌——某些库可能会接受未经签名的令牌。
- 使用强密码：HS256算法需要至少256位的密钥；过短的密钥容易被暴力破解。

## 算法选择

- **HS256 (HMAC)**：对称加密算法，使用相同的密钥进行签名和验证——适用于单服务场景。
- **RS256 (RSA)**：非对称加密算法，使用私钥签名、公钥验证——适用于分布式系统。
- **ES256 (ECDSA)**：签名长度比RSA更短，安全性相同——适用于对签名长度有要求的场景。
- **切勿让令牌决定使用的算法**：应在服务器端根据预期的算法进行验证。

## 必需的令牌字段

- `exp`（过期时间）：必须设置并进行验证；没有过期时间的令牌将永久有效。
- `iat`（发行时间）：记录令牌创建的时间——有助于制定失效策略。
- `nbf`（“not before”字段）：指定令牌的有效起始时间——适用于需要控制访问时间的场景。
- 在验证时间字段时，允许30-60秒的时间偏差。

## 令牌的接收者和发行者

- `iss`（发行者）：创建令牌的实体——验证该字段以防止跨服务间的令牌盗用。
- `aud`（接收者）：令牌的预期接收者——API应拒绝发给其他接收者的令牌。
- `sub`（主体）：令牌所代表的用户或实体——通常为用户的ID。
- **令牌混淆攻击**：如果未验证`aud`和`iss`字段，一个服务的令牌可能会被误用在另一个服务上。

## 令牌生命周期

- **访问令牌**：生命周期较短（5-15分钟），即使被窃取也能减少损失。
- **刷新令牌**：生命周期较长，存储方式需安全，仅用于获取新的访问令牌。
- **令牌轮换**：每次使用时都应生成新的刷新令牌，并使旧令牌失效。
- **撤销令牌**：由于JWT是无状态的，因此撤销较为困难；可以通过设置较短的过期时间或使用刷新机制来实现，或者维护一个黑名单。

## 令牌存储方式

- **httpOnly cookie**：可防止XSS攻击，但需要额外的CSRF保护。
- **localStorage**：容易受到XSS攻击，但对于单页应用程序（SPA）来说使用较为方便。
- **仅存储在内存中**：最安全的方式，但页面刷新时会丢失令牌。
- **切勿将令牌存储在URL参数中**：这些参数可能会被记录在日志、浏览历史记录或引用头中。

## 验证检查表

- 使用正确的算法验证签名（不要依赖请求头中的`alg`字段）。
- 确保`exp`字段表示的过期时间在未来（允许一定的时间偏差）。
- 检查`iat`字段是否合理（可选）。
- 验证`iss`字段是否与预期的发行者匹配。
- 如果存在`nbf`字段，也需要进行验证。

## 常见错误

- 在令牌的有效载荷中存储敏感数据——这些数据只是经过Base64编码，并未加密。
- 使用过大的有效载荷——JWT的头部大小有限制（通常不超过8KB）。
- 不设置过期时间——会导致令牌永久有效，从而带来安全风险。
- 在不同环境中使用相同的密钥——开发环境中的令牌可能无法在生产环境中正常使用。
- 记录令牌信息——令牌属于敏感信息，应像处理密码一样对待它们。

## 密钥轮换

- 使用`kid`（密钥ID）字段来标识生成令牌的密钥。
- 使用JWKS（JSON Web Key Set）接口来分发公钥。
- 在过渡期间，新旧密钥可以同时使用。
- 密钥轮换后，旧令牌仍然有效，直到它们过期——请做好相应的处理计划。

## 实现方式

- 使用成熟的库来实现JWT的生成和验证功能——不要自行编写解析逻辑。
- 可用的库包括：`jsonwebtoken`（Node.js）、`PyJWT`（Python）、`java-jwt`（Java）、`golang-jwt`（Go）。
- 中间件应在任何业务逻辑之前立即拒绝无效的令牌。