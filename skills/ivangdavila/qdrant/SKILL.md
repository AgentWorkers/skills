---
name: Qdrant
slug: qdrant
version: 1.0.0
description: 使用 Qdrant 构建向量搜索系统，该系统结合了集合（collections）、数据负载（payloads）、过滤功能以及优化的索引机制，以实现语义相似性的高效检索。
metadata: {"clawdbot":{"emoji":"🔍","requires":{"bins":[]},"os":["linux","darwin","win32"]}}
---
## 使用场景

当用户需要执行向量相似度搜索、语义搜索或推荐系统功能时，该代理可以处理数据集的创建、数据点的插入、过滤查询以及索引的优化工作。

## 快速参考

| 主题 | 对应文件 |
|-------|------|
| 查询模式 | `queries.md` |
| 性能调优 | `performance.md` |

## 核心规则

### 1. 数据集设置
- 将向量维度设置为与嵌入模型相匹配（例如：OpenAI ada-002 的维度为 1536）
- 仔细选择距离度量方式：对于标准化后的嵌入向量使用 `Cosine`，对于原始分数使用 `Dot`，对于绝对距离使用 `Euclid`
- 如果向量维度设置错误，会导致查询失败且返回结果为空

### 2. 载荷数据策略
- 将可过滤的元数据存储为载荷字段
- 对于在过滤操作中使用的载荷字段，需要创建相应的索引：`create_payload_index`
- 不要在载荷数据中存储大型数据块——建议使用外部存储并引用相应的 ID

### 3. 批量操作
- 以 100 到 1000 个数据点的批次进行插入，而不是逐个插入
- 使用 `upsert` 操作根据 ID 处理重复数据
- 使用 `wait=false` 进行并行上传，之后通过数据集信息进行验证

### 4. 过滤方式的选择
| 使用场景 | 选择过滤方式 |
|------|-----|
| 已知约束条件 | 在查询时直接进行过滤（预过滤） |
| 分数阈值 | 使用 `score_threshold` 参数 |
| 复杂逻辑 | 结合使用 `must`、`should`、`must_not` 来构建过滤条件 |

- 预过滤可以缩小搜索范围，从而提高搜索速度
- 在结果集上进行后过滤会降低搜索速度，可能会遗漏相关数据

### 5. 搜索方式的选择
| 使用场景 | 选择搜索方式 |
|------|-----|
| 获取前 K 个相似结果 | 使用 `search` |
| 获取所有匹配结果 | 使用 `scroll` 并结合过滤条件 |
| 分页显示结果 | 使用 `scroll` 并设置 `offset` |
| 导出/备份数据 | 使用 `scroll` 并结合分页功能 |

### 6. 索引优化
- HNSW（Hierarchical Neural Search with Weighting）参数：增加 `m` 可以提高召回率，增加 `ef_construct` 可以提高索引质量
- 默认设置 `m=16, ef_construct=100` 适用于大多数情况
- 对于包含数百万个向量的数据集，启用 `on_disk` 存储方式
- 使用量化技术（`scalar` 或 `product`）可以减少 4 到 8 倍的内存占用

### 7. 多租户管理
- 为每个租户设置专用的载荷字段和过滤条件
- 或者为每个租户创建独立的数据集（隔离性更好，但管理难度增加）
- 绝不要让一个租户的数据被其他租户访问

## 常见错误与注意事项
- 创建数据集时向量维度设置错误 → 所有搜索操作都会返回空结果
- 插入数据时忘记设置 `wait=true` → 数据尚未索引就进行查询
- 在大型数据集上使用无限制的滚动功能 → 可能导致内存耗尽
- 不对载荷字段进行索引 → 过滤查询时需要扫描整个数据集
- 将嵌入向量存储在载荷数据中而不是专门的向量字段中 → 会违背设计的初衷