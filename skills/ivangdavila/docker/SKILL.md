---
name: Docker
slug: docker
version: 1.0.2
description: 使用图像优化、网络配置以及适用于生产环境的最佳实践来构建、保护并部署 Docker 容器。
---

## 使用场景

用户需要具备Docker相关专业知识，包括从构建镜像到进行生产环境部署的全过程。Agent负责处理Dockerfile、Docker Compose编排、网络配置、安全加固以及故障排查等任务。

## 快速参考

| 主题 | 文件名 |
|-------|------|
| Dockerfile最佳实践 | `images.md` |
| Docker Compose模式 | `compose.md` |
| 网络与卷管理 | `infrastructure.md` |
| 安全加固 | `security.md` |

## 镜像构建中的常见陷阱

- 将`apt-get update`和`apt-get install`命令分别放在不同的RUN层中会导致包更新不及时（几周后仍使用旧版本）——应将它们合并到一个RUN层中。
- 当前的`python:latest`版本可能与未来的版本不同——建议指定具体版本，例如`python:3.11.5-slim`。
- 在多阶段构建过程中，如果忘记使用`--from=builder`选项，可能会导致从错误的阶段复制依赖项。
- 在每次文件更改时执行`COPY`命令会清除构建缓存——应先复制依赖项，再安装它们，最后复制代码。

## 运行时崩溃问题

- 默认的日志驱动程序没有大小限制——一个“话多”的容器可能会占用大量磁盘空间并导致主机系统崩溃。
- 内存不足（OOM）会导致系统突然终止——可以通过`-m 512m`为每个容器设置内存限制。
- 容器默认以root用户身份运行——应使用`USER nonroot`设置用户权限，否则安全扫描会失败，某些平台也会拒绝该容器。
- 容器内的`localhost`地址是容器自身的地址，而非主机地址——需要将其绑定到`0.0.0.0`。

## 网络配置中的常见陷阱

- 容器的DNS解析仅在自定义网络中有效——默认的桥接网络无法解析容器名称。
- 公开发布的端口默认绑定到`0.0.0.0`——若仅限本地访问，则应使用`127.0.0.1:5432:5432`。
- 被终止的容器可能会留下“僵尸连接”——需要设置适当的健康检查机制和重启策略。
- 如果某个端口已被其他容器占用，之前的容器可能无法正常启动——需要等待或强制删除该容器。

## Docker Compose配置中的常见陷阱

- `depends_on`指令会等待容器启动完成，而非服务准备好——应使用`condition: service_healthy`结合健康检查来判断服务是否可用。
- 如果`.env`文件位于错误的位置，Docker Compose会忽略该文件——该文件必须位于`docker-compose.yml`文件旁边。
- 卷挂载可能会导致容器内的文件被覆盖——确保主机目录中的文件未被删除。
- YAML中的锚点（anchors）在不同文件间无法正确传递——这种做法已被弃用，建议使用多个`docker-compose.yml`文件来管理配置。

## 卷与数据管理

- 通过`Dockerfile`中的`VOLUME`指令创建的匿名卷会持续累积数据——建议使用命名卷。
- 使用绑定挂载（bind mounts）时可能存在权限问题——容器用户必须与主机用户相同，或者使用`:z`后缀来指定权限。
- `docker system prune`命令无法删除命名卷——需要使用`-volumes`参数显式指定要删除的卷。
- 停止运行的容器中的数据会一直保留——需要使用`docker rm`命令删除这些数据。

## 资源泄漏问题

- 未使用的镜像会无限占用存储空间——应定期使用`docker image prune`清理这些镜像。
- 构建缓存会不断增长——可以使用`docker builder prune`来释放空间。
- 停止运行的容器会占用磁盘空间——可以使用`docker container prune`或`--rm`命令删除这些容器。
- 多个Docker Compose项目可能会创建大量网络——需要使用`docker network prune`来清理这些网络。

## 秘密信息与安全防护

- 使用`ENV`或`COPY`命令将敏感信息写入镜像历史记录中会导致这些信息永久保存——建议使用专门的秘密管理工具或运行时环境变量来存储敏感信息。
- 使用`--privileged`选项会取消所有安全限制——这种做法几乎是不必要的，应寻找更具体的安全解决方案。
- 来自未知注册表的镜像可能存在安全隐患——请验证镜像的来源。
- 构建参数会显示在镜像历史记录中——切勿将它们用于存储敏感信息。

## 调试技巧

- 系统终止代码137表示内存不足（OOM），代码139表示段错误（segfault）——可以使用`docker inspect --format='{{.State.ExitCode}}`来查看错误原因。
- 如果容器无法启动，即使日志显示成功，也应检查日志文件——可以使用`docker logs <container>`来查看详细信息。
- 在无发行版（distroless）的容器中无法使用shell——可以使用`docker cp`命令将文件复制到主机，或者使用调试工具（如sidecar）进行调试。
- 可以通过`docker cp deadcontainer:/path ./local`来查看已终止容器的文件系统内容。