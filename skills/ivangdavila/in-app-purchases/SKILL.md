---
name: In-App Purchases
slug: in-app-purchases
version: 1.0.0
description: 使用 RevenueCat 在 iOS、Android 和 Flutter 平台上实现应用内购买和订阅功能，包括支付墙、交易验证以及订阅数据分析。
metadata: {"clawdbot":{"emoji":"💳","requires":{"bins":[]},"os":["linux","darwin","win32"]}}
---
## 使用场景

当用户需要实现应用内购买、订阅、付费墙或货币化功能时，可以使用本指南中的相关内容。本指南涵盖了原生API（如StoreKit 2、Google Play Billing）、跨平台SDK（如RevenueCat、Adapty、Qonversion）的调用方式，以及付费墙的设计、服务器验证和订阅数据分析等流程。

## 快速参考

| 主题 | 对应文件 |
|-------|------|
| iOS StoreKit 2 | `storekit.md` |
| Android Billing | `google-play.md` |
| Flutter相关包 | `flutter.md` |
| RevenueCat SDK | `revenuecat.md` |
| 平台比较 | `platforms.md` |
| 服务器验证 | `server.md` |
| 付费墙设计 | `paywalls.md` |
| 订阅数据分析 | `analytics.md` |
| 测试与沙箱环境 | `testing.md` |

## 核心规则

### 1. 选择合适的架构

| 架构类型 | 适用场景 | 相关权衡 |
|---------|------------|-------------------|
| **纯原生架构** | 仅支持单一平台，具有完全控制权 | 需编写更多代码，无法实现跨平台同步 |
| **RevenueCat/Adapty** | 支持跨平台，快速上线 | 需支付1-2%的费用，且存在依赖性 |
| **混合架构** | 结合原生代码与自定义后端 | 具有完全的控制权，但开发工作量较大 |

### 2. 平台SDK（托管服务）

| 平台 | 费用结构 | 适用场景 |
|-------|-------------|-------------------|
| RevenueCat | 免费（月交易量<2.5k次）；超过后收取1%费用 | 适用于大多数应用，文档齐全 |
| Adapty | 免费（月交易量<10k次）；超过后收取0.6%费用 | 适合注重成本控制的应用，适用于A/B测试场景 |
| Qonversion | 免费（月交易量<10k次）；超过后收取3%费用 | 设置简单 |
| Superwall | 专注于付费墙功能 | 仅适用于付费墙的A/B测试 |
| Glassfy | 免费（月交易量<10k次）；超过后收取0.5%费用 | 经济实惠的选择 |

### 3. 产品类型

| 产品类型 | iOS | Android | 适用场景 |
|---------|------|-------------------|
| **消耗型产品** | ✅ | ✅ | 适用于购买虚拟货币、道具等 |
| **非消耗型产品** | ✅ | ✅ | 适用于解锁永久性功能 |
| **自动续订产品** | ✅ | ✅ | 适用于订阅服务 |
| **非自动续订产品** | ✅ | ❌ | 适用于季票、限时内容 |

### 4. 服务器验证的重要性

切勿仅依赖客户端验证：
- **iOS**：使用App Store的Server API并进行JWS验证 |
- **Android**：使用Google Play Developer API |
- **RevenueCat**：结合Webhooks和REST API进行验证

### 5. 管理所有交易状态

| 交易状态 | 应对措施 |
|---------|-------------------|
| **已购买** | 验证后授予访问权限 | |
| **待处理** | 显示待处理状态 | |
| **失败** | 显示错误信息，不授予访问权限 | |
| **延迟处理** | 等待家长批准 | |
| **退款** | 立即撤销访问权限 | |
| **宽限期** | 限制访问权限，提示用户支付 | |
| **重试支付** | 在重试期间保持用户访问权限 |

### 6. 订阅生命周期事件

必须处理以下所有事件（无论是通过原生方式还是Webhooks）：
- **初次购买**：授予访问权限 |
- **续订**：延长访问权限 |
- **取消**：标记订阅即将到期 |
- **到期**：撤销访问权限 |
- **账单生成**：提示用户更新支付信息 |
- **宽限期**：提供有限的访问权限 |
- **价格调整**：需要用户重新同意 |
- **退款**：撤销访问权限并标记用户状态 |
- **升级/降级**：根据新价格重新计算费用

### 7. 始终恢复用户的购买记录

遵循App Store的指导原则：
- 提供明显的恢复购买按钮 |
- 支持已登出用户的恢复操作 |
- 支持家庭共享功能（iOS） |
- 实现跨设备数据同步

### 8. 付费墙的最佳实践

详细内容请参阅`paywalls.md`：
- 在显示价格前先展示产品的价值 |
- 使用三种定价方式（突出中间选项） |
- 显著展示免费试用功能 |
- 如有社交证明（如用户评价），请予以展示 |
- 对所有功能进行A/B测试

### 9. 测试策略

| 测试环境 | iOS | Android |
|---------|--------|-------------------|
| 开发/调试环境 | 使用StoreKit配置文件 | 由授权测试人员测试 |
| 沙箱环境 | 使用沙箱账户 | 内部测试 |
| 生产环境 | 使用真实用户账户 | 在生产环境中进行测试 |

**沙箱环境的订阅时长限制**：
- 1周 → 3分钟 |
- 1个月 → 5分钟 |
- 1年 → 1小时

### 10. App Store的指导原则

- 禁止使用外部支付链接（防止用户被引导至其他支付渠道） |
- 数字商品必须通过IAP进行销售 |
- 实体商品或服务可以使用Stripe等支付平台 |
- 阅读类应用可例外处理 |
- 收取15-30%的佣金

## 常见错误与陷阱

- **使用真实资金进行测试**：应使用沙箱环境或测试账户 |
- **交易未完成**：自动退款（Android系统通常在3天内退款） |
- **价格硬编码**：始终从应用商店获取最新价格信息 |
- **未设置交易监听机制**：可能导致用户在其他地方完成的购买记录丢失 |
- **忽略宽限期**：用户可能在宽限期结束后失去购买权限 |
- **糟糕的付费墙用户体验**：无论价格如何，都会影响转化率 |
- **未跟踪相关数据**：无法优化产品功能 |
- **忘记设置恢复购买按钮**：可能导致应用被App Store拒绝 |
- **未处理家庭共享功能**：用户可能会感到困惑 |