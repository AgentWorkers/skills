---
name: Deploy
description: 通过持续集成（CI/CD）流程、回滚策略以及零停机时间的部署模式，确保应用程序能够可靠地部署。
metadata: {"clawdbot":{"emoji":"🚀","os":["linux","darwin","win32"]}}
---

# 部署规则

## 部署前检查清单
- 持续集成（CI）中的测试必须通过——切勿在测试失败的情况下进行部署
- 目标环境中已设置环境变量——缺少环境变量会导致系统无声故障
- 在代码部署前执行数据库迁移——新代码需要新的数据库架构，否则会失败
- 准备好回滚计划——在需要时能够迅速恢复系统状态

## 部署策略
- **滚动部署（Rolling）**：逐个更新实例——安全性较高，但速度较慢，且不会占用额外资源
- **蓝绿部署（Blue-green）**：使用完全平行的环境环境，可立即切换——部署速度快，但需要双倍的资源
- **金丝雀部署（Canary）**：将部分流量路由到新版本——有助于尽早发现潜在问题，但配置较为复杂
- 根据风险承受能力和资源情况选择合适的部署策略——没有适用于所有情况的最佳方案

## 零停机时间部署
- 在流量路由到新系统之前，必须通过健康检查——不健康的实例应被隔离
- 优雅关闭：在终止服务前完成正在处理的请求
- 数据库变更必须具备向后兼容性——在新版本部署期间，旧版本仍可正常运行
- 会话管理：使用持久化会话或外部会话存储机制——确保用户数据不会丢失

## 持续集成/持续部署（CI/CD）流程
- 编译一次代码，即可部署到所有环境（包括测试环境和生产环境）——使用相同的代码包
- 在不同构建过程中缓存依赖项——每次部署可节省大量时间
- 尽可能并行执行构建步骤（如测试、代码检查、安全扫描）
- 快速发现错误：先进行快速检查——不要等待耗时的测试来发现代码错误
- 使用SHA值来固定代码版本——标签可能会意外更改

## 环境管理
- 测试环境应与生产环境保持一致——不同的配置可能导致在测试环境中正常运行的代码在生产环境中出现问题
- 环境变量应存储在专用管理工具中（而非环境配置文件中）——便于定期轮换而无需重新部署
- 通过功能标志（Feature Flags）来控制功能的启用或禁用——可以在后续阶段再启用新功能
- 除环境变量外，所有配置信息都应作为代码进行版本控制

## 数据库迁移
- 迁移操作必须在部署期间保持向后兼容性
- 先添加可为空的列，然后填充数据，最后添加约束条件
- 绝不要一步完成列名的修改——先添加新列，再迁移数据，最后删除旧列
- 使用生产环境规模的数据进行迁移测试——少量数据（如10条记录）的迁移速度较快，而大量数据（如1000万条记录）的迁移速度较慢
- 每次迁移都应准备相应的回滚脚本

## 回滚机制
- 在健康检查失败时自动执行回滚操作
- 确保旧版本的代码和配置文件仍可访问——无法恢复已删除的数据
- 数据库回滚操作较为复杂——应设计合理的迁移方案以避免需要回滚
- 使用功能标志来实现功能的即时回滚（无需重新部署）
- 详细记录回滚步骤——在紧急情况下，时间就是生命

## 部署后的监控
- 部署后15分钟内密切关注错误率——大多数问题会在这段时间内显现
- 将关键指标与部署前的基准值进行对比
- 对异常情况（如延迟骤增、错误率上升）及时发出警报
- 追踪系统中的请求日志以分析问题原因
- 部署完成后进行用户体验测试（如简单的功能测试）

## 平台特定要求

### 容器化部署
- 使用Git的SHA值对容器镜像进行标记——以便明确了解正在运行的容器版本
- 设置资源限制以防止容器资源耗尽
- 为对延迟敏感的路径配置适当的并发处理能力

### 无服务器（Serverless）架构
- 优化容器启动速度——保持容器包的大小尽可能小
- 为延迟敏感的路径配置适当的并发处理能力
- 为请求设置合适的超时时间——默认的超时时间通常过短

### 静态网站部署
- 部署后更新CDN缓存
- 使用内容哈希值来确保静态资源的缓存有效性——使缓存长期有效
- 提供预发布版本供代码审查（PR）时使用

## 常见错误
- 在周五下午进行部署——问题往往在无人关注时才会被发现
- 没有制定回滚计划——寄希望于一切顺利并不是一个可靠的策略
- 将代码更新和数据库迁移操作混在一起进行——应分步骤进行
- 依赖手动部署——如果依赖关系处理不当，可能会导致问题
- 在没有监控的情况下进行部署——只有在用户反馈问题后才会发现系统故障