---
name: C
description: 避免常见的 C 语言编程错误：内存泄漏、缓冲区溢出、未定义行为以及指针陷阱。
metadata: {"clawdbot":{"emoji":"🔧","requires":{"bins":["gcc"]},"os":["linux","darwin","win32"]}}
---

## 内存管理
- 每次使用 `malloc` 需要使用 `free` 来释放内存——必须确保内存的所有权得到正确处理，并且只释放一次内存。
- 使用 `free(ptr); ptr = NULL;` 可以防止在内存已被释放后仍尝试访问它。
- 需要检查 `malloc` 的返回值——如果分配失败，它可能会返回 `NULL`。
- `calloc` 会将内存初始化为 0，而 `malloc` 可能会留下未初始化的数据（即“垃圾”数据）。
- 如果程序提前退出，必须确保所有分配的内存都被正确清理。

## 缓冲区溢出
- `strcpy` 不会检查字符串的长度——应使用 `strncpy` 或 `snprintf` 来避免溢出。
- `gets` 是非常不安全的函数——在 C11 标准中被移除，应使用 `fgets` 替代。
- `sprintf` 也有可能导致缓冲区溢出——使用时必须指定缓冲区的大小。
- 如果不检查数组索引，可能会导致数组越界，从而引发安全问题。

## 字符串
- 字符串必须以 `\0`（空字符）结尾——`strncpy` 在复制字符串时可能不会自动添加这个字符。
- `strlen` 不会计算字符串中包含的空字符——在分配内存时需要加上 `\0` 的长度。
- 字符串字面量是不可变的——修改它们会导致未定义的行为。
- `sizeof(str)` 返回的是字符串本身的大小（包括 `\0`），而 `strlen` 只返回字符串的实际长度。
- `char str[]` 表示字符串本身，`char *str` 表示指向该字符串的指针——两者具有不同的含义。

## 指针
- 未初始化的指针是“垃圾”指针——必须对其进行初始化或设置为 `NULL`。
- 解引用 `NULL` 指针会导致未定义的行为——使用前必须进行检查。
- 指针运算时要注意单位（字节还是元素）——`p + 1` 实际上是 `sizeof(*p)` 的大小。
- 数组在函数返回后可能会变成指针——因此返回数组的指针可能会导致悬空指针（dangling pointer）。

## 未定义行为
- 有符号整数的溢出行为是未定义的——与无符号整数不同，它们不会自动取模。
- 读取未初始化的变量会得到随机值。
- 在连续的操作之间修改同一个变量会导致未定义的行为。
- 解引用 `NULL` 指针可能会导致程序崩溃或更严重的错误。
- 使用负数或大于等于元素宽度的位移操作也会导致未定义的行为。

## 整数运算的注意事项
- 在表达式中，小整数类型会被自动提升为 `int` 类型。
- 有符号数和无符号数进行比较时，有符号数会被转换为无符号数，这可能导致结果错误（例如，`-7 / 2` 的结果是 `-3` 而不是 `-4`）。
- `sizeof` 返回的是 `size_t` 类型（通常是无符号的），因此在减法运算中需要注意可能发生的溢出。
- 整数除法会向下取整——`-7 / 2` 的结果是 `-3` 而不是 `-4`。

## 数组
- 在 C99 之前，数组的大小必须是常量——动态分配数组需要使用 `malloc`。
- 变量长度的数组（VLAs）可能会导致栈溢出——应避免使用这种类型，尤其是在数组大小不确定的情况下。
- `arr[i]` 实际上是 `*(arr + i)` 的形式——这是指针运算的底层实现。
- 多维数组在内存中是连续存储的——`arr[i][j]` 等价于 `arr[i * cols + j]`。
- 不能直接返回数组本身，只能返回指向数组的指针。

## 预处理器
- 宏参数可能会被多次求值——例如 `MAX(i++, j)` 会多次执行 `i++`。
- 对于类似 `for` 语句的宏，应该将其体放在 `do { ... } while(0)` 中。
- 宏参数应该用括号括起来——例如 `#define SQ(x) ((x) * (x))`。
- `#include` 的顺序很重要——头文件的包含顺序可能会影响程序的编译结果。

## 常见错误
- 在条件语句中混淆 `=` 和 `==`——`if (x = 5)` 会执行赋值操作，结果总是 `true`。
- `switch` 语句中缺少 `break` 会导致程序继续执行下一个 `case`。
- `sizeof(ptr)` 返回的是指针的大小，而不是数组或分配内存的大小。
- 忘记刷新标准输出流（`stdout`）可能会导致输出结果无法正确显示。
- `fopen` 在失败时会返回 `NULL`——使用文件指针前必须进行检查。