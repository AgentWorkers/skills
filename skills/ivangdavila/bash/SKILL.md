---
name: Bash
slug: bash
version: 1.0.2
description: 编写可靠的 Bash 脚本，确保正确使用引号、进行错误处理，并能够正确处理参数扩展。
metadata: {"clawdbot":{"emoji":"🖥️","requires":{"bins":["bash"]},"os":["linux","darwin"]}}
---

## 快速参考

| 主题 | 文件 |
|-------|------|
| 数组和循环 | `arrays.md` |
| 参数扩展 | `expansion.md` |
| 错误处理模式 | `errors.md` |
| 测试和条件语句 | `testing.md` |

## 引用陷阱

- 必须始终使用引号引用变量——使用 `"$var"` 而不是 `$var`，空格会导致未引用的变量被解释为命令；
- `${arr[@]}` 可以保留数组中的元素；`${arr[*]}` 会将数组元素连接成单个字符串；
- 单引号表示字面值——`'$var'` 不会进行任何扩展；
- 命令替换需要使用引号——使用 `"$(command)"` 而不是 `$(command)`。

## 单词分割和通配符

- 未加引号的 `$var` 会按照空格进行分割——例如 `file="my file.txt"; cat $file` 会出错；
- 未加引号的 `*` 会匹配所有文件名——如果需要匹配文件名本身，需要使用引号或转义字符：`"*"` 或 `\*`；
- 使用 `set -f` 可以禁用通配符匹配功能；如果需要使用通配符，必须正确地加上引号。

## 测试括号

- 推荐使用 `[[ ]]` 而不是 `[ ]`——不会对字符串进行分割，并且支持 `&&`、`||` 和正则表达式；
- `[[ $var == pattern* ]]` 可以在右侧使用不带引号的通配符模式；
- `[[ $var =~ regex ]]` 可以进行正则表达式匹配，不需要对正则表达式本身加引号；
- `-z` 表示字符串为空，`-n` 表示字符串非空——`[[ -z "$var" ]]` 可以判断字符串是否为空。

## 子shell 指令的陷阱

- 管道操作会创建子shell——例如 `cat file | while read; do ((count++)); done` 会导致 `count` 变量的值丢失；
- 应该使用 `while read < file` 或进程替换来避免这个问题；
- `()` 表示子shell，`{ }` 表示当前 shell——在 `()` 中定义的变量不会在当前 shell 中持久化。

## 退出处理

- `set -e` 会在遇到错误时退出程序——但在 `if`、`||`、`&&` 条件语句中不会退出；
- `set -u` 会在变量未定义时引发错误——有助于捕获输入错误；
- `set -o pipefail` 会在任何命令失败时终止整个管道操作，而不仅仅是最后一个命令；
- `trap cleanup EXIT` 会在程序退出时执行指定的清理脚本，无论是因为错误还是其他原因。

## 数组

- 声明数组：`arr=(one two three)`；或者 `arr=()`，然后 `arr+=(item)`；
- 获取数组长度：`${#arr[@]`；
- 获取所有数组元素：`${arr[@]}`——必须使用引号；
- 访问数组索引：`${!arr[@]}`——对于稀疏数组非常有用。

## 参数扩展

- 默认值：`${var:-default}`——如果变量未定义或为空，则使用默认值；
- 赋予默认值：`${var:=default}`——同时也会将默认值赋给变量；
- 如果变量未定义，会输出错误信息：`${var:?error message}`；
- 提取子字符串：`${var:0:5}`——提取字符串的前 5 个字符；
- 删除字符串前缀：`${var#pattern}`；`##` 可以用于删除字符串的前缀。

## 算术运算

- `$(( ))` 用于数学运算——例如 `result=$((a + b))`；
- `(( ))` 用于条件判断——例如 `if ((count > 5)); then`；
- 在 `$(( ))` 内部不需要使用 `$` 符号——例如 `$((count + 1))` 而不是 `$(($count + 1))`。

## 常见错误

- `[ $var = "value" ]` 会在变量为空时出错——应该使用 `[ "$var" = "value" ]` 或 `[[ ]]`；
- `if [ -f $file ]` 中的空格会导致错误——必须使用引号：`if [[ -f "$file" ]]`；
- 在函数中使用 `local` 关键字——如果不使用 `local`，变量将是全局的；
- `read` 命令如果没有 `-r` 选项，反斜杠会被解释为转义字符；
- 为了保证格式的可靠性，应该使用 `printf` 而不是 `echo`。