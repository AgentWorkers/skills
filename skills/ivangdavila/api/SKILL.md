---
name: API
slug: api
version: 1.0.1
description: 使用重试策略、错误处理机制以及生产环境下的最佳实践来调用、调试和集成 REST API。
---

## 使用场景

当用户需要API集成相关技术支持时（从基本请求到可投入生产的解决方案），Agent会负责处理身份验证、错误处理、重试机制、分页逻辑以及Webhook的集成。

## 快速参考

| 主题 | 文件 |
|-------|------|
| 身份验证方案 | `auth.md` |
| 重试与容错机制 | `resilience.md` |
| 分页处理 | `pagination.md` |
| Webhook集成 | `webhooks.md` |

## 常见错误与注意事项

- 在执行POST/PUT/PATCH请求时，务必添加`Content-Type: application/json`；否则许多API会返回415错误（无声错误）。
- 除非API明确指定其他格式，否则应添加`Accept: application/json`；否则部分API可能会默认使用XML格式。
- 通过查询参数传递的API密钥会被记录在服务器的访问日志中；如果支持基于头部的身份验证机制，请优先使用该方式。
- API令牌可能在请求和响应之间过期，请通过单次重试并刷新令牌来处理401错误。

## 隐性错误处理

- 有些API会返回HTTP 200状态码，但响应体中包含错误信息；因此请验证响应数据的结构而不仅仅是状态码。
- 注意响应中的数组是否为空、是否为`null`或某些键是否缺失——这些情况在不同API中可能有不同的含义。
- 对于分页接口，如果偏移量超过了总页数，可能会返回空页面（状态码为200）；请先检查总页数。

## 重试与容错机制

- 使用“抖动指数退避算法”进行重试：`delay = min(base * 2^attempt * (1 + random(0, 0.3)), max_delay)`，其中`base`默认为1秒，`max_delay`默认为30秒。
- 通常只对429、500、502、503、504错误进行重试；除非API文档另有说明，否则避免对400、401、403、404错误进行重试。
- 如果遇到429错误，请查看`Retry-After`头部字段，该字段会覆盖你计算出的退避时间。
- 如果连续5次请求同一接口都失败，请暂停60秒后再进行重试（实现“断路器”机制）。

## 分页处理中的注意事项

- 基于游标的分页方式可能会导致数据重复；请通过ID来消除重复项。
- 有些API会在请求之间修改`total_count`的值；请在首页获取数据的最新统计信息。
- 如果某页返回的项数少于`per_page`指定的数量，但仍然显示“next”页签，请继续分页——这并不一定表示已经到达最后一页。

## 速率限制

- 通过`X-RateLimit-Remaining`头部字段来监控请求配额；在配额用尽之前主动限制请求频率，避免收到429错误。
- 有些API具有针对特定端点的速率限制（而非全局限制）；请监控每个路径的429错误情况。
- 将请求均匀分布在整个速率限制时间段内，避免在开始时突然出现大量请求。

## Webhook集成

- 实现幂等处理逻辑，并通过事件ID来消除重复请求；否则提供者可能会因超时而重复发送请求。
- 立即返回200状态码，并异步处理请求内容；Webhook提供者的超时时间通常在5到30秒之间。
- 如果提供者支持签名验证，请进行签名验证；在没有加密验证的情况下，不要轻信请求数据的来源。
- 在解析Webhook响应之前，请先记录原始响应内容；当提供者突然更改接口规范时，这些记录会非常有用。

## 调试生产环境中的问题

- 对每个API调用记录方法、URL、状态码、响应时间以及`X-Request-Id`头部字段。
- 如果API在开发环境中正常工作但在生产环境中出现故障，请检查IP白名单、TLS版本、SNI设置以及出站代理配置。
- 当响应数据异常时，请与OpenAPI/Swagger规范进行对比；规范通常比手动编写的文档更准确。