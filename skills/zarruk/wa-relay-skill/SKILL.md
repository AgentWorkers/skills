---
name: wa-relay
description: "**OpenClaw v0.2.0 的 WhatsApp 消息中继功能**  
该功能可将第三方发送的私信（DMs）路由到指定的中继代理，再由中继代理通过 `sessions_send` 方法将这些消息转发给主代理。主代理会向消息发送者提供相应的回复建议。同时，系统还支持直接设置允许接收消息的手机号码列表。"
---
# wa-relay v0.2.0

该工具通过一个中继代理将第三方发送的WhatsApp私信（DM）转发给主代理，并由主代理负责通知消息发送者并建议回复内容。

## 工作原理

1. **第三方** 发送WhatsApp消息。
2. **中继代理** 收到消息后，通过`sessions_send`将其转发给主代理，并返回`NO_REPLY`（即不向发送者回复任何内容）。
3. **主代理** 收到该消息后，会通过WhatsApp通知消息的发送者，并提供相应的回复建议。
4. **消息发送者** 可以选择使用建议的回复内容，也可以自行修改或重新编写回复。
5. **主代理** 最后将修改后的回复发送给第三方。

### 直接联系号码白名单

被列入白名单的号码可以直接与主代理通信，无需经过中继（与消息发送者相同）。

## 设置步骤

1. 运行 `scripts/setup.sh <owner-phone-number>` — 创建中继工作区，并修改主代理的 `SOUL.md` 文件。
2. 运行 `scripts/configure.sh <owner-phone-number> [direct-numbers]` — 生成路由配置文件。
3. 应用生成的配置文件（详见 `references/SETUP.md`）。

## 系统要求

- 确保使用 OpenClaw v2026.2.14 或更高版本，并且已配置WhatsApp通道。
- 消息发送者的电话号码需为国际格式（例如：`+573001234567`）。

## 安全注意事项

该工具执行的部分操作需要管理员权限。这些权限对于实现多代理间的WhatsApp消息路由功能是必需的，具体说明如下：

### 1. 认证凭证共享
设置脚本会将主代理的 `auth-profiles.json` 文件复制到中继代理。这是因为OpenClaw的各个代理具有独立的认证机制；如果没有共享的认证凭证，中继代理将无法与任何模型提供者进行身份验证，从而导致功能失效。脚本在复制前会请求用户确认。

### 2. 会话ID正则表达式修改（临时措施）
OpenClaw的会话ID验证机制会拒绝包含冒号（:`）和加号（+）的字符串（例如：`agent:wa-relay:whatsapp:+15551234567`）。设置脚本会修改OpenClaw源代码中的 `SAFE_SESSION_ID_RE` 正则表达式，以允许这些字符的使用。这是一个已知的bug（openclaw/openclaw#16211），对应的修复代码已在PR #16531中提交。待修复完成后，此修改将不再必要，届时可以恢复原始设置。脚本在修改前会创建备份文件并再次请求用户确认。

### 3. 主代理 `SOUL.md` 文件的修改
设置脚本会在主代理的 `SOUL.md` 文件中添加一个关于“如何处理转发消息”的说明部分。请在设置完成后仔细查看新增的内容。