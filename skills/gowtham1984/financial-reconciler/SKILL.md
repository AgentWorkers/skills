---
name: finance-reconciler
description: 这款个人财务管理工具将隐私保护置于首位，数据存储采用本地的 SQLite 数据库。
requires: python3
install: pip3 install pandas ofxparse tabulate python-dateutil
---

# 财务对账工具

这是一个以隐私保护为核心设计的个人财务管理工具，它可以导入银行交易记录、自动分类这些交易、跟踪预算支出、回答与支出相关的问题，并生成报告。所有数据都存储在本地SQLite数据库中，不会被发送到任何外部服务器。

## 首次使用说明

首次使用时，请在执行其他操作之前先运行以下两个命令：

```bash
pip3 install pandas ofxparse tabulate python-dateutil
```

```bash
python3 scripts/db.py
```

如果任一命令失败，请停止操作并向用户显示错误信息。只有在设置成功后才能继续使用该工具。

## 新用户入门指南

如果用户的数据库中还没有交易记录（或者他们提出了类似“帮我管理财务”、“如何开始使用”之类的问题），请按照以下步骤引导他们：

1. 向用户解释该工具会从银行对账单文件中提取交易信息，并且所有数据都会保存在用户的设备上。
2. 告诉用户如何从他们的银行网站下载对账单：
   - **Chase银行**：chase.com → 对账单与文档 → 下载账户活动 → CSV格式
   - **美国银行**：bankofamerica.com → 对账单与文档 → 下载交易记录 → CSV格式
   - **富国银行**：wellsfargo.com → 账户活动 → 下载 → 逗号分隔格式
   - 其他银行：查找“导出到Quicken”或“下载OFX/QFX”选项（用于OFX格式文件），或者选择CSV格式的下载选项
3. 请求用户分享文件路径，或者将文件直接上传到对话中。
4. 建议用户尝试以下操作：
   - “我上个月在食品杂货上的花费是多少？”
   - “为餐饮开支设定每月400美元的预算”
   - “查看我的月度报告”

## 文件导入处理

当用户想要导入银行对账单时：
- **如果用户提供了文件路径**（例如：`~/Downloads/chase_jan.csv`），请直接使用该路径来执行导入操作。
- **如果用户上传了文件**，系统会自动找到文件的临时存储路径，并使用该路径进行导入。
- **如果用户提到了银行名称但未提供文件**，请详细指导他们如何下载文件。例如：“要下载Chase银行的对账单，请登录chase.com，进入对账单与文档页面，选择日期范围，然后选择CSV格式进行下载。之后将文件路径分享给我。”
- **如果文件格式不明确**，系统会自动识别Chase、美国银行和富国银行的文件格式；对于其他银行，系统会尝试使用通用的CSV解析规则（如Date、Description、Amount列）。如果解析失败，请询问用户文件中包含哪些具体的列名。

支持的文件类型：`.csv`（Chase、美国银行、富国银行通用格式）和`.ofx`/`.qfx`（通用格式）。

## 主要功能操作

### 1. 导入交易记录

- 对于CSV文件，请执行以下代码：
```bash
python3 scripts/import_csv.py <file_path> [--format chase|bofa|wells_fargo|generic] [--account <name>]
```

- 对于OFX/QFX文件，请执行以下代码：
```bash
python3 scripts/import_ofx.py <file_path> [--account <name>]
```

根据文件扩展名选择相应的导入脚本（`.ofx`/`.qfx` → `import_ofx.py`；其他格式 → `import_csv.py`）。如果省略了`--format`参数，系统会自动检测文件格式。两个脚本都会将导入的数据转换为JSON格式。

成功导入后，**务必自动执行分类操作**（步骤2），无需用户另行请求。然后向用户展示分类结果，例如：“共导入47笔交易记录（1月1日至31日）：食品杂货342美元，餐饮189美元……”

如果导入过程中发现重复的交易记录，请告知用户：“已跳过12笔重复的交易记录。”

### 2. 对交易记录进行分类

对未分类的交易记录执行以下操作：
```bash
python3 scripts/categorize.py run
```

在添加分类规则后，系统会重新对所有交易进行分类：
```bash
python3 scripts/categorize.py run --recategorize
```

用户可以自定义分类规则：
```bash
python3 scripts/categorize.py add-rule <category> <pattern> [--type keyword|exact|regex|custom]
```

支持的分类类别包括：食品杂货、餐饮、交通、水电费、订阅服务、购物、医疗保健、娱乐、收入以及其他未分类的支出。

如果超过20%的交易被归类为“未分类”，请主动告知用户：“有X笔交易无法被分类。以下是一些常见的未分类交易来源：[列出常见的未分类交易商家]。需要我为这些商家添加分类规则吗？”用户确认后，可以使用`add-rule`命令为这些商家添加规则，并重新运行`--recategorize`命令以更新分类结果。

### 3. 查询支出情况

系统支持以下类型的查询：
- **时间范围**：本月、上个月、1月、过去30天、今年、2024-01-01至2024-03-31
- **支出类别**：食品杂货、餐饮、交通、水电费、订阅服务、购物、医疗保健、娱乐、收入
- **交易商家**：例如“在Starbucks消费”
- **数据汇总方式**：总计/求和、计数、平均值、最大值/最小值、列出/显示

系统会根据用户的查询请求生成相应的查询语句，并以易于理解的方式呈现结果。对于总计数据，会直接显示具体金额；对于列表数据，会以表格形式展示日期和金额。

### 4. 管理预算

系统会跟踪用户的预算执行情况，并用以下三种状态表示：
- **正常**（支出占比低于80%）
- **警告**（支出占比在80%至100%之间）
- **超出预算**（支出占比超过100%）

在报告预算状态时，会使用清晰的语言进行说明，例如：“您的餐饮预算使用率为87%（300美元中的261美元），本月还剩39美元。”对于超出预算的部分，会特别突出显示。

### 5. 生成报告

- 使用`--format text`选项可以生成便于阅读的文本报告。
- 使用`--format html`选项可以生成可在浏览器中查看的HTML报告。用户可以将报告保存为文件，系统会提供文件的保存路径。

报告会重点展示支出最多的类别、与上个月的对比情况、预算执行情况以及主要的支出来源。

## 数据存储位置

所有数据都存储在本地文件`~/.openclaw/skills/finance-reconciler/data/transactions.db`（SQLite数据库）中。用户可以通过设置环境变量`FINANCE_DATA_DIR`来更改数据存储路径。

## 常见用户问题的处理方式

| 用户问题 | 处理方式 |
|-----------|-----------|
| “导入我的对账单” / 分享文件路径 | 运行导入脚本 → 进行分类 → 显示分类结果 |
| “我在某项支出上的花费是多少？” | 使用`query.py`根据用户的问题生成查询结果 |
| “为食品杂货设定预算” | 如果用户未提供具体金额，先询问后再运行`budget.py`设置预算 |
| “我超出预算了吗？” | 运行`budget.py`查询所有类别的预算执行情况 |
| “查看我的报告” / “查看月度总结” | 运行`report.py`生成当前或指定月份的报告 |
| “这个工具能做什么？” / “需要帮助” | 向用户解释工具的五大功能并举例说明 |
| “为什么某项支出被归类为Y？” | 解释系统的分类规则，并提供自定义规则的选项 |
| “我还没有对账单文件” | 提供该银行的具体下载指南 |

所有脚本都会将处理结果以JSON格式输出到标准输出（stdout）。系统会解析JSON数据并以清晰、易于理解的方式呈现结果，绝不会直接将原始JSON数据展示给用户。