---
name: restic-home-backup
description: 设计、实现并操作针对 Linux 主目录的加密 Restic 备份方案，该方案支持 systemd 自动化、保留策略以及恢复验证功能。适用于以下场景：用户需要备份整个主目录（`/`），设置每日/每周/每月的备份任务，提升备份安全性，或解决恢复/完整性相关问题。
---
# Restic家庭备份

为`~/`目录配置一个生产环境可用的Restic备份方案，支持加密、去重、自动调度以及恢复测试功能。

## 技能描述

- **名称：** `restic-home-backup`  
- **解决的问题：** 为Linux用户的个人目录提供可靠、加密的、分版本的备份方案，确保数据安全并可重复恢复。  
- **输入参数：**  
  - 备份目标类型（`local disk`、`sftp`、`s3`、`b2`等）  
  - 仓库端点/路径  
  - 密钥管理方式（环境变量文件或密码文件）  
  - 调度设置（每日备份、每周清理、每月检查）  
  - 需排除的文件模式  
- **输出结果：**  
  - 安装并初始化的Restic仓库  
  - 备份/清理/检查脚本  
  - systemd服务配置文件  
  - 验证结果（包括快照生成和恢复测试）  
  - 简明的操作手册  

## 安全规范（必须严格遵守）：  
- 绝不在聊天记录或日志中泄露任何敏感信息（如密钥或令牌）。  
- 未经用户明确确认，不得删除快照或仓库。  
- 严格限制对凭证文件的权限（至少设置为`chmod 600`）。  
- 在执行系统更改前，必须检查命令的执行状态和快照列表，确认备份是否成功。  
- 禁止隐式应用系统更改：在写入`/etc`、`/usr/local/bin`或`/etc/systemd/system`之前，必须明确请求用户确认或使用`--apply`选项。  

## 工作流程  

### 1) 评估并确认备份需求  

在开始更改之前，收集以下必要信息：  
- 备份源路径（默认为`/home/<user>`）  
- 备份目标仓库及传输方式  
- 数据保留策略（例如：7天/4周/12个月）  
- 当地时区的调度计划  

如果缺少任何关键信息，请向用户询问相关细节。  

### 2) 构建备份脚本  

使用以下工具：  
- `scripts/bootstrap_restic-home.sh`：用于生成备份配置文件。该脚本仅用于生成配置，执行系统更改时需使用`--apply`选项。可选参数可控制定时任务的启用、仓库初始化及首次备份的运行。  
- `references/ops-checklist.md`：用于后续操作和故障排查。  

创建以下文件：  
- `/etc/restic-home.env`（仅root用户可读）  
- `/usr/local/bin/restic-home-backup.sh`  
- `/usr/local/bin/restic-home-prune.sh`  
- `/usr/local/bin/restic-home-check.sh`  
- `restic-home-backup.service/.timer`  
- `restic-home-prune.service/.timer`  
- `restic-home-check.service/.timer`  

### 3) 加强安全性和验证功能  

执行并验证以下操作：  
1. 生成快照。  
2. 运行一次即时备份。  
3. 将备份数据恢复到临时目录进行测试。  
4. 定期（每月一次）执行全面检查。  

验证可能出现的错误情况：  
- 密码错误  
- 仓库无法访问  
- 访问环境变量文件时被拒绝权限  

记录详细的错误信息及相应的修复措施。  

### 4) 通过ClawHub CLI打包并发布技能  

当用户请求发布时：  
1. 验证技能的质量和结构是否完整。  
2. 将技能打包成可发布的格式。  
3. 使用`clawhub` CLI发布技能。  
4. 在干净的环境中验证技能的安装效果。  

确保所有发布操作都有明确的记录和可审计的痕迹。  

## 回答风格要求：  

- 使用描述性语言，详细说明操作步骤和结果。  
- 明确指出文件路径、服务名称及具体执行的命令。  
- 对每个步骤的操作结果进行详细说明，并明确标注完成状态。