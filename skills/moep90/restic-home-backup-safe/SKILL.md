---
name: restic-home-backup
description: 设计、实现并操作针对 Linux 主目录的加密 Restic 备份方案，该方案支持 systemd 自动化、保留策略以及恢复验证功能。适用于以下场景：用户需要备份整个主目录（`~/`），设置每日/每周/每月的备份任务，增强备份安全性，或解决恢复/数据完整性相关问题。
---
# Restic家庭备份

为`~/`目录配置一个适用于生产环境的Restic备份方案，支持加密、去重、自动调度以及恢复测试功能。

## 技能描述

- **名称：** `restic-home-backup`  
- **解决的问题：** 为Linux用户的家庭目录提供可靠、加密的、带有版本控制的备份，确保操作的安全性和可重复的恢复能力。  
- **输入参数：**  
  - 备份目标类型（`local disk`、`sftp`、`s3`、`b2`等）  
  - 仓库端点/路径  
  - 密钥管理方式（环境变量文件或密码文件）  
  - 调度设置（每日备份、每周清理、每月检查）  
  - 需排除的文件模式  
- **输出结果：**  
  - 已安装并初始化的Restic仓库  
  - 备份/清理/检查脚本  
  - systemd服务/定时任务配置文件  
  - 验证结果（快照生成及恢复测试）  
  - 简明的操作手册  

## 安全规范（必须严格遵守）：  
- 绝不在聊天记录或日志中显示任何敏感信息（如密钥或令牌）。  
- 未经用户明确确认，不得删除快照或仓库。  
- 严禁降低凭证文件的权限（最低权限设置为`chmod 600`）。  
- 在执行系统更改前，必须检查命令的执行状态和快照列表，确保备份成功。  
- 禁止隐式应用系统更改；写入`/etc`、`/usr/local/bin`或`/etc/systemd/system`之前，必须明确使用`--apply`选项或获得用户确认。  

## 工作流程  

### 1) 评估并确认备份需求  

在开始更改之前，收集以下必要信息：  
- 备份源路径（默认为`/home/<user>`）  
- 备份目标仓库及传输方式  
- 数据保留策略（例如：7天/4周/12个月）  
- 当地时区的优先调度时间  

如果缺少任何关键信息，请向用户询问详细信息。  

### 2) 构建备份脚本  

使用以下工具：  
- `scripts/bootstrap_restic-home.sh`：生成备份配置文件。该脚本仅用于规划阶段，执行系统更改时需使用`--apply`选项。可选参数可用于启用定时任务、初始化仓库及执行首次备份。  
- `references/ops-checklist.md`：用于后续操作和故障排查。  

创建以下文件：  
- `/etc/restic-home.env`（仅root用户可读）  
- `/usr/local/bin/restic-home-backup.sh`  
- `/usr/local/bin/restic-home-prune.sh`  
- `/usr/local/bin/restic-home-check.sh`  
- `restic-home-backup.service/.timer`  
- `restic-home-prune.service/.timer`  
- `restic-home-check.service/.timer`  

### 3) 加强安全性和验证备份功能  

执行以下操作并进行验证：  
1. 生成Restic快照。  
2. 执行一次即时备份。  
3. 将备份数据恢复到临时目录进行测试。  
4. 定期执行深度检查（每月一次）。  

检查可能出现的故障情况：  
- 密码错误  
- 仓库无法访问  
- 访问环境变量文件时权限被拒绝  

详细记录故障原因及相应的修复措施。  

### 4) 通过ClawHub CLI打包并发布技能  

当用户请求发布时：  
1. 验证技能的质量和结构是否满足要求。  
2. 将技能打包成可发布的格式。  
3. 使用`clawhub` CLI发布技能。  
4. 在干净的环境中验证技能的安装效果。  

确保所有发布操作都有明确的记录和可审计性。  

## 回应格式要求  

使用描述性语言，并提供具体的操作细节：  
- 明确指出文件路径、服务名称及执行命令。  
- 说明具体发生了哪些变化以及如何验证这些变化。  
- 对多步骤任务，需明确说明每个步骤的完成状态。