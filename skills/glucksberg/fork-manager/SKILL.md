---
name: fork-manager
description: **使用未合并的 PR 管理分支**  
- 同步上游代码；  
- 重新基线（rebase）分支；  
- 跟踪 PR 的状态；  
- 维护包含待合并贡献的生产分支。  

**适用场景**：  
- 同步分支时；  
- 重新基线包含未合并 PR 的分支时；  
- 构建整合所有未合并 PR 的生产分支时；  
- 审查已关闭/被拒绝的 PR 时；  
- 管理存储在本地但未同步到上游的代码补丁时。  

**所需工具**：  
Git 和 GitHub CLI（gh）。
metadata: {"openclaw": {"requires": {"bins": ["git", "gh"]}}}
---

# 分支管理技能

该技能用于管理你在其中提交 Pull Request (PR) 的分支，并在上游合并之前使用这些改进。它还支持本地补丁——即使上游的 PR 被关闭或拒绝，这些补丁也会保留在生产分支中。

## 使用场景

- 将分支与上游同步
- 检查未关闭的 PR 状态
- 将 PR 分支重新基线到最新的上游代码
- 创建一个生产分支，合并所有未关闭的 PR 和本地补丁
- 审查最近关闭/拒绝的 PR，并决定是否保留它们
- 管理本地补丁（未提交或被上游拒绝的修复）

## 配置

配置文件按仓库组织，位于 `repos/<repo-name>/config.json` 中，相对于技能目录：

### `config.json` 的格式：

```json
{
  "localPatches": [
    {
      "description": "该补丁的作用",
      "originalPR": "原始 PR 的编号" // 可选，如果直接作为补丁创建
      "closedReason": "关闭原因": "rejected" (维护者拒绝), "superseded" (其他 PR 部分解决了问题但未完全解决), "duplicate" (我们自己关闭了), "wontfix" (上游不会解决),
      "keepReason": "我们需要保留它的原因",
      "addedAt": "转换为本地补丁的日期",
      "reviewDate": "需要重新评估的日期" // 上游可能已经解决了问题
    }
  ]
}
```

## 执行历史

每个被管理的仓库都有一个 `history.md` 文件，以只追加的方式记录该技能的所有执行记录：

### 规则：在开始之前阅读最新输出

**在任何操作之前**，请阅读目标仓库的 `history.md` 文件，并提取**最后一条记录**（最后的 `---` 标签部分）。这可以让你了解：
- 上次执行了哪些操作
- 哪些 PR 存在问题
- 作出了哪些决定
- 是否有未完成的操作

如果文件不存在，请创建它并继续执行后续步骤。

### 规则：在操作完成后记录输出

**在每次操作完成后**，将完整的结果追加到 `history.md` 文件中。格式如下：

**注意：** `Full Report` 标签部分包含完整的报告，不含任何缩写。这样可以确保下一个阅读历史记录的代理能够获取所有信息，而不仅仅是摘要。

## 分析流程

### 1. 加载配置和执行历史记录

加载技能目录（`SKILL.md` 所在的位置）中的配置和执行历史记录：

### 2. 导航到仓库

### 3. 从远程仓库获取代码

### 4. 分析主分支的状态

### 5. 通过 GitHub CLI 查看未关闭的 PR

### 6. 对每个 PR 进行分类

对于配置文件中的每个 PR，检查以下状态：

| 状态       | 条件                          | 操作                                    |
| ------------ | --------------------------------- | --------------------------------------- |
| **open**     | 在 GitHub 上未关闭的 PR               | 保留，并检查是否需要重新基线     |
| **merged**   | PR 已经合并                   | 从配置文件中删除该 PR，删除本地分支 |
| **closed**   | PR 被关闭但未合并              | **执行 `review-closed` 操作**（见下文） |
| **conflict** | 分支与上游有冲突             | 需要手动重新基线                   |
| **outdated** | 分支落后于上游                 | 需要重新基线                          |

### 7. 审查最近关闭的 PR (`review-closed`)

当检测到 PR 被关闭但未合并时，**不要自动删除**。而是开始一个交互式的审查流程：

#### 7.1. 收集关闭原因

#### 7.2. 分类关闭原因

| 分类 | 描述 | 标准操作 |
|-----------|-----------|-------------|
| **resolved_upstream** | 上游通过其他方式解决了问题 | `drop` — 不需要再处理 |
| **superseded_by_ours** | 我们自己关闭了它，因为有其他 PR 解决了相同的问题 | `drop` — 替代 PR 已经在 `openPRs` 中 |
| **rejected_approach** | 维护者不喜欢我们的解决方法，但问题仍然存在 | `review` — 考虑用不同的方法重新提交 |
| **rejected_need** | 维护者不认为这是一个问题 | `review` — 评估是否需要在本地处理 |
| **wontfix** | 上游标记为不会修复 | `review` — 可能需要作为本地补丁处理 |

#### 7.3. 向用户展示情况以便决策

对于每个关闭的 PR，向用户展示相关信息：

#### 7.4. 执行决策

- **删除**：
- **保留作为本地补丁**：
- **重新提交**：
- **推迟**：

### 8. 审查未关闭的 PR (`audit-open`)

主动审查**仍然未关闭**的 PR，以检测重复或过时的情况。此步骤应在 `update-config` 之后执行：

#### 8.1. 上游已解决问题

检查上游是否已经解决了我们的 PR 所解决的问题，但尚未合并我们的 PR：

- 如果 PR 的差异为空（上游已经合并了更改），标记为 `resolved_upstream`。
- 如果差异部分存在（上游只解决了部分问题），标记为 `partially_resolved`，以便进一步审查。

#### 8.2. 外部重复 PR

检查是否有人提交了另一个解决相同问题的 PR：

- 对于每个涉及的文件，比较：
  - 是否引用了相同的问题？
  - 是否修改了相同的代码区域？
  - 是否使用了相同的修复方法？

如果匹配度很高，标记为 `duplicate_external` 或 `superseded_external`。

#### 8.3. 自动重复 PR

检测我们自己的 PR 之间的重复情况：

- 对于每一对有文件重叠的 PR：
  - 检查差异是否相似或互补
  - 如果相似：建议关闭较旧或不太干净的 PR
  - 如果互补：仅作记录提示

#### 8.4. 显示结果

### 代理的命令

### `status` - 查看当前状态

- 加载配置
- 从远程仓库获取代码
- 计算与上游相比的提交次数
- 列出 PR 及其状态
- 向用户报告结果

### `sync` - 将主分支与上游同步

### `rebase <branch>` - 重新基线特定分支

### `rebase-all` - 重新基线所有 PR 分支

对于 `prBranches` 中的每个分支：
- 检出该分支
- 在上游/主分支上重新基线
- 使用 `--force-with-lease` 推送更改
- 报告操作是否成功

### `update-config` - 使用当前的 PR 更新配置文件

### `build-production` - 创建包含所有 PR 和本地补丁的生产分支

**在重新构建生产分支后，如有需要，提醒用户运行他们的项目构建命令。**

**合并顺序：** 先合并未关闭的 PR（按编号升序），然后再合并本地补丁。这样可以确保本地补丁应用在尽可能完整的基础上。

### `audit-open` - 审查未关闭的 PR 以检测重复或过时的情况

主动审查所有未关闭的 PR（见第 8 节）：

- 对于每个未关闭的 PR，收集涉及的文件
- **上游已解决问题**：检查上游自上次同步后是否修改了相同的文件；如果 PR 的差异为空，标记为 `resolved_upstream`。
- **外部重复 PR**：查找上游中最近合并的、解决相同问题的 PR。
- **内部重复 PR**：比较我们自己的未关闭 PR 之间的文件。
- 向用户展示发现的结果，并提供关闭/保留/合并到上游/推迟等选项。
- 执行相应的操作。
- 更新配置文件。

### `review-closed` - 审查最近关闭的 PR

检测自上次同步以来被关闭/合并的 PR，并指导用户做出决策：

- 查找配置文件中的所有 PR
- 识别状态发生变化的 PR（已合并或关闭的 PR）
- 对于已合并的 PR，将其移至 `notes.mergedUpstream` 文件，并删除相关分支。
- 对于未合并的关闭 PR，启动交互式审查流程（见第 7 节）。
- 对于每个关闭的 PR，向用户展示相关信息并提供选项。
- 执行相应的操作：删除/保留作为本地补丁/重新提交/推迟。
- 更新配置文件。

### `review-patches` - 重新评估现有的本地补丁

对于 `localPatches` 中每个 `reviewDate` 已过期的条目：
- 检查上游是否在最后一次审查后解决了问题。
- 检查补丁是否仍然适用（没有冲突）。
- 向用户展示选项：保留/删除/重新提交/延长审查日期。
- 更新配置文件。

### `full-sync` - 完整同步

- **Stash**：如果存在未提交的文件，使用 `git stash --include-untracked` 进行暂存。
- **sync**：更新主分支。
- **update-config**：更新 PR 列表。
- **`review-closed`：审查最近关闭/合并的 PR。
- **`audit-open`：审查未关闭的 PR 以检测重复或过时的情况。
- **`review-patches`：重新评估过期的本地补丁。
- **`rebase-all`：重新基线所有分支（PR 和本地补丁）。
- **build-production**：重新创建生产分支。
- **Pop stash**：使用 `git stash pop` 恢复本地文件。
- 如有需要，提醒用户运行他们的项目构建命令。

**关于顺序的说明：** `audit-open` 在 `review-closed` 之后执行，因为已关闭的 PR 已经被处理并从配置文件中移除。这样 `audit` 只会审查真正未关闭的 PR，避免误判。

## 向用户报告

在任何操作之后，生成报告：

## 重要提示

- 在推送时始终使用 `--force-with-lease` 而不是 `--force`。
- 在执行破坏性操作之前始终进行备份。
- 使用项目的包管理器（如 bun/npm/yarn/pnpm）来运行构建命令。
- 每次操作后都更新配置文件。
- **本地补丁非常重要**：重新基线、构建和报告应包括所有未关闭的 PR 和本地补丁。
- **永远不要自动删除未合并的关闭 PR**。务必通过 `review-closed` 流程让用户做出决策。
- **为本地补丁设置审查日期**：创建本地补丁时设置一个审查日期（默认为 30 天）。在 `full-sync` 期间，会向用户展示过期的补丁以供重新评估。
- **本地补丁的命名规则**：使用前缀 `local/` 以区分它们和 PR 分支（例如：`local/my-custom-fix`）。原始分支可以重命名或保留——关键是配置文件能够正确跟踪分支。

### ⚠️ 在执行破坏性操作之前保护未提交的文件

在任何切换分支或删除/重新创建分支的操作之前（特别是 `build-production` 和 `full-sync`），**务必** 检查并保留未提交的、未跟踪的和已跟踪的文件：

**为什么？** 在删除和重新创建生产分支（`git branch -D <productionBranch>`）时，仅存在于工作目录中的未提交文件会永久丢失。这些文件包括：
- 生成的文件（仪表板、历史记录、状态文件）
- 本地配置文件（如 `serve.ts`、`.env`）
- 积累的数据（JSON、SQLite 文件）

**规则：** 如果 `git status --porcelain` 显示任何输出，请在执行操作之前使用 `git stash --include-untracked`。操作完成后使用 `git stash pop` 恢复这些文件。

## 安全注意事项

此技能执行的操作需要广泛的文件系统和网络访问权限：

- **Git 操作**：从多个远程仓库和分支获取、检出、合并、重新基线和推送代码。
- **GitHub CLI**：读取 PR 状态、创建 PR、查询仓库元数据。

**在使用此技能之前：**
- 所有 `git push` 操作都使用 `--force-with-lease`（而不是 `--force`）以防止数据丢失。
- 该技能总是在执行破坏性分支操作之前暂存未提交的文件。

这些功能是分支管理的一部分，无法移除，否则会导致核心功能失效。

## 使用示例

用户：“同步我的 project-x 分支”

代理：
1. 从 `$SKILL_DIR/repos/project-x/config.json` 加载配置文件。
2. 运行 `status` 命令以评估当前状态。
3. 如果主分支落后，运行 `sync` 命令。
4. 如果需要重新基线 PR，运行 `rebase-all` 命令。
5. 如有需要，更新 `productionBranch`。
6. 如有需要，提醒用户重新构建项目。
7. 向用户报告结果。