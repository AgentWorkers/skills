---
name: cross-ref
description: >
  **技能说明：**  
  该技能用于交叉引用 GitHub 的 Pull Request（PR）和 Issues，以识别重复项和缺失的链接。系统会同时启动多个子代理（Sonnet subagents）来对最近的 N 个 PR 和 Issues 进行语义分析，找出解决相同问题的 PR（重复项），以及那些已被打开的 PR 解决但尚未被链接到的 Issues。分析结果会被分组为不同的主题类别，并根据问题的可操作性进行评分。用户可以借此功能进行批量操作（如关闭、标记问题），或者对 PR 和 Issues 之间的关系进行审计。该技能特别适用于以下场景：查找重复的 PR、将 Issues 与 PR 关联起来、清理仓库中的交叉引用信息，或审计 PR 与 Issues 之间的关联关系。此外，当用户提出诸如“查找相关的 PR”、“哪些 PR 解决了这个问题”、“是否存在重复的 PR”、“将 Issues 与 PR 关联起来”或“审计交叉引用关系”等请求时，该技能也能发挥重要作用。
---
# 交叉引用：PR与Issue链接器

该工具能够发现人类在处理大量数据时容易忽略的PR（Pull Request）与Issue之间的关联。其核心工作流程为：**获取数据 → 并行分析 → 分组 → 验证 → 报告 → 执行操作**。

在开始使用之前，请先阅读`references/principles.md`文件。当该文件中的规则与本文件中的规则发生冲突时，以`references/principles.md`中的规则为准。

## 概述

随着时间的推移，仓库中会积累重复的PR和未被解决的Issue（即“孤儿Issue”），以及它们之间的关联信息。手动进行交叉引用在处理少量数据时还可以，但当数据量超过几十个条目时就会变得效率低下。该工具利用多个Sonnet子代理并行处理，最多可同时分析1000个PR和1000个Issue，从而找出以下两种类型的关联：

1. **重复的PR**：针对同一错误或功能的PR（即使使用的方法或表述不同）。
2. **Issue→PR的关联**：已有的Issue，但尚未有明确的“fixes #N”引用来指明对应的PR。

分析结果会被分组到不同的**主题簇**中，并根据**可操作性**进行评分，同时提供相应的**处理建议**（如评论、关闭或标记问题），而不仅仅是简单地列出所有关联对。

## 配置

用户在使用该工具时需要提供以下配置参数（若未提供则默认使用默认值）：

| 参数          | 默认值        | 说明                                      |
|---------------|-------------|-----------------------------------------|
| `repo`         | *(询问)*       | 需要分析的GitHub仓库（格式：owner/repo）                    |
| `pr_count`      | 1000         | 需要扫描的最近PR数量                              |
| `issue_count`     | 1000         | 需要扫描的最近Issue数量                              |
| `pr_state`      | `all`         | PR状态筛选条件：`open`、`closed`、`all`                 |
| `issue_state`     | `open`         | Issue状态筛选条件：`open`、`closed`、`all`                 |
| `batch_size`     | 50           | 每个子代理处理的PR数量                              |
| `confidence_threshold` | `medium`       | 报告中应包含的最低置信度阈值：`low`、`medium`、`high`           |
| `mode`         | `plan`         | `plan`：仅生成报告（默认模式）；`execute`：根据分析结果执行操作       |

**默认模式为`plan`**（仅生成报告）。用户必须在查看分析结果后明确选择是否执行操作，因为操作一旦执行就无法撤销。

## 工作流程

### 第1阶段：数据收集

从GitHub API中获取PR和Issue的元数据。此阶段完全依赖shell脚本完成，无需使用人工智能。

**产生的文件包括：**
- `workspace/prs.json`：完整的PR元数据
- `workspace/issues.json`：完整的Issue元数据（已过滤掉PR的Issue）
- `workspace/existing-refs.json`：预先提取的关联信息
- `workspace/pr-index.txt`：每个PR的简短索引文件
- `workspace/issue-index.txt`：每个Issue的简短索引文件

这些元数据用于记录已有的关联信息（如“fixes #N”等），以便子代理能够专注于未发现的关联。

### 第2阶段：并行分析（Sonnet子代理）

这是工具的核心处理阶段。将PR分成多个批次，并启动多个Sonnet子代理进行并行分析。每个子代理会收到：
- 自己负责处理的PR批次（来自`prs.json`的完整元数据，约50个PR）
- 完整的Issue索引（压缩格式，约60KB）
- 完整的PR索引（压缩格式，约60KB，用于检测重复项）
- 已有的关联信息映射（以便跳过已关联的条目）

**使用Task工具启动子代理的代码示例：**

**注意**：在为每个子代理生成提示时，请将`references/principles.md`文件中的所有内容粘贴到“Decision Principles”部分，不要进行总结或压缩，以确保子代理始终使用最新的处理规则。

### 第3阶段：合并、去重与分组

所有子代理完成分析后：
1. 将所有JSON结果收集到一个数组中。
2. 去除重复的关联记录（A→B和B→A视为相同的关联）。
3. 如果多个子代理发现了相同的关联记录，选择置信度较高的那个，并合并相关的证据信息。
4. 根据`confidence_threshold`进行筛选。
5. 将相关结果分组到不同的主题簇中。
6. 根据每个簇的可操作性进行评分。
7. 按评分从高到低对簇进行排序。

最终结果保存到`workspace/results-unverified.json`文件中。

#### 分组算法

该工具不会简单地将关联记录作为单独的对列出，而是将它们分组到相应的簇中。如果两个记录共享相同的PR或Issue编号，它们就被归入同一个簇中。

**示例**：如果发现`PR#100 ↔ PR#101`（重复项）和`PR#100 ↔ Issue#50`（关联项），则它们会被归入同一个簇，命名为“Cluster: Issue#50 + PR#100 + PR#101”。

**簇的结构**由一个简短的描述性文本表示，用于说明该簇的主题（即它们共有的根本原因或功能领域）。

#### 可操作性评分

每个簇会根据以下指标进行评分（评分范围为0-10）：

| 评分指标        | 分值        | 说明                                      |
|-----------------|------------|-----------------------------------------|
| 所有记录均为开放状态   | +3         | 可以立即采取行动                          |
| 至少有一个高置信度的记录 | +2         | 有强有力的证据支持                          |
| 簇内有多个关联记录   | +1         | 关联性更强，价值更高                          |
| Issue获得了超过5条评论   | +1         | 社区关注度高                          |
| PR不是草稿状态     | +1         | 已准备好接受审查                          |
| 簇内有明确的PR     | +1         | 容易确定最佳解决方案                          |
| 需要人工审核     | -2         | 需要人工判断                          |
| 所有记录均为关闭状态   | -3         | 紧急性较低                          |

评分在7分及以上的簇被视为**可操作**（在报告中显示为绿色）；评分在4-6分的簇被视为**需要审查**（显示为黄色）；评分在0-3分的簇被视为**低优先级**（显示为灰色）。

### 第3b阶段：证据验证

子代理使用截断后的PR正文（长度为500个字符）和简化的索引进行验证。这种处理方式适合发现新的关联，但不适合做出最终决策。此时会启动一个单独的验证子代理来进一步核实数据：

1. 读取`workspace/results-unverified.json`文件。
2. 对于每个高置信度的候选项，通过`gh` API获取更多详细信息：
   - 对于重复的PR，检查两个PR是否实际修改了相同的文件。
   - 对于Issue→PR的关联，查看Issue的完整内容，确认是否有评论者已经指出了这种关联。
   - 对于所有候选项，查看PR的完整内容，以确认关联的准确性。
3. 对于需要人工审核的项，根据核实结果调整候选项的评分。
4. 根据核实结果更新簇的评分。
5. 将验证后的结果保存到`workspace/results.json`文件中。

**验证子代理的代码示例：**

此阶段用于处理在发现阶段可能遗漏的错误关联。子代理侧重于发现所有可能的关联，而验证器则侧重于确保结果的准确性。

**如果候选项的总数少于5个，则可以跳过此阶段**——因为对于少量数据来说，验证的代价可能高于其带来的收益。

### 第4阶段：生成报告

将结果按簇的形式呈现给用户。

**报告的结构如下：**

### 第4b阶段：为每个簇提供建议的操作

针对每个簇，根据置信度和记录的状态提供相应的操作建议：

- **对于重复的PR（置信度高且都处于开放状态）**：
  1. 💬 **评论**：将两个PR链接起来，以便作者能够协调处理。
  2. 🏷️ **标记**：在较弱的PR上添加“重复”标签。
  3. ❌ **关闭**：如果关联明确，关闭较弱的PR。

- **对于一个开放、一个关闭的重复PR**：
  1. 💬 **评论**：指出两者之间的关联，提供参考信息。

- **对于Issue→PR的关联**：
  1. 💬 **在Issue上评论**：指出存在这样的关联。
  2. 🏷️ **标记Issue**：添加“has-pr”标签。

- **对于需要人工审核的项**：
  1. ⚠️ **标记为需要人工处理**：将这些项单独列出，不自动执行任何操作。

**操作规则**：
  - 除非有高置信度和验证结果，否则不建议关闭PR。
  - 除非置信度至少为中等，否则不建议添加标签。
  - 建议至少进行评论，因为这是最安全的操作方式。
  - 对于置信度不同的簇，建议采取与最低置信度记录对应的操作。

### 第5阶段：交互式操作策略

在展示报告后，询问用户希望如何继续处理。有关详细的操作策略，请参阅`references/commenting-strategy.md`文件。

**为每个簇提供操作选项：**

对于每个可操作的簇，让用户选择以下操作之一：
- **仅评论**：仅将两个PR链接起来。
- **评论 + 标记**：同时链接并添加标签。
- **评论 + 关闭**：链接并关闭重复的PR（仅当置信度较高时）。
- **跳过**：不对该簇采取任何操作。
- **手动处理**：表示用户希望自行处理该簇。

### 第6阶段：执行操作

如果用户选择执行操作，系统会生成`workspace/approved-comments.json`文件，并通过shell脚本执行相应的操作。

**approved_comments.json`文件的结构如下：**
- `target_number`：需要评论的Issue或PR的编号。
- `type`：记录的类型（仅用于日志记录）。
- `body`：完整的评论内容。
- `cluster_id` 和 `finding_index`：用于追溯到原始报告。

**对于标记和关闭操作**，可以直接在代码中执行，因为它们不需要像评论操作那样的速率限制。

**在处理每个簇时，请务必按照以下顺序执行操作：**
1. 先发布评论（确保在关闭或添加标签之前提供上下文信息）。
2. 添加标签。
3. 最后关闭PR。

**评论模板**：
- 评论应保持专业且有助于用户理解，避免使用重复的开头语。每次评论使用不同的开头语。
- 在评论中务必提及PR的作者名称。

### 第7阶段：交互式反馈机制

在展示报告后，询问用户具体的操作方式。有关详细的操作策略和速率限制规则，请参阅`references/commenting-strategy.md`文件。

### 第8阶段：执行操作

如果用户选择执行操作，系统会生成`workspace/approved-comments.json`文件，并通过shell脚本执行相应的操作。

**注意**：在执行标签或关闭操作时，请务必按照上述顺序进行。