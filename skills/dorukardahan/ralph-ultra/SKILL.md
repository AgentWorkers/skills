---
name: ralph-ultra
description: "**深入安全审计（包含1,000次迭代，耗时约4-8小时）**  
适用于以下场景：用户要求进行“深入安全审计”、“Ralph Ultra级安全评估”、“合规性审计准备”、“全面安全审查”、“重大版本发布前”或“安全事件调查”。  
审计范围涵盖OWASP标准、供应链安全、业务逻辑等方面，并涉及4种专家角色的参与。"
metadata: { "openclaw": { "emoji": "⚔️" }, "author": "dorukardahan", "version": "2.0.0", "category": "security", "tags": ["security", "audit", "deep-dive", "compliance", "owasp"] }
---
# Ralph Ultra — 1000次迭代（约4-8小时）

这是一项全面的安全审计任务，涵盖了所有可能的攻击途径。

## 参考资料

- [严重性分级与问题分类指南](references/severity-guide.md)
- [专家角色描述](references/personas.md)

## 使用说明

### 执行引擎

每次迭代都必须遵循以下步骤：

1. **状态**：读取当前迭代次数（起始值为1）。
2. **阶段**：根据迭代次数确定当前所处的审计阶段。
3. **专家角色**：为当前阶段激活相应的专家角色。
4. **操作**：执行该阶段内的一个检查项。
5. **验证**：在发现错误时，需要仔细阅读代码、检查相关库、数据库约束以及系统环境；如果结果不明确，则标记为“需要审核”。
6. **报告**：输出本次迭代的审计结果。
7. **保存**：每50次迭代后，更新`ralph-report.md`文件。
8. **递增**：迭代次数加1。
9. **继续**：如果迭代次数小于或等于1000次，则返回步骤1。
10. **最终阶段**：生成完整的审计报告。

**重要规则：**
- 每次迭代只执行一个检查项，确保审计的深度而非广度。
- 必须在报告中标注 `[ULTRA-X/1000]`。
- 严禁跳过任何迭代步骤。
- 发现严重问题时，必须立即标记并处理。
- 在执行每个检查项时，都要以红队（Red Team）的思维方式来分析问题。

### 每次迭代的输出内容（请参见对应的`CODE_BLOCK_0_`代码块）

### 专家角色

| 阶段 | 所需专家角色 |
|-------|---------|
| 1、3、7 | 网络安全资深专家 |
| 2、5 | 代码审计员（渗透测试人员） |
| 4 | 容器安全专家 |
| 6 | 依赖关系分析专家 |
| 8 | 全面审计专家 |

完整的专家角色描述请参见[references/personas.md](references/personas.md)。

### 阶段划分（共1000次迭代）

| 阶段 | 迭代次数 | 审计重点 |
|-------|------------|------------|
| 1 | 1-100 | 侦察与攻击面分析 |
| 2 | 101-250 | OWASP十大常见安全漏洞的深入检查 |
| 3 | 251-400 | 认证与密钥管理 |
| 4 | 401-550 | 基础设施与容器安全 |
| 5 | 551-700 | 代码质量与业务逻辑 |
| 6 | 701-850 | 供应链与依赖关系分析 |
| 7 | 851-950 | 合规性检查与文档审核 |
| 8 | 951-1000 | 最终验证与报告生成 |

### 第1阶段：侦察（1-100次迭代）

- **1-20次迭代**：平台同步（自动检测开发环境、Git仓库信息、哈希值验证、环境差异分析）。
- **21-50次迭代**：攻击面分析（端点枚举、认证机制检查、速率限制、暴露的端口、WebSocket/SSE协议的安全性）。
- **51-75次迭代**：隐藏系统的检测（未声明的服务、定时任务、孤立的配置文件、Docker网络配置）。
- **76-100次迭代**：环境与文档检查（变量配置的准确性、文档的完整性评估）。

### 第2阶段：OWASP十大常见安全漏洞（101-250次迭代）

| 迭代次数 | OWASP漏洞编号 | 审计重点 |
|------|-------|-------|
| 101-120 | A01 | 访问控制漏洞（IDOR、CORS、路径遍历问题） |
| 121-140 | A02 | 加密算法缺陷（加密算法、密钥管理问题） |
| 141-170 | 注入攻击（SQL注入、命令注入、XSS攻击、模板注入、日志泄露） |
| 171-185 | 设计缺陷（缺少必要的安全控制机制） |
| 186-200 | 安全配置错误（调试信息、错误处理机制） |
| 201-215 | 安全组件漏洞（依赖库的安全性问题） |
| 216-230 | 认证机制漏洞（凭证填充、会话管理问题） |
| 231-240 | 数据完整性漏洞（序列化/反序列化过程中的安全问题） |
| 241-245 | 日志记录功能缺陷 |
| 246-250 | SSRF（跨站请求伪造） |

### 第3阶段：认证与密钥管理（251-400次迭代）

**执行前检查**：在标记问题之前，先确定使用的是第三方库提供的加密机制还是自定义的加密方案。

- **251-300次迭代**：密钥检测（API密钥、密码、Git历史记录的审计）。
- **301-340次迭代**：JWT（JSON Web Tokens）的安全性检查（算法、声明内容、存储方式、撤销机制）。
- **341-365次迭代**：OAuth 2.0认证机制的审计（PKCE、重定向URI、状态管理、令牌交换过程）。
- **366-385次迭代**：管理员认证机制的漏洞（暴力破解尝试、时间限制、锁定机制）。
- **386-400次迭代**：速率限制机制的测试（覆盖范围及绕过策略的检测）。

### 第4阶段：基础设施安全（401-550次迭代）

- **401-450次迭代**：容器安全（非root用户权限、容器读写权限、容器功能的限制）。
- **451-490次迭代**：网络安全（端口配置、防火墙设置、网络隔离措施）。
- **491-515次迭代**：TLS/SSL协议的安全性（证书有效性、加密算法、HSTS（HTTP Strict Transport Security）配置）。
- **516-535次迭代**：SSH安全（密钥认证、配置强化）。
- **536-550次迭代**：数据库安全（SSL配置、权限管理、数据备份策略）。

### 第5阶段：代码质量（551-700次迭代）

**执行前检查**：在标记潜在问题之前，先检查数据库的约束条件。

- **551-590次迭代**：竞态条件（如“时间顺序不正确（TOCTOU）”、并发访问问题、锁机制的漏洞）。
- **591-630次迭代**：业务逻辑的漏洞（工作流程绕过、状态数据被恶意修改）。
- **631-660次迭代**：错误处理机制的安全性（错误信息的处理方式、故障安全机制的设计）。
- **661-690次迭代**：资源管理（连接管理、内存使用、DoS攻击的防御）。
- **691-700次迭代**：代码复杂性相关的问题（如ReDoS攻击、JSON数据中的恶意代码）。

### 第6阶段：供应链安全（701-850次迭代）

- **701-750次迭代**：依赖关系的审计（CVE漏洞、依赖库的过时问题、域名混淆攻击）。
- **751-790次迭代**：第三方API的安全性（API密钥管理、Webhook配置、速率限制机制）。
- **791-820次迭代**：容器镜像的供应链安全（基础镜像的质量、签名验证）。
- **821-850次迭代**：持续集成/持续交付（CI/CD）流程中的安全问题（密钥管理、权限设置）。

### 第7阶段：合规性检查（851-950次迭代）

- **851-885次迭代**：隐私合规性（GDPR法规、数据保留政策、用户同意机制）。
- **886-915次迭代**：安全相关文档的完整性（事件响应流程、安全政策）。
- **916-935次迭代**：操作系统的安全性（访问控制、变更管理）。
- **936-950次迭代**：审计日志的完整性与保留策略。

### 第8阶段：最终验证（951-1000次迭代）

- **951-970次迭代**：对之前发现的关键问题进行重新验证。
- **971-985次迭代**：模拟渗透测试。
- **986-995次迭代**：生成安全报告并总结审计结果。

### 自动检测步骤（第1次迭代）

- 执行命令：`git rev-parse --show-toplevel`、`git remote -v`。
- 检查项目依赖的库文件：`package.json`、`pyproject.toml`、`requirements.txt`、`go.mod`、`Cargo.toml`。
- 检查基础设施配置：`Dockerfile`、`docker-compose.yml`、Kubernetes配置文件（`k8s manifests`）、Terraform配置文件。
- 检查持续集成/持续交付（CI/CD）相关设置：`.github/workflows`、`.gitlab-ci.yml`、`.circleci`。

### 报告文件

- 启动审计时，需要重命名现有的审计报告文件。
- 每50次迭代后，自动保存审计结果。

### 参数设置

| 参数 | 默认值 | 可选值 |
|-------|---------|---------|
| `--iterations` | 1000 | 1-2000次迭代 |
| `--focus` | `all` | 全面审计 | 或指定特定阶段（如“recon”、“owasp”、“auth”、“infra”、“code”、“supply-chain”、“compliance”） |
| `--phase` | `all` | 所有阶段 | 或指定特定阶段（1-8） |
| `--resume` | `--` | 从上次审计的 checkpoint 继续执行 |

### 进度保存机制

- 进度信息保存在`ralph-report.md`文件中。
- 提供`resume`命令用于从上次审计的 checkpoint 继续执行审计。

### 适用场景

- 在产品发布前进行安全审计。
- 在发生安全事件时进行调查。
- 在系统发现潜在安全问题后（如`/ralph-security`标志被触发时）进行深入安全检查。