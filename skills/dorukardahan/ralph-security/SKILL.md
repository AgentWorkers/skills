---
name: ralph-security
description: "全面的安全审计，包含100个检查项（耗时约30-60分钟）。适用于以下场景：用户请求“进行安全审计”、“Ralph安全检查”、“每周安全审查”、“审计该项目”或“检查新项目中的安全漏洞”。审计范围涵盖OWASP十大常见安全风险、身份验证机制、敏感信息管理、基础设施安全以及代码质量。"
metadata: { "openclaw": { "emoji": "🛡️" }, "author": "dorukardahan", "version": "2.0.0", "category": "security", "tags": ["security", "audit", "owasp", "comprehensive"] }
---
# Ralph Security — 100次迭代（约30-60分钟）

这是一次全面的安全审计，既注重深度也兼顾了审计的耗时。

## 参考资料

- [严重性定义和分类指南](references/severity-guide.md)

## 指令

### 执行引擎

每次迭代都必须遵循以下步骤：

1. **状态**：读取当前迭代次数（起始值为1）。
2. **阶段**：根据迭代次数确定当前所处的阶段。
3. **操作**：执行当前阶段内的一个检查项。
4. **验证**：在报告“失败”结果之前，先阅读相关代码，确认是否有库（如jose、bcrypt、passport、Auth0等）已经处理了该问题；同时检查数据库约束和环境设置。如果结果不明确，则标记为“需要审查”，而不是“失败”。
5. **报告**：输出当前迭代的审计结果。
6. **保存**：每进行10次迭代，更新`.ralph-report.md`文件。
7. **递增**：迭代次数加1。
8. **继续**：如果迭代次数小于或等于100次，则返回步骤1。
9. **最终阶段**：生成完整的审计报告。

**重要规则：**
- 每次迭代只执行一个检查项，注重深度而非广度。
- 必须在报告中显示 `[SEC-X/100]` 的格式。
- 严禁跳过任何迭代步骤。
- 发现严重问题时，需立即处理。

### 每次迭代的输出内容（具体检查内容见下文）

### 人员角色

资深安全工程师。具备基于证据的分析思维，采用深度防御策略，并遵循最小权限原则。

### 阶段结构（共100次迭代）

| 阶段 | 迭代次数 | 重点检查领域 |
|-------|------------|------------|
| 1     | 1-15    | 侦察与同步 |
| 2     | 16-45    | OWASP十大安全漏洞分析 |
| 3     | 46-65    | 认证与密钥管理 |
| 4     | 66-85    | 基础设施安全 |
| 5     | 86-100   | 代码质量与报告生成 |

### 第1阶段：侦察（1-15次迭代）

| 迭代次数 | 检查内容 |
|--------|---------|
| 1      | 自动检测代码栈和基础设施配置 |
| 2      | Git仓库的本地与远程代码同步情况 |
| 3      | 未提交的敏感文件 |
| 4      | `.gitignore` 文件中是否包含`.env`文件 |
| 5      | 公开端点的枚举 |
| 6      | 认证需求的梳理 |
| 7      | 流量限制机制的覆盖情况 |
| 8      | 暴露的端口（主机/容器） |
| 9      | 隐藏服务的发现 |
| 10      | Cron作业和定时任务的检查 |
| 11      | 环境变量的审计 |
| 12      | Docker环境的检查 |
| 13      | 文档内容与实际代码的对比 |
| 14      | 攻击面的评估 |
| 15      | 第1阶段的总结 |

### 第2阶段：OWASP十大安全漏洞（16-45次迭代）

| 迭代次数 | OWASP漏洞编号 | 检查内容 |
|--------|---------|---------|
| 16-18    | A01     | 访问控制漏洞（IDOR、CORS、路径遍历） |
| 19-21    | A02     | 加密算法缺陷（弱加密算法、密钥管理问题） |
| 22-27    | A03     | 注入攻击（SQL注入、命令注入、XSS攻击、模板注入、日志泄露） |
| 28-30    | A04     | 安全设计缺陷（缺少安全控制机制、业务逻辑问题） |
| 31-33    | A05     | 安全配置错误（调试逻辑、错误处理） |
| 34-36    | A06     | 易受攻击的组件（依赖项安全问题） |
| 37-39    | A07     | 认证失败（凭证填充、会话管理问题） |
| 40-42    | A08     | 数据完整性问题（反序列化过程、持续集成/持续部署流程） |
| 43-44    | A09     | 日志记录安全问题（日志记录的完整性和安全性） |
| 45     | A10     | SSRF攻击（URL验证、元数据保护） |

### 第3阶段：认证与密钥管理（46-65次迭代）

**预检查**：确认代码库是否使用了成熟的库，而非自定义实现。如果使用了库提供的加密功能，通常较为安全——重点检查使用过程中的错误。

| 迭代次数 | 检查内容 |
|--------|---------|
| 46-50    | 密钥的检测（API密钥、密码、令牌等） |
| 51-55    | JWT的安全性（算法、声明内容、存储方式、撤销机制） |
| 56-58    | OAuth 2.0规范（PKCE、重定向URI、状态管理） |
| 59-62    | 管理员认证机制（暴力破解、速率限制、锁定机制） |
| 63-65    | 流量限制机制的评估（覆盖范围、绕过机制） |

### 第4阶段：基础设施安全（66-85次迭代）

| 迭代次数 | 检查内容 |
|--------|---------|
| 66-70    | 容器安全（非root权限、只读设置、访问限制） |
| 71-75    | 网络安全（端口配置、防火墙设置、网络隔离） |
| 76-78    | TLS/SSL协议（证书有效性、加密算法、HSTS设置） |
| 79-81    | SSH安全（密钥认证、配置强化） |
| 82-85    | 数据库安全（SSL配置、权限控制） |

### 第5阶段：代码质量与报告生成（86-100次迭代）

**预检查**：在标记潜在的竞态条件之前，先检查数据库的约束机制。

| 迭代次数 | 检查内容 |
|--------|---------|
| 86-88    | 竞态条件（时间顺序错误、并发访问问题） |
| 89-91    | 业务逻辑缺陷（工作流程问题、速率限制绕过机制） |
| 92-94    | 错误处理机制（错误信息的处理方式、容错机制） |
| 95-97    | 资源管理（连接管理、内存使用） |
| 98     | 重要问题的复查 |
| 99     | 安全评分卡的生成 |
| 100    | 最终审计报告的生成 |

### 自动检测（第1次迭代）

执行以下命令：
```bash
git rev-parse --show-toplevel
git remote -v
```
检查以下文件：
- 代码栈相关：`package.json`, `pyproject.toml`, `requirements.txt`, `go.mod`
- 基础设施相关：`Dockerfile`, `docker-compose.yml`, `k8s manifests`
- 持续集成/持续部署相关：`.github/workflows`, `.gitlab-ci.yml`
对于不适用的检查项，标记为“N/A”。

### 报告文件

启动审计时，将现有的`.ralph-report.md`文件重命名为`.ralph-report-{YYYY-MM-DD-HHmm}.md`。每进行10次迭代，自动保存审计结果。

### 参数设置

| 参数          | 默认值       | 可选值                |
|--------------|------------|----------------------|
| `--iterations`    | 100        | 1-200                   |
| `--focus`       | all         | recon, owasp, secrets, auth, infra, code, all       |
| `--phase`       | all         | 1-5                    |
| `--resume`      | —          | 从上次检查点继续执行            |

### 当前上下文限制处理

当接近上下文使用限制时，系统会自动创建检查点并生成报告文件，然后输出继续执行的命令，等待新的审计会话开始。

### 适用场景

- 每周安全检查 |
- 新项目上线时 |
- 重大版本发布前 |
- 标准安全审计流程