---
name: ralph-security
description: "全面的安全审计，包含100个审计步骤（每个步骤耗时约30-60分钟）。适用于以下场景：用户请求“安全审计”、“Ralph安全检查”、“每周安全审查”、“对该项目进行审计”或“检查漏洞”。审计范围涵盖OWASP十大安全风险、身份验证机制、敏感信息管理、基础设施安全以及代码质量。"
metadata: { "openclaw": { "emoji": "🛡️" }, "author": "dorukardahan", "version": "2.0.0", "category": "security", "tags": ["security", "audit", "owasp", "comprehensive"] }
---
# Ralph Security — 100次迭代（约30-60分钟）

这是一项全面的安全审计，旨在平衡审计的深度和持续时间。

关于严重性定义、误报识别以及问题分类的指导，请参阅 `{baseDir}/references/severity-guide.md`。

## 指令

### 执行引擎

每次迭代都必须遵循以下步骤：

1. **状态**：读取当前迭代次数（起始值为1）。
2. **阶段**：根据迭代次数确定当前所处的阶段。
3. **操作**：执行当前阶段规定的检查项。
4. **验证**：在报告“失败”结果之前，先阅读实际代码，检查相关库（如 jose、bcrypt、passport、Auth0 等）是否已处理相关问题；同时检查数据库约束和环境设置。如果结果不确定，则标记为“需要审查”（NEEDS_REVIEW），而非“失败”（FAIL）。
5. **报告**：输出当前的迭代结果。
6. **保存**：每进行10次迭代，更新 `.ralph-report.md` 文件。
7. **递增**：迭代次数加1。
8. **继续**：如果迭代次数小于或等于100次，返回步骤1。
9. **最终阶段**：生成完整的审计报告。

**关键规则：**
- 每次迭代只执行一项检查，注重深度而非广度。
- 必须在报告中显示 `[SEC-X/100]` 的格式。
- 严禁跳过任何迭代步骤。
- 对于严重的问题，必须立即标记并引起重视。

### 每次迭代的输出内容

```
══════════════════════════════════════════════════════════
[SEC-{N}/100] Phase {P}: {phase_name}
Check: {specific_check}
══════════════════════════════════════════════════════════
Target: {file/endpoint/system}
Result: {PASS|FAIL|WARN|N/A}
Confidence: {VERIFIED|LIKELY|PATTERN_MATCH|NEEDS_REVIEW}
Severity: {CRITICAL|HIGH|MEDIUM|LOW|INFO}
Finding: {description}
Fix: {recommendation or "N/A"}
──────────────────────────────────────────────────────────
Progress: [██████████░░░░░░░░░░] {N}%
──────────────────────────────────────────────────────────
```

### 人员背景

高级安全工程师，秉持基于证据的安全策略，采用纵深防御的方法，并遵循最小权限原则。

### 阶段结构（共100次迭代）

| 阶段 | 迭代次数 | 重点检查领域 |
|-------|------------|------------|
| 1    | 1-15    | 侦察与同步 |
| 2    | 16-45    | OWASP十大安全漏洞分析 |
| 3    | 46-65    | 认证与密钥管理 |
| 4    | 66-85    | 基础设施安全 |
| 5    | 86-100   | 代码质量与报告生成 |

### 第1阶段：侦察（1-15次迭代）

| 迭代次数 | 检查内容 |
|--------|---------|
| 1      | 自动检测代码栈和基础设施配置 |
| 2      | Git仓库的本地代码与远程代码是否同步 |
| 3      | 未提交的敏感文件 |
| 4      | `.gitignore` 文件中是否包含 `.env` 文件 |
| 5      | 公开端点的枚举 |
| 6      | 认证需求的分析 |
| 7      | 流量限制机制的验证 |
| 8      | 暴露的端口（主机/容器） |
| 9      | 隐藏服务的发现 |
| 10      | Cron作业和定时任务的检查 |
| 11      | 环境变量的审计 |
| 12      | Docker环境的检查 |
| 13      | 文档内容与实际代码的对比 |
| 14      | 攻击面的评估 |
| 15      | 第1阶段总结 |

### 第2阶段：OWASP十大安全漏洞（16-45次迭代）

| 迭代次数 | OWASP漏洞编号 | 检查内容 |
|--------|---------|---------|
| 16-18    | A01      | 访问控制漏洞（IDOR、CORS、路径遍历） |
| 19-21    | A02      | 加密算法缺陷（弱加密算法、密钥管理问题） |
| 22-27    | A03      | 注入攻击（SQL注入、命令注入、XSS攻击、模板注入、日志泄露） |
| 28-30    | A04      | 安全设计缺陷（缺少安全控制机制、业务逻辑问题） |
| 31-33    | A05      | 安全配置错误（调试信息、错误处理问题） |
| 34-36    | A06      | 漏洞组件（依赖库的安全问题） |
| 37-39    | A07      | 认证失败（凭证填充、会话管理问题） |
| 40-42    | A08      | 数据完整性问题（序列化/反序列化漏洞） |
| 43-44    | A09      | 日志记录安全问题（日志记录的覆盖范围和安全性） |
| 45      | A10      | SSRF攻击（URL验证、元数据保护问题） |

### 第3阶段：认证与密钥管理（46-65次迭代）

**预检查**：确认代码库使用的是知名库还是自定义实现。如果使用了成熟的加密库，通常较为安全，重点检查使用过程中的错误。

| 迭代次数 | 检查内容 |
|--------|---------|
| 46-50    | 密钥的检测（API密钥、密码、令牌等） |
| 51-55    | JWT的安全性（算法、声明内容、存储方式、撤销机制） |
| 56-58    | OAuth 2.0的实现（PKCE、重定向URI、状态管理） |
| 59-62    | 管理员认证机制（暴力破解、时间限制、锁定机制） |
| 63-65    | 流量限制机制的验证（覆盖范围和绕过漏洞的可能性） |

### 第4阶段：基础设施安全（66-85次迭代）

| 迭代次数 | 检查内容 |
|--------|---------|
| 66-70    | 容器安全（非root权限、只读设置、访问限制） |
| 71-75    | 网络安全（端口配置、防火墙设置、网络隔离） |
| 76-78    | TLS/SSL协议（证书有效性、加密算法、HSTS设置） |
| 79-81    | SSH安全（密钥认证、配置加固） |
| 82-85    | 数据库安全（SSL配置、权限设置、访问控制） |

### 第5阶段：代码质量与报告生成（86-100次迭代）

**预检查**：在标记潜在的竞态条件之前，先检查数据库的约束机制。

| 迭代次数 | 检查内容 |
|--------|---------|
| 86-88    | 竞态条件（时间顺序错误、并发访问问题） |
| 89-91    | 业务逻辑缺陷（工作流程问题、流量限制机制的绕过） |
| 92-94    | 错误处理机制（错误信息的处理方式、容错机制） |
| 95-97    | 资源管理（连接管理、内存使用情况） |
| 98    | 严重问题的审查 |
| 99    | 安全评分卡的生成 |
| 100    | 最终审计报告的生成 |

### 自动检测（第1次迭代）

执行以下命令：
```
git rev-parse --show-toplevel
git remote -v
```
需要检查的文件包括：
- 代码栈相关文件：`package.json`, `pyproject.toml`, `requirements.txt`, `go.mod`
- 基础设施配置文件：`Dockerfile`, `docker-compose.yml`, `k8s manifests`
- CI/CD相关配置：`.github/workflows`, `.gitlab-ci.yml`
对于不适用的检查项，标记为“N/A”。

### 报告文件

启动审计时，将现有的 `.ralph-report.md` 文件重命名为 `.ralph-report-{YYYY-MM-DD-HHmm}.md`。每进行10次迭代，自动保存审计报告。

### 参数设置

| 参数 | 默认值 | 可选值 |
|-------|---------|---------|
| `--iterations` | 100 | 1-200 |
| `--focus` | all | 全部检查项 | 仅侦察 | OWASP漏洞 | 密钥管理 | 认证 | 基础设施 | 代码 |
| `--phase` | all | 1-5 | 指定要检查的阶段 |
| `--resume` | — | 从上次检查点继续执行 |

### 当前上下文限制处理

当接近上下文使用限制时，系统会自动创建检查点并保存报告文件，然后提示用户继续新的审计会话。

### 使用场景

- 定期安全检查 |
- 新项目上线前的安全评估 |
- 标准安全审计流程 |