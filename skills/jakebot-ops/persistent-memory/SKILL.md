---
name: persistent-memory
description: 三层持久化存储系统（基于Markdown格式、ChromaDB向量数据库以及NetworkX知识图谱）：用于实现跨会话的长期信息存储与检索。当代理需要在不同会话之间记住决策、事实、上下文或机构知识时，该系统可发挥重要作用。该系统可用于数据存储与维护、索引管理、历史上下文的搜索，以及处理代理报告“忘记”先前对话的情况。
---
# 持久化内存

该功能为任何 OpenClaw 工作区添加了持久化的三层内存系统。通过该系统，代理能够在不同会话之间保持对决策、事实、经验教训以及机构知识的访问能力——这些信息在重启后依然可用。

## 架构

| 层次 | 技术        | 目的            |
|-------|-----------|-------------------|
| L1: Markdown | MEMORY.md + 日志文件 + 参考资料 | 人类可读的、经过整理的知识库       |
| L2: 向量存储 | ChromaDB + MiniLM-L6-v2 | 实现对所有记忆内容的语义搜索     |
| L3: 图谱存储 | NetworkX      | 用于概念之间的关联分析      |

这三层内容会实时同步。索引器会自动从 L1 更新 L2 和 L3 的数据。

## ⚠️ 关键集成：OpenClaw 内存配置

**问题：** OpenClaw 自带内存搜索系统，但默认情况下它仅索引 `MEMORY.md` 和 `memory/*.md` 文件。而一些关键的工作区文件（如 `SOUL.md`（代理指令）、`AGENTS.md`（行为规则）和 `PROJECTS.md`（当前项目信息）会被忽略。

**影响：** 由于这些文件未被索引，代理可能会违反自身的规则，从而导致操作失误。

**解决方案：** `configure_openclaw.py` 脚本为 OpenClaw 添加了一个 `memorySearch` 配置项，用于索引所有关键的工作区文件。这样一来，遵循规则就变成了自动化的操作，而非可选设置。

## 设置流程

从工作区根目录运行以下命令：

**步骤 1：** 使用 Python 虚拟环境（venv）创建 `vector_memory/` 目录，并搭建 ChromaDB 数据库和知识图谱。如果存在 `MEMORY.md` 文件，也会对其进行索引。

**步骤 2：** 配置 OpenClaw 的内置内存系统，使其自动索引所有关键的工作区文件（`SOUL.md`、`AGENTS.md` 等），从而避免因文件未被索引而导致的规则执行失败问题。

## 日常使用

### 编写记忆内容

- **MEMORY.md**：用于存储长期性的知识内容（决策、项目架构、经验教训），在重要事件发生后进行更新。
- **memory/YYYY-MM-DD.md**：记录每日发生的事件，包含原始的文字记录。
- **reference/*.md**：存储机构层面的信息（人员、代码库、基础设施、业务规则），相当于代理的“百科全书”。

### 索引更新（编辑任何记忆文件后）

索引器会解析 `MEMORY.md`、`reference/*.md` 和 `memory/*.md` 文件，将其转换为向量格式，并重新构建知识图谱。每次编辑后都需要运行此步骤以确保各层数据的一致性。

### 搜索功能

可以查询与目标内容语义最相似的前三条记录，并显示原始文件及其所在章节。

### 同步状态检查

该功能会报告同步状态：包括 `MEMORY.md` 的哈希值与实际索引状态、索引条目数量以及知识图谱的大小。可以通过心跳检测（heartbeat）来监控同步情况是否正常。

## 代理行为规则

请将这些规则添加到 `AGENTS.md` 或 `SOUL.md` 中：

### 回答问题前的必选操作
在回答关于以往工作、决策、日期、人员或偏好设置的问题之前，必须先搜索内存中的相关信息。可以使用 `memory_search` 命令或 `auto_retrieve.py` 脚本来获取所需信息。切勿在未进行搜索的情况下直接回答“我不记得了”。

**重要提示：** 如果已经运行了 `configure_openclaw.py`，OpenClaw 的内置内存搜索系统应能自动找到这些规则文件。如果搜索仍然找不到相关规则，说明 OpenClaw 的集成配置存在问题。

### 执行操作前的必选操作
在执行任何涉及外部标识符（URL、处理程序、电子邮件地址、代码库名称等）的操作之前，必须先在 `reference/` 文件中查找该标识符的确切内容。如果找不到，再查询向量存储中的数据；如果仍然找不到，则需要询问用户。**严禁伪造标识符**。

### 编辑文件后的必选操作
编辑 `MEMORY.md` 或 `reference/`、`memory/` 中的文件后，需要重新执行索引操作。

### 心跳检测集成
请将相关配置添加到 `HEARTBEAT.md` 文件中。

## 参考资料目录（可选但推荐）
在工作区根目录下创建 `reference/` 目录，作为代理的机构知识库：

这些文件也会被转换为向量格式并进行索引。代理在处理任何涉及外部标识符的操作前会先查询该目录。随着时间的推移，这里的知识会不断积累，从而实现“永不遗忘”的目标。

## 设置完成后的文件结构

### 常见问题解决方法

- **“找不到 chromadb 模块”**：重新运行 `setup.sh` 命令，或激活虚拟环境：`source vector_memory/venv/bin/activate`
- **同步状态异常**：运行索引器：`vector_memory/venv/bin/python vector_memory/indexer.py`
- **搜索结果为空**：确认 `MEMORY.md` 文件中有内容，并且索引器至少运行过一次。
- **索引过程中出现 SIGSEGV 错误**：通常是由于依赖的机器学习库版本不兼容所致。设置脚本会使用已知稳定的版本。
- **代理忽略 `SOUL.md/AGENTS.md` 中的规则**：可能是 OpenClaw 的集成配置有问题。运行 `python skills/persistent-memory/scripts/configure_openclaw.py` 来修复问题。
- **内存搜索找不到工作区文件**：检查 OpenClaw 的配置文件：`openclaw config get | grep memorySearch`
- **“配置验证失败”**：手动重启 OpenClaw：`openclaw gateway restart`