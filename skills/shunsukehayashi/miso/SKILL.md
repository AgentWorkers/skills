# 任务控制 — 多代理可视化技能

## 概述
在任务启动过程中，通过 Telegram 显示并更新实时进度仪表板。
通过单条消息的编辑更新、反应切换以及内联按钮来可视化整个任务生命周期。

## 设计原则（符合 Telegram 的格式规范）
- ❌ 禁用绘制方框的字符（如 `┏━┓`）
- ❌ 禁用使用空格对齐
- ✅ 仅使用左对齐
- ✅ 表情符号具有结构意义
- ✅ 使用 `——————————————`（14 个破折号）作为分隔符
- ✅ 使用 `↳` 表示层次结构
- ✅ 使用 Unicode 加粗字体（如 `𝗯𝗼𝗹𝗱`）来显示章节名称
- ✅ 使用 `▓░` 来表示进度条（共 16 个刻度）

## 状态图标定义

| 状态 | 图标 | 标签 |
|-------|------|-------|
| 初始化中 | ⏳ | `𝗜𝗡𝗜𝗧` |
| 运行中 | 🔥 | `𝗥𝗨𝗡𝗡𝗜𝗡𝗚` |
| 编写中 | ✏️ | `𝗪𝗥𝗜𝗧𝗜𝗡𝗚` |
| 等待中 | ⏸️ | `𝗪𝗔𝗜𝗧𝗜𝗡𝗚` |
| 完成 | ✅ | `𝗗𝗢𝗡𝗘` |
| 错误 | ❌ | `𝗘𝗥𝗥𝗢𝗥` |
| 重试 | 🔄 | `𝗥𝗘𝗧𝗥𝗬` |
| 等待批准 | ⏸️ | `𝗔𝗪𝗔𝗜𝗧𝗜𝗡𝗚 𝗔𝗣𝗣𝗥𝗢𝗩𝗔𝗟` |

## 反应集成
消息中的反应可以一目了然地显示任务阶段。无需打开消息，即可从聊天列表中了解任务状态。

| 阶段 | 反应 | 含义 |
|-------|----------|---------|
| 初始化/运行中 | 🔥 | 代理正在活跃 |
| 部分完成 | 🔥 | 一些代理仍在运行 |
| 等待批准 | 👀 | 等待用户确认 |
| 完成 | 🎉 | 任务完成 |
| 错误 | ❌ | 发生错误 |

实现方式：在状态切换时使用 `message(action=react, messageId, emoji)`。
Telegram 配置要求：`channelsTelegram.reactionLevel = "extensive"`。

## 确认反馈（ackReaction）
当收到用户消息时，立即显示 👀 反应——这是最快的“消息已收到”反馈。
回复后自动移除该反馈（配置：`removeAckAfterReply: true`）。

配置参数：
- `messages.ackReaction`: "👀"
- `messages.ackReactionScope`: "all"（包括私信在内的所有消息）
- `messages.removeAckAfterReply`: true

该功能属于 4+1 层级用户体验模型中的第 0.5 层。它位于固定显示（Pin，第 0 层）和反应（Reaction，第 1 层）之间，提供即时反馈。

## 固定显示功能
在任务运行期间，将任务消息固定在私信的顶部；任务完成后，将其从固定显示中移除。
打开聊天窗口时，可以立即看到当前正在进行的操作。

| 时间点 | 操作 |
|--------|--------|
| 初始化阶段 | `pinChatMessage` — 固定显示（静默） |
| 完成阶段 | `unpinChatMessage` — 移除固定显示 |
| 错误阶段（中止） | `unpinChatMessage` — 移除固定显示 |

实现方式：直接调用 Telegram Bot API。

## 阶段概述（共 6 个阶段）

### 第 1 阶段：初始化（即时响应 — 代理初始化）

反应：🔥

### 第 2 阶段：运行中（活跃状态 — 进度条显示）

反应：🔥

### 第 3 阶段：部分完成（部分代理已完成，其余代理仍在运行）

反应：🔥

### 第 4 阶段：等待批准（需要用户确认）

反应：👀
内联按钮：2 行 × 2 列

在不可逆操作（发布、发送、删除、计费）之前自动触发。
已完成代理的详细信息会折叠显示（仅显示一行摘要）。

### 第 5 阶段：完成（任务完成）

反应：🎉

### 第 6 阶段：错误发生

反应：❌

### 进度条规则
进度条共有 16 个刻度：

示例：
- 0%：`░░░░░░░░░░░░░░░░`
- 25%：`▓▓▓▓░░░░░░░░░░░`
- 50%：`▓▓▓▓▓▓▓▓░░░░░`
- 75%：`▓▓▓▓▓▓▓▓▓▓▓░░░`
- 100%：`▓▓▓▓▓▓▓▓▓▓▓▓▓`

## 实现流程

### 1. 任务开始
### 2. 代理运行中
### 3. 部分完成
### 4. 所有代理完成 + 等待不可逆操作
### 5. 任务完成
### 6. 错误处理

## 发布目的地（私信 + 公众频道）

### 私信（操作员 — 全部功能）
支持 4+1 层级用户体验模型的所有功能：固定显示、反应、进度条、内联按钮。

### 公众频道（@MIYABI_CHANNEL — 任务日志）
自动发布任务开始和完成信息。进度详情仅通过私信发送。

| 时间点 | 私信 | 公众频道 |
|--------|-----|---------|
| 任务开始 | 第 1 阶段初始化 + 📌 固定显示 | 🚀 任务开始通知 |
| 运行中 | 第 2-3 阶段编辑更新 | — 无发布 |
| 等待批准 | 第 4 阶段 + 按钮 | — 无发布 |
| 完成 | 第 5 阶段 + 🎉 + 移除固定显示 | ✅ 完成报告（包含交付成果和关键见解） |
| 错误 | 第 6 阶段 | — 无发布 |

### 公众频道发布模板

**任务开始：**
### 任务完成：**

频道 ID：`-1003700344593` (@MIYABI_CHANNEL)

### 主任务记录（永久固定在私信中）
在私信中保留一条永久性消息，显示所有任务概览。
单个任务的消息会使用临时固定显示（任务完成后移除）。

### 主任务记录始终固定在私信中
单个任务完成后，其消息会从固定显示中移除。

## Unicode 加粗转换表
普通字体 → 加粗字体：
- A-Z: 𝗔𝗕𝗖𝗗𝗘𝗙𝗚𝗛𝗜𝗝𝗞𝗟𝗠𝗡𝗢𝗣𝗤𝗥𝗦𝗧𝗨𝗩𝗪𝗫𝗬𝗭
- a-z: 𝗮𝗯𝗰𝗱𝗲𝗳𝗴𝗵𝗶𝗷𝗸𝗹𝗺𝗻𝗼𝗽𝗾𝗿𝘀𝘁𝘂𝘃𝘄𝘅𝘆𝘇
- 0-9: 𝟬𝟭𝟮𝟯𝟰𝟱𝟲𝟳𝟴𝟵

**小写字母：**
- ᴀʙᴄᴅᴇꜰɢʜɪᴊᴋʟᴍɴᴏᴘǫʀꜱᴛᴜᴠᴡxʏᴢ

## 先决条件
- Telegram 配置：`reactionLevel` 设置为 `extensive`
- 需要使用 `message` 工具的 `react`、`edit`、`send` 功能
- 需要 `sessionsspawn` 和任务完成通知来处理状态切换

## 相关技能
- `miyabi-channel` — 公众频道发布技能
- `telegram-style` — Telegram 格式规范
- `main-context-handoff` — 子代理交接机制
- `DESIGN-SYSTEM.md` — 设计系统详细信息