---
name: configure-x402
description: 配置 x402 微支付功能，以实现代理之间的交易（agent-to-agent commerce）通过 Uniswap 进行。您可以设置您的代理在每次 MCP 请求时使用 USDC 进行支付（结算时间约为 200 毫秒），或者作为服务提供商接受 x402 支付。当用户希望启用按使用次数计费的 API 访问功能或将其代理的服务货币化时，可以使用此功能。
model: sonnet
---

# 配置 x402

## 概述

本技能用于配置基于 x402 的 HTTP 原生支付协议，以实现代理之间的微支付。x402 使用 HTTP 402 “Payment Required” 状态码来实现按请求计费的机制——代理每次调用 API 时需要支付少量费用（以 USDC 为单位），结算时间约为 200 毫秒，无需 API 密钥、账户或订阅服务。

x402 支持两种模式：
- **支付模式**：配置代理通过 x402 为 MCP 工具调用和外部 API 访问付费。
- **接受模式**：将代理配置为 x402 服务提供者，接受来自其他代理的微支付。
- **同时支持两种模式**：实现双向 x402 支付。

截至 2026 年 2 月，x402 已在 80 多个生态系统项目中处理了超过 1 亿笔代理之间的交易。该方案消除了使用 API 密钥的复杂性，并从每次代理交互中生成收入。

## 适用场景

当用户提出以下需求时，请激活此技能：
- “为我的代理设置 x402 支付”
- “通过 x402 启用按交换次数计费的机制”
- “配置我的代理以接受 x402 支付”
- “在 Base 平台上设置微支付”
- “为我的 MCP 服务器启用 x402”
- “为我的代理的 API 服务实现盈利”
- “配置按请求计费的机制”
- “设置代理之间的支付”

## 参数

| 参数                | 是否必填 | 默认值       | 说明                                                                                          |
|------------------|---------|-------------|-----------------------------------------------------------------------------------------------------------|
| `mode`            | 否       | both        | 支付模式：“pay”（为服务付费），“accept”（接受支付）或 “both”        |
| `walletAddress`   | 是       | --          | 用于发送/接收支付的 Base 平台上的 USDC 钱包地址           |
| `chain`           | 否       | base        | 结算链（推荐使用 Base，结算时间约为 200 毫秒）                   |
| `pricePerCall`    | 否       | 见定价信息    | 每次 MCP 工具调用的价格（以 USDC 计，接受模式适用）。默认使用推荐价格。     |
| `supportedTools`  | 否       | all         | 支持通过 x402 进行支付的 MCP 工具列表（以逗号分隔）。         |
| `maxSpendPerHour` | 否       | $1.00       | 每小时的最高 x402 支出限额（支付模式适用）。用于防止费用失控。         |
| `facilitator`     | 否       | auto        | 使用的 x402 中间机构。“auto” 会自动选择 Base 平台上最适合的中间机构。     |

### 推荐定价（接受模式）

| 工具类别            | 每次调用价格 | 示例                          |
|------------------|-----------|-----------------------------------------|
| 价格报价            | $0.001       | `get_token_price`, `get_quote`                |
| 池分析            | $0.003       | `get_pool_info`, `get_pool_volume_history`           |
| 路由优化            | $0.005       | `get_pools_by_token_pair`, `search_tokens`           |
| 模拟              | $0.01        | `simulate_transaction`                   |
| 执行                | $0.05        | `execute_swap`, `add_liquidity`                 |

## 工作流程

1. **解析用户请求**：确定支付模式、钱包地址、结算链和定价信息，并验证钱包地址格式。
2. **验证钱包**：确认钱包地址存在于目标结算链上，并且拥有足够的 USDC（支付模式）或能够接收 USDC（接受模式）。同时检查结算链是否支持 x402 结算。
3. **生成配置文件**：在 `.uniswap/x402-config.json` 中生成 x402 配置文件，内容包括：
   - 支付模式
   - 钱包地址和结算链
   - 中间机构地址
   - 每次调用的价格（接受模式）
   - 支出限额（支付模式）
   - 支持的工具列表

   对于接受模式，还需生成 `.well-known/x402-manifest.json` 文件，向其他代理公开该代理支持的 x402 端点。
4. **验证配置**：检查以下内容：
   - 钱包在结算链上的连接状态
   - 中间机构的可用性
   （支付模式）中间机构合约所需的 USDC 批准
   配置文件的格式是否正确

## 输出格式

```text
x402 Configuration Complete

  Mode:         Both (pay + accept)
  Chain:        Base (8453)
  Wallet:       0x1234...abcd
  Facilitator:  Auto-selected (Coinbase x402)

  Pay Mode:
    Max Spend:  $1.00/hour
    USDC Balance: $50.00 (sufficient)

  Accept Mode:
    Pricing:
      Price quotes:       $0.001/call
      Pool analytics:     $0.003/call
      Route optimization: $0.005/call
      Simulation:         $0.010/call
      Execution:          $0.050/call
    Tools Gated:  All (17 tools)

  Config Files:
    .uniswap/x402-config.json
    .well-known/x402-manifest.json

  Status: Ready for x402 payments
```

## 重要说明

- x402 默认在 Base 平台上进行结算（结算时间约为 200 毫秒），也可以选择以太坊主网，但速度较慢且费用更高。
- x402 仅支持 USDC 作为支付代币。钱包必须在结算链上持有 USDC。
- `maxSpendPerHour` 限制可防止支付成本失控。可根据实际使用情况调整此限制。
- x402 使用 HTTP 402 “Payment Required” 状态码；如果客户端尝试访问受保护的端点而未支付，将收到提示付款的 402 响应。
- 中间机构负责处理支付结算。“auto” 选项会自动选择 Base 平台上最适合的中间机构。
- 对于接受模式，`.well-known/x402-manifest.json` 文件可让其他代理在 Coinbase Bazaar 上找到你的代理服务。
- x402 支付是按每次请求计算的，不涉及订阅服务、API 密钥或账户。每次请求都会包含一笔微支付。
- 所有 x402 交易都会被记录以供财务管理，并可通过 `manage-treasury` 技能进行追踪。
- 本技能仅生成配置文件，不执行任何链上交易。实际的支付流程由 MCP 服务器在运行时处理。

## 错误处理

| 错误类型            | 显示给用户的消息                                      | 建议的操作                                      |
|------------------|----------------------------------|-------------------------------------------|
| 钱包地址无效          | “钱包地址格式无效。”                                      | 提供有效的以太坊地址（格式为 0x...）。                         |
| 钱包余额不足          | “钱包在 [结算链] 上没有 USDC。x402 支付需要 USDC。”                   | 为钱包充值 USDC。                              |
| 不支持该结算链        | “[结算链] 不支持 x402 结算。”                               | 推荐使用 Base 平台或以太坊主网。                         |
| 无法找到合适的中间机构     | “[结算链] 上没有可用的 x402 中间机构。”                         | 尝试使用 Base 平台（大多数中间机构均可用）。                   |
| 配置文件写入失败        | “无法写入 x402 配置文件：[原因]。”                             | 检查文件权限。                                   |
| 未配置钱包          | “未找到代理的钱包。请先使用 `setup-agent-wallet` 技能配置钱包。”            |                          |
| 价格设置错误          | “每次调用的价格必须为正数且以 USDC 计。”                           | 提供有效的价格值。                             |