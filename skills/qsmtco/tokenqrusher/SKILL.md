---
name: tokenQrusher
description: OpenClaw的令牌优化系统可将成本降低50%至80%
version: 2.1.1
author: qsmtco
license: MIT
homepage: https://github.com/qsmtco/tokenQrusher
metadata:
  openclaw:
    requires:
      bins:
        - python3
        - node
    emoji: "💰"
---
# tokenQrusher 技能

## 概述

tokenQrusher 通过以下方式将 OpenClaw API 的使用成本降低 50-80%：
1. **上下文过滤** – 仅加载所需的工作区文件（对于简单消息，文件数量可减少 99%）；
2. **心跳检测优化** – 将心跳检测 API 调用次数减少 75%。

这是经过简化的、可直接用于生产环境的核心功能。非功能性组件已被移除。

---

## 组件

### 1. 上下文挂钩 (`token-context`)

**事件触发时机：** `agent:bootstrap`

根据消息的复杂度来决定加载哪些工作区文件。

**配置文件：** `~/.openclaw/hooks/token-context/config.json`

**工作原理：**
- 提取用户的最新消息；
- 对消息进行复杂度分类（简单/标准/复杂）；
- 仅保留允许加载的文件，丢弃其余文件；
- 将过滤后的文件列表设置为 `context/bootstrapFiles`。

**节省效果：**
- 简单问候消息 → 仅加载 2 个文件（token 使用量减少 99%）；
- 标准任务 → 仅加载 3 个文件（token 使用量减少 90% 以上）；
- 复杂任务 → 加载所有文件（保留完整上下文）。

**设计理由：** 简单消息不需要文档、内存日志或工具引用，只需用户身份和个性化信息即可。

### 2. 心跳检测优化器 (`token-heartbeat`)

**事件触发时机：** `agent:bootstrap`（在心跳检测时）

优化心跳检测的调度，以大幅减少 API 调用次数。

**配置文件：** `~/.openclaw/hooks/token-heartbeat/config.json`

**工作原理：**
- 判断距离上次检测是否已过足够时间；
- 跳过未到检测时间的检查；
- 遵守静默时间规则（默认为晚上 11:00 至早上 8:00）；
- 当无需检查时返回 `HEARTBEAT_OK`。

**优化效果：**
| 检测类型 | 默认间隔 | 优化后间隔 | 调用次数减少比例 |
|-------|------------------|-----------|-----------|
| 电子邮件 | 60 分钟 | 120 分钟 | 50% |
| 日历 | 60 分钟 | 240 分钟 | 75% |
| 天气 | 60 分钟 | 240 分钟 | 75% |
| 监控 | 30 分钟 | 120 分钟 | 75% |

**结果：** 每天检测次数从 48 次减少到 12 次（API 调用次数减少 75%）。

### 3. 公共模块 (`token-shared`)

这两个挂钩共用的纯函数：
- `classifyComplexity(message)` → 判断消息复杂度；
- `getAllowedFiles(level, config)` → 获取允许加载的文件列表；
- `isValidFileName(name)` → 防止路径遍历攻击；
- `loadConfigCached(logFn)` → 配置信息缓存（缓存时间为 60 秒）；
- 使用“Maybe/Either”模式来控制程序流程（避免异常情况）。

---

## 外部接口

该技能 **不** 调用任何外部网络接口，所有操作都在本地机器上完成。

---

## 安全性与隐私

- **100% 本地执行** – 数据不会离开您的系统；
- **无外部数据传输** – 不会向第三方服务器发送任何数据；
- **配置文件仅用于读取**；
- **文件验证** 防止路径遍历攻击；
- **无需任何环境变量**。

---

## 模型调用说明

挂钩会自动运行：
- `token-context` 在每次 `agent:bootstrap` 事件（即每次用户发送消息时）被触发；
- `token-heartbeat` 在心跳检测时被触发。

启用这些挂钩后，无需任何手动干预。

---

## 信任声明

通过安装此技能，您确认代码仅在本地运行，且不会传输您的工作区数据。安装前请查看 GitHub 上的源代码实现。

---

## 命令行接口 (CLI)

安装完成后，可以使用以下 CLI 命令：

### `tokenqrusher context <prompt>`

根据给定的提示，推荐应加载哪些上下文文件。

---

### `tokenqrusher status [--verbose]`

显示系统状态。

---

### `tokenqrusher install [--hooks] [--all]`

安装/启用挂钩。

---

## 配置

所有挂钩的配置文件均为 JSON 格式，存储在：
`~/.openclaw/hooks/<hook-name>/config.json`

您可以编辑这些配置文件来定制行为（例如调整文件列表、检测间隔或静默时间）。配置更改会在 60 秒后重新加载（配置缓存有效期为 60 秒）。

---

## 设计原则

- **确定性**：相同的输入会产生相同的输出；
- **纯函数**：没有隐藏的副作用；
- **不可变性**：数据结构保持不变；
- **控制流程无异常**：使用结果类型（Result/Either）来控制程序流程；
- **线程安全**：使用 RLock 保护共享状态；
- **类型声明完整**：所有变量都有明确的类型说明。

---

## 性能

| 操作        | 延迟时间    | 内存占用    |
|------------|-----------|-----------|
| 上下文分类    | <1 毫秒     | <1 MB      |
| 心跳检测    | <0.5 毫秒     | <0.5 MB      |

每个代理消息的处理开销可以忽略不计。

---

## 故障排除

### 挂钩未加载？

请检查配置文件是否正确，或尝试重启系统。

### 配置更改未生效？

可能是配置缓存的有效期（60 秒）未到。此时请重启系统以使更改立即生效。

---

## 从 v2.0.x 升级

v2.1.0 版本移除了非功能性组件。升级步骤如下：
1. 禁用并删除旧挂钩：
2. 更新相关配置；
3. 重新安装剩余的挂钩；
4. 重启系统。

**已移除的命令：** `tokenqrusher model`、`budget`、`usage`、`optimize`。这些命令已不再可用。

---

## 许可证

采用 MIT 许可协议。详细信息请参阅仓库中的 `LICENSE` 文件。

---

## 致谢

- **设计与实现：** Lieutenant Qrusher (qsmtco)
- **审核：** Captain JAQ (SMTCo)
- **框架：** OpenClaw 团队

该技能基于 OpenClaw 构建：https://github.com/openclaw/openclaw