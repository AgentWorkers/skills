---
# agentskills.io compliant frontmatter
name: clarity-gate
version: 2.1.2
description: 在RAG（检索-生成-整合）系统中，对文档进行预处理验证以确保其认知质量。这一过程确保文档在进入知识库之前符合相关标准。通过该验证，系统能够生成“清晰度过滤后的文档”（CGD，Clarity-Gated Documents），并验证文档的来源真实性（SOT，Source of Truth文件）。
author: Francesco Marinoni Moretto
license: CC-BY-4.0
repository: https://github.com/frmoretto/clarity-gate
triggers:
  - clarity gate
  - check for hallucination risks
  - can an LLM read this safely
  - review for equivocation
  - verify document clarity
  - pre-ingestion check
  - cgd verify
  - sot verify
capabilities:
  - document-verification
  - epistemic-quality
  - rag-preparation
  - cgd-generation
  - sot-validation
outputs:
  - type: cgd
    extension: .cgd.md
    spec: docs/CLARITY_GATE_FORMAT_SPEC.md
spec_version: "2.1"
---
# Clarity Gate v2.1

**用途：** 在文档进入RAG知识库之前，该系统会执行预处理验证，以确保其认知质量符合标准。生成的文档将遵循Clarity Gate格式规范v2.1。

**核心问题：** “如果另一个大型语言模型（LLM）阅读这些文档，它是否会将假设误认为是事实？”

**核心原则：** “检测现有的内容；确保内容符合认知要求。实际操作中：在假设变成错误认知之前，找到缺失的不确定性标记。”

---

## v2.1的新功能

| 功能 | 描述 |
|---------|-------------|
| **声明完成状态** | 通过字段的存在来确定“待处理”/“已验证”（没有明确的状态字段） |
| **来源字段语义** | 可操作的来源信息（待处理）与实际找到的内容（已验证） |
| **声明ID格式指南** | 建议使用基于哈希的ID，以减少冲突 |
| **正文结构要求** | 当存在声明时，必须包含HITL验证记录部分 |
| **新的验证代码** | E-ST10、W-ST11、W-HC01、W-HC02、E-SC06（FORMAT_SPEC）；E-TB01-07（SOT验证） |
| **捆绑脚本** | `claim_id.py` 和 `document_hash.py` 用于确定性计算 |

---

## 规范说明

本技能实现并参考了以下规范：

| 规范 | 版本 | 位置 |
|---------------|---------|----------|
| Clarity Gate格式（统一规范） | v2.1 | [docs/CLARITY_GATE_FORMAT_SPEC.md](../../docs/CLARITY_GATE_FORMAT_SPEC.md) |

**注意：** v2.0将CGD和SOT统一为`.cgd.md`格式。SOT现在是一个包含`tier:`块的CGD。 |

---

## 验证代码

Clarity Gate根据FORMAT_SPEC v2.1定义了以下验证代码：

### HITL声明验证（§1.3.2-1.3.3）
| 代码 | 验证内容 | 严重程度 |
|------|-------|----------|
| **W-HC01** | `confirmed-by`/`confirmed-date`字段缺失 | 警告 |
| **W-HC02** | 来源信息模糊（例如，“行业报告”、“待定”） | 警告 |
| **E-SC06** | `hitl-claims`结构中的模式错误 | 错误 |

### 正文结构（§1.2.1）
| 代码 | 验证内容 | 严重程度 |
|------|-------|----------|
| **E-ST10** | 当存在声明时，缺少`## HITL验证记录` | 错误 |
| **W-ST11** | 表格行与`hitl-claims`的数量不匹配 | 警告 |

### SOT表格验证（§3.1）
| 代码 | 验证内容 | 严重程度 |
|------|-------|----------|
| **E-TB01** | 没有`## Verified Claims`部分 | 错误 |
| **E-TB02** | 表格中没有数据行 | 错误 |
| **E-TB03** | 必需的列缺失 | 错误 |
| **E-TB04** | 列顺序错误 | 错误 |
| **E-TB05** | 必需列中的单元格为空 | 错误 |
| **E-TB06** | 验证日期格式无效 | 错误 |
| **E-TB07** | 验证日期在未来（超过24小时的有效期） | 错误 |

**注意：** RFC-001（澄清文档）中可能定义了额外的验证代码，但它们不属于规范的一部分。 |

---

## 捆绑脚本

本技能包含根据FORMAT_SPEC进行确定性计算的Python脚本。

### scripts/claim_id.py

根据§1.3.4计算稳定的、基于哈希的声明ID，用于HITL跟踪。

---

**算法：**
1. 对文本进行规范化处理（去除多余空白字符）
2. 使用管道分隔符将文本与位置信息连接起来
3. 对连接后的文本进行SHA-256哈希运算，取前8个十六进制字符
4. 在前面加上“claim-”前缀

**测试示例：**
- `claim_id("Base price is $99/mo", "api-pricing/1")` → `claim-75fb137a`
- `claim_id("The API supports GraphQL", "features/1")` → `claim-eb357742`

### scripts/document_hash.py

根据FORMAT_SPEC §2.2-2.4计算文档的SHA-256哈希值，同时进行完整的规范化处理。

---

**算法（根据§2.2-2.4）：**
1. 提取从`---\n`到`<!-- CLARITY_GATE_END -->`之间的内容
2. 仅从YAML头部文件中删除`document-sha256`这一行（支持多行续写）
3. 进行规范化处理：
   - 删除每行末尾的空白字符
   - 将连续的3个或更多换行符合并为1个
   - 确保最后一个换行符是标准的LF格式
   - 使用UTF-8 NFC编码进行规范化
4. 计算哈希值

**跨平台规范化处理：**
- 如果存在BOM（文件开头标记），则将其删除
- 将Windows系统的CRLF转换为LF
- 将Mac系统的CR转换为LF
- 确保哈希计算仅针对CGD结构内的内容
- 不同平台的空白字符处理方式相同，以确保哈希值的一致性

---

## 关键区别

现有的工具（如UnScientify和HedgeHunter（CoNLL-2010）**检测**文本中已存在的不确定性标记（“文本中是否表达了不确定性？”）。

Clarity Gate则**强制**在需要表达不确定性的地方添加这些标记（“是否应该表达不确定性，但实际上没有表达？”）。

| 工具类型 | 功能 | 例子 |
|-----------|----------|---------|
| **检测** | “文本中是否包含模糊表述？” | UnScientify/HedgeHunter会检测到“可能”、“也许”等词 |
| **强制** | “这个声明是否应该被标记为不确定，但实际上没有？” | Clarity Gate会标记“收入预计为5000万美元” |

---

## 重要限制

> **Clarity Gate验证的是格式，而非事实。**
>
> 该工具仅检查声明是否被正确标记为不确定——它无法验证声明是否真实。
>
> **风险：** 大型语言模型可能会在文档中“虚构”事实，然后通过添加来源标记来“通过”Clarity Gate的验证。
>
> **解决方案：** 在宣布文档通过之前，必须进行HITL（人工审核）验证。

---

## 使用场景

- 在将文档导入RAG系统之前
- 在与其他AI系统共享文档之前
- 在编写规范、状态文档或方法描述之后
- 当文档包含预测、估计或假设时
- 在发布未经验证的声明之前
- 在不同的大型语言模型会话之间传递文档之前

---

## 9个验证要点

### 与规范套件的关系

这9个验证要点指导**语义审查**——需要判断的内容质量检查（无论是人工还是AI完成）。它们回答诸如“这个声明是否应该被标记为不确定？”以及“这些数字是否一致？”之类的问题。

审查完成后，将生成符合[CLARITY_GATE_FORMAT_SPEC.md](../../docs/CLARITY_GATE_FORMAT_SPEC.md)格式的CGD文件。[CLARITY_GATE_FORMAT_SPEC.md](../../docs/CLARITY_GATE_FORMAT_SPEC.md)中的C/S规则验证的是**文件结构**，而非语义内容。

**关联说明：**
1. 语义发现（9个要点）确定存在的问题
2. 问题会被记录在CGD的状态字段中（`clarity-status`、`hitl-status`、`hitl-pending-count`）
3. 通过结构规则（C7-C10）确保状态的一致性

*示例：* 如果第5点（数据一致性）发现数字冲突，你会将`clarity-status`标记为`UNCLEAR`，直到问题得到解决。然后规则C7会确保你不能在`UNCLEAR`的状态下标记文档为`REVIEWED`。*

---

### 认知检查（核心关注点：1-4）

**1. 声明与事实的区分**
每个声明都必须明确标记为已验证或假设性内容。

| 失败 | 通过 |
|-------|--------|
| “我们的架构优于竞争对手” | “我们的架构优于表3中的基准数据” |
| “模型提升了40%的性能” | “模型在数据集X上的性能提升了40%” |

**修复方法：** 添加标记：“PROJECTED:”、“HYPOTHESIS:”、“UNTESTED:”、“(estimated)”、“~”、“?” |

**2. 不确定性标记的强制使用**
前瞻性声明需要使用明确的限定词。

| 失败 | 通过 |
|-------|--------|
| “收入预计在第四季度达到5000万美元” | “收入**预计**在第四季度达到5000万美元” |
| “该功能将减少客户流失” | “该功能**预期**会减少客户流失” |

**修复方法：** 添加“projected”、“estimated”、“expected”、“designed to”、“intended to”等限定词”

**3. 隐含假设的可见性**
影响解释的隐含假设必须明确标注。

| 失败 | 通过 |
|-------|--------|
| “系统具有线性扩展能力” | “系统具有线性扩展能力[假设并发用户数少于1000]” |
| “响应时间为50毫秒” | “响应时间为50毫秒[在标准负载条件下]” |

**修复方法：** 添加括号中的条件：“[假设X]”、“[在条件Y下]”、“[当Z时]”

**4. 表示权威性的未经验证的数据**
包含具体百分比和勾选的表格看起来像是经过测量得出的数据。

**警告：** 包含具体数字（如89%、95%、100%）且没有来源信息的表格**

**修复方法：** 在数字后添加“(guess)”、“(est.)”、“?”等字样，并添加明确警告：“这些是**预测值**，并非实际测量结果” |

### 数据质量检查（补充内容：5-7）

**5. 数据一致性**
检查文档中是否存在冲突的数字、日期或事实。

**警告：** 一个部分写着“500个用户”，另一个部分写着“750个用户”

**修复方法：** 解决冲突或明确说明差异并给出解释。**

**6. 隐含的因果关系**
没有证据支持的声明中隐含因果关系。

**警告：** 如“更短的提示能提高响应质量”这样的表述（虽然合理，但未经验证）

**修复方法：** 将其重新表述为假设：“更短的提示**可能**能提高响应质量（这只是假设，尚未验证）”

**7. 将未来状态描述为现状**
将计划中的/期望的结果描述得好像已经实现了一样。

**警告：** 如“系统每秒能处理10,000个请求”（而实际上尚未实现）

**修复方法：** 使用未来/条件性表述：“系统**设计为**能够处理……”或“目标处理能力为……”**

### 验证流程（8-9点）

**8. 时间一致性**
文档的日期和时间戳必须在内部一致且合理。

| 失败 | 通过 |
|-------|--------|
| “最后更新时间：2024年12月”（而实际是2026年） | “最后更新时间：2026年1月” |
| 版本号如v1.0.0标注为2024-12-23，v1.1.0标注为2024-12-20” | 版本号应按时间顺序排列 |

**子检查：**
1. 文档日期与当前日期是否一致
2. 版本号的顺序是否正确（版本、事件的顺序）
3. 参考信息的时效性（如“当前”、“现在”、“今天”等表述）

**修复方法：** 更新日期，添加“截至[日期]”等限定词，并标记过时的文档**

**9. 可外部验证的声明**
可以验证的具体数字应被标记出来以便进一步核实。

| 类型 | 例子 | 风险 |
|------|---------|------|
| 价格信息 | “每次调用成本约为0.005美元” | 需要验证API的价格信息 |
| 统计数据 | “论文中平均包含15-30个公式” | 这些数据可能严重不准确 |
| 比率/比例 | “40%的研究人员使用X” | 需要引用来源 |
| 竞争对手的声明 | “没有竞争对手提供Y” | 这些声明可能已经过时 |

**修复方法：**
1. 添加带有日期的来源信息
2. 添加不确定性标记
3. 将相关内容路由到HITL或外部验证系统
4. 使用通用表述（如“低成本”而不是“$0.005”）

---

## 验证层级

---

### 第1层：自动化验证

**A. 内部一致性**
- 图表与文本之间的矛盾
- 摘要与正文的不一致
- 表格数据与文字描述之间的冲突
- 数字数据的一致性

**B. 外部验证（扩展接口）**
- 用户提供的链接指向结构化的数据源
- 财务系统、Git提交记录、CRM系统等

### 第2层：两轮HITL验证（强制要求）

**第A轮：派生数据确认**
- 来自会话中的声明
- 由人工确认其解释内容，而非事实本身

**第B轮：真实HITL验证**
- 需要实际验证的声明
- 如果找不到来源信息，则使用人工提供的数据或进行推断

---

## CGD输出格式

生成Clarity-Gated Document时，应使用[CLARITY_GATE_FORMAT_SPEC.md](../../docs/CLARITY/Gate_FORMAT_SPEC.md) v2.1中的格式：

---

**CGD所需的元素：**
- YAML头部文件，包含所有必需的字段：
  - `clarity-gate-version` — 工具版本（不带“v”前缀）
  - `processed-date` — 年月日格式
  - `processed-by` — 处理者名称
  - `clarity-status` — CLEAR或UNCLEAR
  - `hitl-status` — PENDING、REVIEWED或REVIEWED_WITH_EXCEPTIONS
  - `hitl-pending-count` — 整数，大于或等于0
  - `points-passed` — 例如1-9或1-4,7,9
  - `hitl-claims` — 已验证的声明列表（可能为空`[]`）
- 结尾标记（HTML注释+状态行）：
  ```
  <!-- CLARITY_GATE_END -->
  Clarity Gate: <clarity-status> | <hitl-status>
  ```
- 如果状态为REVIEWED，则包含HITL验证记录

**可选/计算字段：**
- `rag-ingestable` — 由验证工具计算得出，不是手动设置的。仅在`CLEAR | REVIEWED`且没有排除块时显示`true`。
- `document-sha256` — 必需字段，64个字符的小写十六进制哈希值，用于完整性验证。具体计算规则见规范§2。
- `exclusions-coverage` — 可选字段，表示排除块内的内容占比（0.0–1.0）。

**注意事项：** 要在引用如`*(estimated)*`这样的标记时，需要使用反引号将其括起来：`` `*(estimated)*` ``

### 声明完成状态（v2.1）

声明的验证状态是通过字段**是否存在**来确定的，而不是通过一个明确的状态字段：

| 状态 | `confirmed-by` | `confirmed-date` | 含义 |
|-------|----------------|------------------|----------|
| **PENDING** | 未提供 | 未提供 | 正在等待人工验证 |
| **VERIFIED** | 提供了 | 提供了 | 人工已经确认 |
| *(invalid)* | 提供了 | 未提供 | W-HC01：部分字段缺失 |
| *(invalid)* | 提供了 | 提供了 | W-HC01：部分字段缺失 |

**为什么没有明确的状态字段？** 因为字段的存在本身就说明了状态——你无法在未提供执行者和时间信息的情况下错误地设置状态。

### 来源字段语义（v2.1）

`source`字段的含义根据声明的状态而变化：

| 状态 | `source`字段应包含的内容 | 例子 |
|-------|-------------------|----------|
| **PENDING** | 需要验证的信息来源（可操作） | “查看Q3规划文档” |
| **VERIFIED** | 找到的证据内容 | “Q3规划文档，第12页” |

**来源信息模糊（W-HC02）：** 如“行业报告”、“研究”、“待定”等来源会触发警告。**

### 声明ID格式（v2.1）

**通用格式：** `claim-[a-z0-9._-]{1,64}`（字母数字、点、下划线）

| 方法 | 格式 | 例子 | 使用场景 |
|----------|---------|---------|----------|
| **基于哈希的**（推荐） | `claim-[a-f0-9]{8,}` | `claim-75fb137a` | 确定性高，抗冲突 |
| **顺序式的** | `claim-[0-9]+` | `claim-1`、`claim-2` | 简单文档 |
| **语义化的** | `claim-[a-z0-9-]+` | `claim-revenue-q3` | 便于人类阅读 |

**冲突概率：** 当有1,000个声明时，使用8位十六进制ID的冲突概率约为0.012%。当声明数量超过1,000个时，使用12位以上的十六进制字符。**

**建议：** 使用`scripts/claim_id.py`生成的基于哈希的ID，以确保一致性和抗冲突性。**

---

## 排除块

当内容无法解决（例如没有专家可咨询、内容为过时的文本等）时，应将其标记为排除内容，而不是保持模糊状态：

---

**规则：**
- ID必须符合格式 `[A-Za-z0-9][A-Za-z0-9._-]{0,63}` |
- 不允许嵌套或重复的ID
- 每个ID只能使用一次
- 必须设置`hitl-status: REVIEWED_WITH_EXCEPTIONS`
- 必须在头部文件中记录`exceptions-reason`和`exceptions-ids`

**重要提示：** 包含排除块的文档**无法被RAG系统接收。这些文档将被完全拒绝（不会被部分导入）。

详细规则请参阅[CLARITY_GATE_FORMAT_SPEC.md §4](../../docs/CLARITY_GATE_FORMAT_SPEC.md)。

---

## SOT验证

在验证Source of Truth文件时，该工具会检查**格式是否符合规范**（[CLARITY_GATE_FORMAT_SPEC.md](../../docs/CLARITY_GATE_FORMAT_SPEC.md)）以及**内容质量**（上述9个验证要点）。

### 格式符合性（结构规则）

SOT文档是包含`tier:`块的CGD。它们需要一个`## Verified Claims`部分，并且该部分必须包含一个有效的表格。

| 代码 | 验证内容 | 严重程度 |
|------|-------|----------|
| E-TB01 | 没有`## Verified Claims`部分 | 错误 |
| E-TB02 | 表格中没有数据行 | 错误 |
| E-TB03 | 必需的列缺失（Claim、Value、Source、Verified） | 错误 |
| E-TB04 | 列顺序错误（Claim不是第一个字段，Verified不是最后一个字段） | 错误 |
| E-TB05 | 必需的列中的单元格为空 | 错误 |
| E-TB06 | 验证日期格式无效 | 错误 |
| E-TB07 | 验证日期在未来（超过24小时的有效期） | 错误 |

### 内容质量（9个验证要点）

这9个验证要点也适用于SOT内容：

| 点数 | SOT文档的应用场景 |
|-------|-----------------|
| 1-4 | 检查`## Verified Claims`中的声明是否确实经过验证 |
| 5 | 检查表格中的数值是否一致 |
| 6 | 检查声明是否暗示了不成立的因果关系 |
| 7 | 检查表格中是否将未来情况描述为当前事实 |
| 8 | 检查日期是否按时间顺序排列 |
| 9 | 标记需要外部验证的具体数字 |

### SOT特有的要求

- **必须包含tier块：** SOT文档是一个包含`tier:`块的CGD，其中包含`level`、`owner`、`version`、`promoted-date`、`promoted-by`等字段 |
- **结构化的声明表格：** `## Verified Claims`部分应包含Claim、Value、Source、Verified等列 |
- **排除块外的表格：** 已验证的声明表格不能位于排除块内 |
- **时效性标记：** 在内容中使用`[STABLE]`、`[CHECK]`、`[VOLATILE]`、`[SNAPSHOT]`等标记
  - `[STABLE]` — 可安全引用，无需重新验证 |
  - `[CHECK]` — 引用前需要验证 |
  - `[VOLATILE]` — 数据容易变化；引用前必须验证 |
  - `[SNAPSHOT]` — 表示数据是即时数据；引用时需注明日期 |

---

## 输出格式

运行Clarity Gate后，输出结果如下：

---

## 严重程度等级

| 等级 | 定义 | 处理方式 |
|-------|------------|--------|
| **CRITICAL** | 大型语言模型可能会将假设当作事实处理 | 需要在使用前修复 |
| **WARNING** | 大型语言模型可能会误解内容 | 需要修复 |
| **TEMPORAL** | 发现日期/时间不一致 | 需要验证并更新 |
| **VERIFIABLE** | 可以验证的具体声明 | 需要路由到HITL或外部验证系统 |
| **ROUND A** | 来自可信赖来源的声明 | 需要快速确认 |
| **ROUND B** | 需要实际验证的声明 | 未经验证无法通过 |
| **PASS** | 标记清晰，没有歧义，已验证 | 无需额外处理 |

---

## 快速检查清单

| 规则内容 | 处理方式 |
|---------|--------|
| 具体的百分比（如89%、73%） | 添加来源信息或标记为估计值 |
| 对比表格 | 添加“PROJECTED”标题 |
| 使用“ achieves”、“delivers”、“provides”等词时 | 如果未经过验证，应使用“designed to”、“intended to”等词 |
| 带有勾选的数字 | 需要验证这些数字是否确实成立 |
| “Last Updated: [日期]” | 需要与当前日期对比 |
| 带有日期的版本号 | 需要验证版本号的顺序 |
| “$X.XX”或“~$X”（价格信息） | 需要标记为外部验证内容 |
| “averages”, “typically”等表述 | 需要注明来源或提供引用 |
| 竞争对手的能力声明 | 需要标记为外部验证内容 |

---

## 本技能不执行的功能

- 不对文档类型进行分类（这部分由Stream Coding负责）
- 不会重新构建文档结构
- 不会添加深层链接或引用
- 不会评估文档的写作质量
- **不会自动验证事实的准确性**（这需要人工审核）

---

## 相关项目

| 项目 | 功能 | 链接 |
|---------|---------|-----|
| Source of Truth Creator | 创建经过认知校准的文档 | github.com/frmoretto/source-of-truth-creator |
| Stream Coding | 以文档为中心的验证方法 | github.com/frmoretto/stream-coding |
| ArXiParse | 科学论文的验证工具 | arxiparse.org |

---

## 更新记录

### v2.1.0 (2026-01-27)
- **新增：** 根据字段的存在来确定声明完成状态（PENDING/VERIFIED）
- **新增：** 来源字段的语义说明（可操作的来源信息与实际找到的内容）
- **新增：** 声明ID格式指南及冲突检测功能 |
- **新增：** 正文结构要求（当存在声明时，必须包含HITL验证记录）
- **新增：** 新的验证代码：E-ST10、W-ST11、W-HC01、W-HC02、E-SC06（FORMAT_SPEC §1.2-1.3） |
- **新增：** 捆绑脚本：`claim_id.py`、`document_hash.py` |
- **更新：** 引用了FORMAT_SPEC v2.1版本 |
- **更新：** CGD输出格式示例，符合v2.1版本 |

### v2.0.0 (2026-01-13)
- **新增：** 兼容agentskills.io的YAML头部格式 |
- **新增：** 符合Clarity Gate格式规范v2.0（统一CGD/SOT格式） |
- **新增：** SOT验证支持及E-TB*错误代码 |
- **新增：** 验证规则与规则代码的对应关系 |
- **新增：** CGD输出格式模板，包含`<!-- CLARITY_GATE_END -->`标记 |
- **新增：** Quine Protection标记检测功能（§2.3） |
- **新增：** 修订了导出功能（§8.11） |
- **更新：** `hitl-claims`格式，符合v2.0规范（包含id、text、value、source、location、round） |
- **更新：** 结尾标记格式，采用HTML注释形式 |
- **更新：** 统一格式规范，使用`.cgd.md`扩展名 |
- **重新组织：** 以便在不同平台上使用 |

### v1.6 (2025-12-31)
- 添加了两轮HITL验证系统
  - 第A轮：派生数据确认
  - 第B轮：真实HITL验证

### v1.5 (2025-12-28)
- 添加了时间一致性检查（第8点）
- 添加了可外部验证的声明（第9点）

### v1.4 (2025-12-23)
- 添加了CGD注释输出功能

### v1.3 (2025-12-21)
- 将验证规则重新分为认知检查（1-4点）和数据质量检查（5-7点）

### v1.2 (2025-12-21)
- 添加了请求Source of Truth的步骤

### v1.1 (2025-12-21)
- 引入了HITL事实验证功能（强制要求）

---

**版本：** 2.1.2
**规范版本：** 2.1
**作者：** Francesco Marinoni Moretto
**许可证：** CC-BY-4.0