---
name: cron-worker-guardrails
slug: cron-worker-guardrails
version: 1.0.1
license: MIT
description: >
  **使用说明：**  
  在强化 OpenClaw 的 cron 工作进程（尤其是隔离代理任务）时，本指南用于防范引号错误、脆弱的 shell 脚本执行方式、SIGPIPE 信号导致的错误，以及工作目录（cwd）和环境变量（env）的异常变化。  
  **输出内容：**  
  - 一份以脚本为核心的强化检查清单；  
  - 一套可复用的、适用于多种场景的防护模式（portable patterns）。
metadata:
  openclaw:
    emoji: "🧯"
---
# Cron 工作程序防护措施

这是一份以可靠性为首要目标的检查清单，适用于 **OpenClaw 的 cron 工作程序**（尤其是那些设置了 `sessionTarget="isolated"` 和 `payload.kind="agentTurn"` 的任务），以及所有无人值守运行的自动化脚本。

## 为什么需要这些防护措施？
Cron 任务的失败很少是由于逻辑错误引起的。常见的原因包括：
- 脆弱的 shell 引用语法（例如：`bash -lc '...'` 中的嵌套引号问题）
- 命令替换操作导致的意外结果（例如：`$(...)` 的使用）
- 工作目录（`cwd`）环境变量的不一致（在本地可以正常运行，但在 cron 任务中却出错）
- 管道操作（`pipe` 命令）因错误原因而失败（例如：`pipefail` 或 `head` 命令引发 SIGPIPE 信号）

解决方法虽然简单，但非常有效：**优先使用脚本执行，并确保命令的执行具有确定性；成功执行时不要输出任何提示信息**。

## 快速入门
如果你的 cron 任务涉及的代码变得复杂或容易出错，可以按照以下步骤进行优化：
1. 将所有逻辑代码放入一个脚本中（推荐存放位置：目标仓库的 `tools/` 目录下）。
2. 通过 cron 任务仅执行一个简短的命令。
3. 脚本在成功执行后输出 “NO_REPLY” 作为提示。

如果你希望为 cron 工作程序制定一个通用的标准规范，可以参考随该文档提供的文件：`references/cron-agent-contract.md`。

另请参阅：`references/pitfalls.md`

## 可移植性规则（非常重要）
**切勿** 将与特定机器相关的绝对路径硬编码到脚本中**。因为用户可能在不同操作系统（Linux、macOS、Windows）或不同的目录结构（包括容器环境）下安装 OpenClaw。建议使用以下方法：
- 使用相对于仓库位置的路径。
- 通过环境变量来指定路径。
- 使用简单的脚本来切换到仓库目录。

## 默认的可靠性原则：
- 相比多行的 `bash -lc '...'` 语句，优先使用独立的脚本。
- 每个 cron 任务只执行一个命令。
- 明确指定脚本的解释器（如 `python3`、`node` 等），避免使用含义模糊的替代工具。
- 成功执行时不要输出任何提示信息（即输出 “NO_REPLY”）。

## 常见问题及其解决方法：

### 1) 在查找匹配的 `)` 标签时出现 “unexpected EOF” 错误
**可能的原因**：
- 命令替换操作中的 `$(...)` 语句没有正确闭合。
- `bash -lc '...'` 中的嵌套引号有误。

**解决方法**：
- 将整个多行 shell 代码块替换为一个独立的脚本。
- 通过 cron 任务仅执行一个简短的命令，例如：`python3 tools/<job>.py`。

### 2) 由于 `pipefail` 或 `head` 命令引发错误（SIGPIPE 信号）
**症状**：
- 命令执行后返回非零状态码，但实际上输出内容是正常的。

**解决方法**：
- 在使用 `pipe` 命令时避免使用 `pipefail`。
- 或者更好的方法是：在脚本中完成数据过滤操作，只读取所需的数据。

### 3) 在本地可以正常运行，但在 cron 任务中失败
**常见原因**：
- 工作目录设置不正确。
- 缺少必要的环境变量。
- 系统的 `PATH` 变量不同。

**解决方法**：
- 使用 `cd` 命令切换到仓库目录（或者让脚本自动完成目录切换）。
- 确保所有依赖项都明确列出并记录在文档中。

## 可移植性的通用防护措施
在 cron 任务的脚本开头添加以下两行代码，以提高安全性：
**必须遵循的防护措施**：参照 `references/cron-agent-contract.md` 中的建议（优先使用脚本执行，确保工作目录环境的一致性，成功执行时不要输出提示信息）。
**同时应用 `cron-worker-guardrails` 这一防护措施**。如果需要复杂的解析或多步骤逻辑处理，可以编写一个 `tools/*.py` 脚本来实现。